This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.env.example
.gitignore
app/(auth)/login/page.tsx
app/(auth)/signup/page.tsx
app/api/export/review/route.ts
app/api/export/route.ts
app/api/export/viability/route.ts
app/api/projects/[projectId]/chat/route.ts
app/api/projects/[projectId]/check-eligibility/route.ts
app/api/projects/[projectId]/generate-sections/route.ts
app/api/projects/[projectId]/review/route.ts
app/auth/callback/route.ts
app/dashboard/clients/[id]/page.tsx
app/dashboard/clients/new/page.tsx
app/dashboard/clients/page.tsx
app/dashboard/history/page.tsx
app/dashboard/layout.tsx
app/dashboard/page.tsx
app/dashboard/projects/[id]/export/page.tsx
app/dashboard/projects/[id]/page.tsx
app/dashboard/projects/new/page.tsx
app/dashboard/projects/page.tsx
app/globals.css
app/layout.tsx
app/page.tsx
components/export/ExportView.tsx
components/project/AnalisisViabilidadIA.tsx
components/project/CargarBasesConvocatoria.tsx
components/project/ClientSelector.tsx
components/project/MasterChatIA.tsx
components/project/ProjectReview.tsx
components/project/SeccionesMemoria.tsx
components/ui/sidebar.tsx
docs/COMPARATIVA-SQL-Y-ESTRUCTURA.md
docs/EXTRUCTURA.md
docs/PRODUCCION.md
lib/export/docx.ts
lib/export/pdf.ts
lib/pdf-extract.ts
lib/supabase/client.ts
lib/supabase/server.ts
lib/types.ts
lib/utils.ts
middleware.ts
next.config.ts
package.json
postcss.config.mjs
README.md
scripts/extract-pdf-text.cjs
supabase/.temp/cli-latest
supabase/.temp/gotrue-version
supabase/.temp/pooler-url
supabase/.temp/postgres-version
supabase/.temp/project-ref
supabase/.temp/rest-version
supabase/.temp/storage-migration
supabase/.temp/storage-version
supabase/functions/_shared/auth.ts
supabase/functions/_shared/cors.ts
supabase/functions/ai-chat/index.ts
supabase/functions/ai-embed/index.ts
supabase/functions/deno.d.ts
supabase/migrations/001_initial_schema.sql
supabase/migrations/002_pgvector_embeddings.sql
supabase/migrations/003_storage_convocatoria.sql
supabase/migrations/004_clients_management.sql
supabase/migrations/005_clients_soft_delete.sql
supabase/migrations/006_projects_archiving.sql
supabase/migrations/007_chat_per_section.sql
supabase/migrations/008_audit_persistence.sql
supabase/migrations/009_client_sequentials.sql
tailwind.config.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".env.example">
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# IA (Etapa 3)
OPENAI_API_KEY=
ANTHROPIC_API_KEY=
</file>

<file path=".gitignore">
# Dependencies
node_modules
.pnp
.pnp.js

# Build
.next
out
build
dist

# Env
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# Debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# IDE
.idea
.vscode
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Vercel
.vercel

# TypeScript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="app/(auth)/login/page.tsx">
"use client";

import { useState, Suspense, useEffect } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { Zap } from "lucide-react";
import { createClient } from "@/lib/supabase/client";
import * as Label from "@radix-ui/react-label";
import { cn } from "@/lib/utils";

function LoginForm() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();
  const searchParams = useSearchParams();
  const redirect = searchParams.get("redirect") ?? "/dashboard";

  useEffect(() => {
    const err = searchParams.get("error");
    if (err) setError(decodeURIComponent(err));
  }, [searchParams]);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError(null);
    setLoading(true);
    const supabase = createClient();
    const { error: err } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    setLoading(false);
    if (err) {
      setError(err.message);
      return;
    }
    router.push(redirect);
    router.refresh();
  }

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-[#F8FAFC] px-4">
      <Link
        href="/"
        className="absolute top-8 left-8 flex items-center gap-2 text-slate-500 hover:text-slate-900 font-bold text-sm"
      >
        <Zap size={20} className="text-blue-600" />
        Begitality
      </Link>
      <div className="w-full max-w-sm">
        <div className="text-center mb-8">
          <h1 className="text-2xl font-black text-slate-900 tracking-tighter">
            Iniciar sesión
          </h1>
          <p className="text-slate-500 text-sm mt-1">
            Accede a tu espacio de subvenciones
          </p>
        </div>
        <form
          onSubmit={handleSubmit}
          className="bg-white border border-slate-200 rounded-3xl p-8 shadow-sm space-y-5"
        >
          {error && (
            <div className="p-3 rounded-xl bg-red-50 border border-red-100 text-red-700 text-sm">
              {error}
            </div>
          )}
          <div className="space-y-2">
            <Label.Root
              htmlFor="email"
              className="text-sm font-bold text-slate-700"
            >
              Email
            </Label.Root>
            <input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className={cn(
                "w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50/50",
                "focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
              )}
              placeholder="tu@email.com"
            />
          </div>
          <div className="space-y-2">
            <Label.Root
              htmlFor="password"
              className="text-sm font-bold text-slate-700"
            >
              Contraseña
            </Label.Root>
            <input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              className={cn(
                "w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50/50",
                "focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
              )}
              placeholder="••••••••"
            />
          </div>
          <button
            type="submit"
            disabled={loading}
            className="w-full py-3.5 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-500 disabled:opacity-60 transition-all"
          >
            {loading ? "Entrando…" : "Entrar"}
          </button>
        </form>
        <p className="text-center text-slate-500 text-sm mt-6">
          ¿No tienes cuenta?{" "}
          <Link href="/signup" className="font-bold text-blue-600 hover:underline">
            Regístrate
          </Link>
        </p>
      </div>
    </div>
  );
}

export default function LoginPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center bg-[#F8FAFC]">
        <div className="animate-pulse text-slate-400">Cargando…</div>
      </div>
    }>
      <LoginForm />
    </Suspense>
  );
}
</file>

<file path="app/(auth)/signup/page.tsx">
"use client";

import { useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { Zap } from "lucide-react";
import { createClient } from "@/lib/supabase/client";
import * as Label from "@radix-ui/react-label";
import { cn } from "@/lib/utils";

export default function SignupPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [fullName, setFullName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);
  const router = useRouter();

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError(null);
    setLoading(true);
    const supabase = createClient();
    const { error: err } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: { full_name: fullName },
        emailRedirectTo: `${typeof window !== "undefined" ? window.location.origin : ""}/auth/callback`,
      },
    });
    setLoading(false);
    if (err) {
      setError(err.message);
      return;
    }
    setSuccess(true);
    setTimeout(() => router.push("/dashboard"), 2000);
    router.refresh();
  }

  if (success) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-[#F8FAFC] px-4">
        <div className="bg-white border border-slate-200 rounded-3xl p-8 max-w-sm text-center">
          <div className="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center mx-auto mb-4 text-2xl">
            ✓
          </div>
          <h2 className="text-xl font-bold text-slate-900">Cuenta creada</h2>
          <p className="text-slate-500 text-sm mt-2">
            Revisa tu email para confirmar. Redirigiendo al panel…
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-[#F8FAFC] px-4">
      <Link
        href="/"
        className="absolute top-8 left-8 flex items-center gap-2 text-slate-500 hover:text-slate-900 font-bold text-sm"
      >
        <Zap size={20} className="text-blue-600" />
        Begitality
      </Link>
      <div className="w-full max-w-sm">
        <div className="text-center mb-8">
          <h1 className="text-2xl font-black text-slate-900 tracking-tighter">
            Crear cuenta
          </h1>
          <p className="text-slate-500 text-sm mt-1">
            Empieza a gestionar tus subvenciones con IA
          </p>
        </div>
        <form
          onSubmit={handleSubmit}
          className="bg-white border border-slate-200 rounded-3xl p-8 shadow-sm space-y-5"
        >
          {error && (
            <div className="p-3 rounded-xl bg-red-50 border border-red-100 text-red-700 text-sm">
              {error}
            </div>
          )}
          <div className="space-y-2">
            <Label.Root
              htmlFor="fullName"
              className="text-sm font-bold text-slate-700"
            >
              Nombre
            </Label.Root>
            <input
              id="fullName"
              type="text"
              value={fullName}
              onChange={(e) => setFullName(e.target.value)}
              className={cn(
                "w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50/50",
                "focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
              )}
              placeholder="Tu nombre"
            />
          </div>
          <div className="space-y-2">
            <Label.Root
              htmlFor="email"
              className="text-sm font-bold text-slate-700"
            >
              Email
            </Label.Root>
            <input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className={cn(
                "w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50/50",
                "focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
              )}
              placeholder="tu@email.com"
            />
          </div>
          <div className="space-y-2">
            <Label.Root
              htmlFor="password"
              className="text-sm font-bold text-slate-700"
            >
              Contraseña
            </Label.Root>
            <input
              id="password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              minLength={6}
              className={cn(
                "w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50/50",
                "focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
              )}
              placeholder="Mínimo 6 caracteres"
            />
          </div>
          <button
            type="submit"
            disabled={loading}
            className="w-full py-3.5 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-500 disabled:opacity-60 transition-all"
          >
            {loading ? "Creando cuenta…" : "Registrarse"}
          </button>
        </form>
        <p className="text-center text-slate-500 text-sm mt-6">
          ¿Ya tienes cuenta?{" "}
          <Link href="/login" className="font-bold text-blue-600 hover:underline">
            Iniciar sesión
          </Link>
        </p>
      </div>
    </div>
  );
}
</file>

<file path="app/api/export/review/route.ts">
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { generateReviewReport } from "@/lib/export/pdf";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

export async function POST(req: Request) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { projectId } = await req.json();
  const { data: project } = await supabase.from("projects").select("*, clients(*)").eq("id", projectId).single();

  if (!project || !project.review_report) return NextResponse.json({ error: "No audit data" }, { status: 404 });

  const auditData = JSON.parse(project.review_report);

  const buffer = await generateReviewReport({
    title: project.name,
    clientName: project.clients?.name || "Empresa Cliente",
    ...auditData
  });

  return new NextResponse(new Uint8Array(buffer), {
    status: 200,
    headers: {
      "Content-Type": "application/pdf",
      "Content-Disposition": `attachment; filename="Auditoria_${project.name.replace(/\s+/g, "_")}.pdf"`,
    },
  });
}
</file>

<file path="app/api/export/viability/route.ts">
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { generateViabilityCertificate } from "@/lib/export/pdf";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

export async function POST(req: Request) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { projectId } = await req.json();
  if (!projectId) return NextResponse.json({ error: "ProjectId required" }, { status: 400 });

  // Obtener datos del proyecto y reporte guardado
  const { data: project } = await supabase
    .from("projects")
    .select("*, clients(*)")
    .eq("id", projectId)
    .single();

  if (!project || !project.viability_report) {
    return NextResponse.json({ error: "Reporte no encontrado" }, { status: 404 });
  }

  const viabilityData = JSON.parse(project.viability_report);

  const buffer = await generateViabilityCertificate({
    title: project.name,
    clientName: project.clients?.name || "Sin Nombre",
    grantName: project.grant_name,
    ...viabilityData
  });

  const filename = `Certificado_Viabilidad_${project.name.replace(/\s+/g, "_")}.pdf`;

  return new NextResponse(new Uint8Array(buffer), {
    status: 200,
    headers: {
      "Content-Type": "application/pdf",
      "Content-Disposition": `attachment; filename="${filename}"`,
    },
  });
}
</file>

<file path="app/api/projects/[projectId]/chat/route.ts">
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { extractTextFromPdf } from "@/lib/pdf-extract";
import { GoogleGenerativeAI } from "@google/generative-ai";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";
const BUCKET = "convocatoria-files";
const MAX_CONTEXT_TEXT = 20000;

export async function POST(
  req: Request,
  context: { params: Promise<{ projectId: string }> }
) {
  const { projectId } = await context.params;
  const { message, activeSectionId, history = [] } = await req.json();
  
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return NextResponse.json({ error: "No autorizado" }, { status: 401 });

  const { data: project } = await supabase
    .from("projects")
    .select("*, clients(*), sections(*)")
    .eq("id", projectId)
    .single();

  if (!project) return NextResponse.json({ error: "Proyecto no encontrado" }, { status: 404 });
  
  const allSections = project.sections || [];
  const activeSection = allSections.find((s: any) => s.id === activeSectionId);
  const client = project.clients;

  // Resumen del proyecto para contexto global
  const projectSummary = allSections.map((s: any) => `[${s.title}]: ${s.content?.slice(0, 500) || "Sin redactar"}`).join("\n\n");

  const { data: bases } = await supabase
    .from("convocatoria_bases")
    .select("name, file_path")
    .eq("project_id", projectId)
    .not("file_path", "is", null);

  let grantText = "";
  if (bases) {
    for (const b of bases) {
      try {
        const { data: blob } = await supabase.storage.from(BUCKET).download(b.file_path!);
        if (blob) {
          const buffer = Buffer.from(await blob.arrayBuffer());
          const text = await extractTextFromPdf(buffer);
          grantText += `\n--- Archivo: ${b.name} ---\n${text}`;
        }
      } catch (e) {}
    }
  }

  const geminiKey = process.env.GEMINI_API_KEY;
  if (!geminiKey) return NextResponse.json({ error: "IA no configurada" }, { status: 500 });

  try {
    const genAI = new GoogleGenerativeAI(geminiKey);
    // Volvemos al modelo solicitado por el usuario con la versión v1beta
    const model = genAI.getGenerativeModel({ 
      model: "gemini-3-flash-preview",
      systemInstruction: { 
        role: "system", 
        parts: [{ text: `Eres el Master Assist de Begitality. Consultor experto.
        CLIENTE: ${JSON.stringify(client)}
        BASES: ${grantText.slice(0, MAX_CONTEXT_TEXT)}
        PROYECTO ACTUAL: ${projectSummary}
        ENFOQUE ACTUAL: ${activeSection?.title || "Vista General"}` }] 
      }
    }, { apiVersion: "v1beta" });

    const chat = model.startChat({
      history: history.slice(-6).map((msg: any) => ({
        role: msg.role === 'user' ? 'user' : 'model',
        parts: [{ text: msg.content }]
      })),
    });

    const result = await chat.sendMessage(message);
    const response = await result.response;
    const answer = response.text();

    await supabase.from("ai_messages").insert([
      { project_id: projectId, role: 'user', content: message, section_id: activeSectionId || null },
      { project_id: projectId, role: 'assistant', content: answer, section_id: activeSectionId || null }
    ]);

    return NextResponse.json({ answer });

  } catch (error: any) {
    console.error("Gemini 3 Error:", error);
    return NextResponse.json({ 
      error: "Límite de IA alcanzado", 
      message: error.message.includes("429") 
        ? "Has agotado las 20 consultas diarias gratuitas de Gemini 3. Por favor, espera a mañana o usa otra API Key."
        : "Error en el servicio de IA. Inténtalo de nuevo.",
      technical: error.message 
    }, { status: 502 });
  }
}
</file>

<file path="app/api/projects/[projectId]/check-eligibility/route.ts">
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { extractTextFromPdf } from "@/lib/pdf-extract";
import { GoogleGenerativeAI, SchemaType } from "@google/generative-ai";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";
const BUCKET = "convocatoria-files";
const MAX_TEXT_LENGTH = 30000;

export async function POST(
  _req: Request,
  context: { params: Promise<{ projectId: string }> }
) {
  const { projectId } = await context.params;
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return NextResponse.json({ error: "No autorizado" }, { status: 401 });

  const { data: project } = await supabase
    .from("projects")
    .select("*, clients(*)")
    .eq("id", projectId)
    .single();

  if (!project || !project.clients) return NextResponse.json({ error: "Contexto insuficiente" }, { status: 400 });

  const client = project.clients;
  const { data: bases } = await supabase.from("convocatoria_bases").select("name, file_path").eq("project_id", projectId);

  let grantText = "";
  if (bases) {
    for (const b of bases) {
      const { data: blob } = await supabase.storage.from(BUCKET).download(b.file_path!);
      if (blob) grantText += await extractTextFromPdf(Buffer.from(await blob.arrayBuffer()));
    }
  }

  const geminiKey = process.env.GEMINI_API_KEY;
  try {
    const genAI = new GoogleGenerativeAI(geminiKey!);
    const model = genAI.getGenerativeModel({
      model: "gemini-3-flash-preview",
      generationConfig: {
        responseMimeType: "application/json",
        responseSchema: {
          type: SchemaType.OBJECT,
          properties: {
            status: { type: SchemaType.STRING, description: "Estatus final: APTO, CONDICIONADO o NO APTO" },
            summary: { type: SchemaType.STRING },
            strengths: { type: SchemaType.ARRAY, items: { type: SchemaType.STRING } },
            risks: { type: SchemaType.ARRAY, items: { type: SchemaType.STRING } },
            recommendations: { type: SchemaType.ARRAY, items: { type: SchemaType.STRING } },
            probability: { type: SchemaType.INTEGER, description: "Probabilidad de éxito 0-100" }
          },
          required: ["status", "summary", "strengths", "risks", "recommendations", "probability"],
        },
      },
    }, { apiVersion: "v1beta" });

    const prompt = `Analiza la elegibilidad de ${client.name} para la convocatoria. 
    DOCS: ${grantText.slice(0, MAX_TEXT_LENGTH)}
    CLIENTE: ${JSON.stringify(client)}`;

    const result = await model.generateContent(prompt);
    const text = result.response.text();
    
    // Validar que la respuesta es un JSON válido antes de guardar
    try {
      JSON.parse(text);
    } catch (e) {
      console.error("Respuesta de IA no es JSON:", text);
      return NextResponse.json({ error: "La IA no devolvió un formato válido estructurado.", detail: text }, { status: 502 });
    }

    await supabase.from("projects").update({ viability_report: text }).eq("id", projectId);

    return NextResponse.json(JSON.parse(text));
  } catch (error: any) {
    console.error("Critical Eligibility Error:", error);
    return NextResponse.json({ 
      error: "Error en el motor de IA", 
      message: error.message,
      status: error.status 
    }, { status: 502 });
  }
}
</file>

<file path="app/api/projects/[projectId]/review/route.ts">
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { GoogleGenerativeAI, SchemaType } from "@google/generative-ai";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

export async function POST(
  _req: Request,
  context: { params: Promise<{ projectId: string }> }
) {
  const { projectId } = await context.params;
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return NextResponse.json({ error: "No autorizado" }, { status: 401 });

  // 1. Obtener contenido del proyecto
  const { data: project } = await supabase
    .from("projects")
    .select("*, sections(*)")
    .eq("id", projectId)
    .single();

  if (!project) return NextResponse.json({ error: "Proyecto no encontrado" }, { status: 404 });

  const sectionsContent = project.sections
    ?.map((s: any) => `## ${s.title}\n${s.content || "(Sección vacía)"}`)
    .join("\n\n");

  if (!sectionsContent) return NextResponse.json({ error: "No hay contenido para auditar." }, { status: 400 });

  // 2. IA Auditora
  const geminiKey = process.env.GEMINI_API_KEY;
  try {
    const genAI = new GoogleGenerativeAI(geminiKey!);
    const model = genAI.getGenerativeModel({
      model: "gemini-3-flash-preview",
      generationConfig: {
        responseMimeType: "application/json",
        responseSchema: {
          description: "Informe de auditoría de calidad de memoria técnica",
          type: SchemaType.OBJECT,
          properties: {
            score: { type: SchemaType.INTEGER, description: "Puntuación de 0 a 100" },
            summary: { type: SchemaType.STRING, description: "Resumen ejecutivo de la calidad" },
            strengths: { type: SchemaType.ARRAY, items: { type: SchemaType.STRING } },
            weaknesses: { type: SchemaType.ARRAY, items: { type: SchemaType.STRING } },
            improvements: { type: SchemaType.ARRAY, items: { type: SchemaType.STRING }, description: "Acciones concretas para mejorar" },
          },
          required: ["score", "summary", "strengths", "weaknesses", "improvements"],
        },
      },
    }, { apiVersion: "v1beta" });

    const prompt = `Actúa como un Auditor Senior de Subvenciones Públicas.
    Evalúa la calidad técnica, coherencia y profundidad de la siguiente memoria.
    
    CRITERIOS DE EVALUACIÓN:
    - Claridad y estructura.
    - Densidad técnica (evitar generalidades).
    - Coherencia entre secciones.
    - Persuasión y justificación del proyecto.

    MEMORIA A AUDITAR:
    ${sectionsContent}
    `;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const auditData = JSON.parse(response.text());

    // 3. Guardar resultados
    await supabase
      .from("projects")
      .update({
        review_report: JSON.stringify(auditData), // Guardamos el JSON completo
        success_score: auditData.score,
        updated_at: new Date().toISOString()
      })
      .eq("id", projectId);

    return NextResponse.json(auditData);

  } catch (error) {
    console.error("Audit Error:", error);
    return NextResponse.json({ error: "Error en el motor de auditoría" }, { status: 502 });
  }
}
</file>

<file path="app/auth/callback/route.ts">
import { createServerClient } from "@supabase/ssr";
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export async function GET(request: NextRequest) {
  const requestUrl = new URL(request.url);
  const code = requestUrl.searchParams.get("code");
  const next = requestUrl.searchParams.get("next") ?? "/dashboard";

  if (code) {
    const response = NextResponse.redirect(new URL(next, requestUrl.origin));
    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() {
            return request.cookies.getAll();
          },
          setAll(cookiesToSet: { name: string; value: string; options?: Record<string, unknown> }[]) {
            cookiesToSet.forEach(({ name, value, options }) =>
              response.cookies.set(name, value, options ?? {})
            );
          },
        },
      }
    );
    const { error } = await supabase.auth.exchangeCodeForSession(code);
    if (error) {
      return NextResponse.redirect(new URL(`/login?error=${encodeURIComponent(error.message)}`, requestUrl.origin));
    }
    return response;
  }

  return NextResponse.redirect(new URL("/login", requestUrl.origin));
}
</file>

<file path="app/dashboard/clients/page.tsx">
"use client";

import { useEffect, useState, useMemo } from "react";
import Link from "next/link";
import { PlusCircle, Search, Building2, Mail, Phone, ExternalLink, Archive, CheckCircle2 } from "lucide-react";
import { createClient } from "@/lib/supabase/client";
import { Client } from "@/lib/types";
import * as Tabs from "@radix-ui/react-tabs";
import { cn } from "@/lib/utils";

export default function ClientsListPage() {
  const [clients, setClients] = useState<Client[]>([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [activeTab, setActiveTab] = useState("active");
  const supabase = createClient();

  useEffect(() => {
    async function loadClients() {
      const { data } = await supabase
        .from("clients")
        .select("*")
        .order("name");
      setClients(data || []);
      setLoading(false);
    }
    loadClients();
  }, [supabase]);

  const stats = useMemo(() => {
    return {
      active: clients.filter(c => (c.status || 'active') === 'active').length,
      archived: clients.filter(c => c.status === 'archived').length
    };
  }, [clients]);

  const filteredClients = useMemo(() => {
    const s = search.toLowerCase();
    return clients.filter(c => {
      const matchesStatus = activeTab === 'active' 
        ? (c.status || 'active') === 'active' 
        : c.status === 'archived';
        
      const matchesSearch = 
        c.name.toLowerCase().includes(s) || 
        (c.tax_id || "").toLowerCase().includes(s) ||
        (c.contact_email || "").toLowerCase().includes(s);
        
      return matchesStatus && matchesSearch;
    });
  }, [clients, search, activeTab]);

  return (
    <div className="max-w-5xl mx-auto space-y-10 animate-in fade-in duration-500">
      <header className="flex justify-between items-end gap-6 flex-wrap">
        <div className="flex-1 min-w-[300px]">
          <h1 className="text-5xl font-black text-slate-900 tracking-tighter">
            Clientes
          </h1>
          <p className="text-slate-500 font-medium mt-2 text-lg">
            Base de datos de empresas y contactos
          </p>
        </div>
        <div className="flex items-center gap-4 w-full md:w-auto">
          <div className="relative flex-1 md:w-64">
            <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
            <input
              type="text"
              placeholder="Buscar cliente..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="w-full pl-10 pr-4 py-3 rounded-2xl border border-slate-200 bg-white focus:ring-2 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all text-sm font-medium"
            />
          </div>
          <Link
            href="/dashboard/clients/new"
            className="flex items-center gap-2 px-5 py-3 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-500 transition-all shadow-lg shadow-blue-600/20 shrink-0"
          >
            <PlusCircle size={20} />
            Nuevo cliente
          </Link>
        </div>
      </header>

      <Tabs.Root value={activeTab} onValueChange={setActiveTab} className="space-y-8">
        <Tabs.List className="flex gap-2 p-1 bg-slate-100 rounded-2xl w-fit">
          <Tabs.Trigger
            value="active"
            className={cn(
              "flex items-center gap-2 px-6 py-2.5 rounded-xl text-sm font-black transition-all",
              activeTab === "active" ? "bg-white text-blue-600 shadow-sm" : "text-slate-400 hover:text-slate-600"
            )}
          >
            <CheckCircle2 size={16} />
            Activos
            <span className="ml-1 opacity-50 font-medium text-[10px]">{stats.active}</span>
          </Tabs.Trigger>
          <Tabs.Trigger
            value="archived"
            className={cn(
              "flex items-center gap-2 px-6 py-2.5 rounded-xl text-sm font-black transition-all",
              activeTab === "archived" ? "bg-white text-amber-600 shadow-sm" : "text-slate-400 hover:text-slate-600"
            )}
          >
            <Archive size={16} />
            Archivados
            <span className="ml-1 opacity-50 font-medium text-[10px]">{stats.archived}</span>
          </Tabs.Trigger>
        </Tabs.List>

        <Tabs.Content value={activeTab} className="outline-none">
          {loading ? (
            <div className="flex items-center justify-center py-20">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
          ) : filteredClients.length === 0 ? (
            <div className="bg-white border border-slate-200 rounded-[3rem] p-20 text-center">
              <div className="w-20 h-20 bg-slate-50 rounded-3xl flex items-center justify-center mx-auto mb-6">
                {activeTab === 'active' ? <Building2 size={40} className="text-slate-300" /> : <Archive size={40} className="text-slate-300" />}
              </div>
              <h2 className="text-2xl font-black text-slate-900 mb-2">
                {search ? "Sin coincidencias" : activeTab === 'active' ? "Sin clientes activos" : "Histórico vacío"}
              </h2>
              <p className="text-slate-500 max-w-sm mx-auto mb-8 font-medium">
                {activeTab === 'active' 
                  ? "Registra a tus clientes para empezar a gestionar sus subvenciones." 
                  : "Aquí aparecerán los clientes que decidas archivar temporalmente."}
              </p>
              {activeTab === 'active' && !search && (
                <Link
                  href="/dashboard/clients/new"
                  className="inline-flex items-center gap-2 px-8 py-4 bg-blue-600 text-white rounded-[1.25rem] font-black text-sm hover:bg-blue-500 transition-all shadow-xl shadow-blue-600/20"
                >
                  <PlusCircle size={20} />
                  Registrar primer cliente
                </Link>
              )}
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {filteredClients.map((c) => (
                <Link
                  key={c.id}
                  href={`/dashboard/clients/${c.id}`}
                  className={cn(
                    "group bg-white border border-slate-200 rounded-[2.5rem] p-8 hover:shadow-2xl transition-all flex flex-col justify-between relative overflow-hidden",
                    activeTab === 'archived' ? "opacity-75 grayscale-[0.5] hover:opacity-100 hover:grayscale-0" : "hover:border-blue-200 hover:shadow-blue-500/5"
                  )}
                >
                  <div>
                    <div className="flex justify-between items-start mb-6">
                      <div className={cn(
                        "w-14 h-14 rounded-2xl flex items-center justify-center transition-all duration-500 group-hover:scale-110",
                        activeTab === 'active' ? "bg-blue-50 text-blue-600" : "bg-amber-50 text-amber-600"
                      )}>
                        <Building2 size={28} />
                      </div>
                      <ExternalLink size={18} className="text-slate-200 group-hover:text-blue-400 transition-colors" />
                    </div>
                    
                    <h3 className="text-2xl font-black text-slate-900 mb-1 tracking-tight group-hover:text-blue-600 transition-colors">
                      {c.name}
                    </h3>
                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-6">
                      {c.tax_id || "ID Pendiente"}
                    </p>
                    
                    <div className="space-y-3">
                      {c.contact_email && (
                        <div className="flex items-center gap-3 text-sm text-slate-500 font-medium">
                          <Mail size={16} className="text-slate-300" />
                          <span className="truncate">{c.contact_email}</span>
                        </div>
                      )}
                      {c.contact_phone && (
                        <div className="flex items-center gap-3 text-sm text-slate-500 font-medium">
                          <Phone size={16} className="text-slate-300" />
                          <span>{c.contact_phone}</span>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <div className="mt-8 pt-6 border-t border-slate-50 flex items-center justify-between">
                    <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest">
                      {new Date(c.created_at).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}
                    </span>
                    <span className={cn(
                      "text-xs font-bold",
                      activeTab === 'active' ? "text-blue-600" : "text-amber-600"
                    )}>
                      Ver Ficha
                    </span>
                  </div>
                </Link>
              ))}
            </div>
          )}
        </Tabs.Content>
      </Tabs.Root>
    </div>
  );
}
</file>

<file path="app/dashboard/layout.tsx">
import { AppSidebar } from "@/components/ui/sidebar";

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen bg-[#F8FAFC] flex font-sans selection:bg-blue-100">
      <AppSidebar />
      <main className="flex-1 ml-64 p-12 min-h-screen">{children}</main>
    </div>
  );
}
</file>

<file path="app/dashboard/projects/[id]/export/page.tsx">
import { notFound } from "next/navigation";
import { createClient } from "@/lib/supabase/server";
import { ExportView } from "@/components/export/ExportView";

export default async function ProjectExportPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) notFound();

  const { data: project } = await supabase
    .from("projects")
    .select("id, name, grant_name")
    .eq("id", id)
    .eq("user_id", user.id)
    .single();

  if (!project) notFound();

  const { data: sections } = await supabase
    .from("sections")
    .select("id, title, content, is_completed, sort_order")
    .eq("project_id", id)
    .order("sort_order");

  const sectionsForExport = (sections ?? []).map((s) => ({
    id: s.id,
    title: s.title,
    content: s.content,
    is_completed: s.is_completed,
  }));

  return (
    <ExportView
      project={{
        id: project.id,
        name: project.name,
        grant_name: project.grant_name,
        sections: sectionsForExport,
      }}
    />
  );
}
</file>

<file path="app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --begitality-primary: 37 99 235; /* blue-600 */
  --begitality-muted: 248 250 252; /* slate-50 */
}

@layer base {
  body {
    @apply bg-[#F8FAFC] text-slate-900 antialiased selection:bg-blue-100;
  }
}

/* Radix scrollbars */
[data-radix-scroll-area-viewport] {
  scrollbar-gutter: stable;
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Begitality | Gestión inteligente de subvenciones",
  description:
    "Plataforma inteligente de gestión de subvenciones. Automatiza la redacción de memorias técnicas con IA contextual.",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" className="h-full">
      <body
        className={`${geistSans.variable} ${geistMono.variable} font-sans min-h-screen`}
      >
        {children}
      </body>
    </html>
  );
}
</file>

<file path="app/page.tsx">
import Link from "next/link";
import { Zap } from "lucide-react";

export default function HomePage() {
  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-[#F8FAFC] px-4">
      <div className="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-600/20 mb-8">
        <Zap size={32} fill="currentColor" />
      </div>
      <h1 className="text-4xl font-black text-slate-900 tracking-tighter text-center mb-2">
        Begitality
      </h1>
      <p className="text-slate-500 text-center max-w-md mb-10">
        Plataforma inteligente de gestión de subvenciones. Redacta memorias
        técnicas con IA que no pierde el contexto.
      </p>
      <div className="flex gap-4">
        <Link
          href="/login"
          className="px-6 py-3 rounded-2xl font-bold text-slate-600 hover:text-slate-900 hover:bg-white border border-slate-200 transition-all"
        >
          Iniciar sesión
        </Link>
        <Link
          href="/signup"
          className="px-6 py-3 rounded-2xl font-bold text-white bg-blue-600 hover:bg-blue-500 shadow-lg shadow-blue-600/20 transition-all"
        >
          Registrarse
        </Link>
      </div>
    </div>
  );
}
</file>

<file path="components/project/AnalisisViabilidadIA.tsx">
"use client";

import { useState } from "react";
import { Sparkles, Loader2, AlertCircle, CheckCircle2, ShieldCheck, ChevronRight, X, FileSearch, Zap, Fingerprint, RefreshCw, TrendingUp, AlertTriangle } from "lucide-react";
import * as Dialog from "@radix-ui/react-dialog";
import { cn } from "@/lib/utils";
import { useRouter } from "next/navigation";

interface ViabilityData {
  status: string;
  summary: string;
  strengths: string[];
  risks: string[];
  recommendations: string[];
  probability: number;
}

export function AnalisisViabilidadIA({ projectId, hasClient, initialReport }: { projectId: string, hasClient: boolean, initialReport?: string | null }) {
  const [analyzing, setAnalyzing] = useState(false);
  const [isDownloading, setIsDownloading] = useState(false);
  const [isOpen, setIsOpen] = useState(false);
  
  const [data, setData] = useState<ViabilityData | null>(() => {
    if (!initialReport) return null;
    try {
      return JSON.parse(initialReport);
    } catch (e) {
      return null;
    }
  });
  
  const router = useRouter();

  const handleAnalyze = async (force = false) => {
    if (!hasClient) return;
    if (data && !force) { setIsOpen(true); return; }
    
    setAnalyzing(true);
    setIsOpen(true);
    try {
      const res = await fetch(`/api/projects/${projectId}/check-eligibility`, { method: "POST" });
      const resData = await res.json();
      if (!res.ok) throw new Error(resData.error);
      setData(resData);
      router.refresh();
    } catch (e) { console.error(e); } finally { setAnalyzing(false); }
  };

  const handleDownload = async () => {
    if (!data) return;
    setIsDownloading(true);
    try {
      const res = await fetch("/api/export/viability", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ projectId }),
      });
      if (!res.ok) throw new Error("Error generando PDF");
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Certificado_Viabilidad_${projectId.substring(0, 8)}.pdf`;
      a.click();
      window.URL.revokeObjectURL(url);
    } catch (e) {
      console.error(e);
      alert("No se pudo generar el certificado oficial.");
    } finally {
      setIsDownloading(false);
    }
  };

  return (
    <div className="bg-white border border-slate-200 rounded-[2rem] p-6 shadow-sm relative overflow-hidden group">
      <div className="flex items-center justify-between mb-4 relative z-10">
        <h3 className="font-black text-slate-900 flex items-center gap-2.5 text-[10px] uppercase tracking-[0.25em]">
          <div className={cn("w-2 h-2 rounded-full", data ? "bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]" : "bg-indigo-500 animate-pulse")} />
          Viabilidad
        </h3>
        {data && <span className="text-[8px] font-black text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded uppercase tracking-widest">IA Certified</span>}
      </div>

      <div className="relative z-10 space-y-4">
        <p className="text-[10px] text-slate-400 font-bold leading-relaxed uppercase tracking-widest">
          {data ? `Éxito Estimado: ${data.probability}%` : "Audita el encaje estratégico del expediente."}
        </p>
        <button
          onClick={() => handleAnalyze()}
          disabled={analyzing || !hasClient}
          className={cn(
            "w-full py-3.5 rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] transition-all flex items-center justify-center gap-3 shadow-lg active:scale-95",
            hasClient ? "bg-slate-900 text-white hover:bg-indigo-600 shadow-slate-900/10" : "bg-slate-50 text-slate-300 border border-slate-100"
          )}
        >
          {analyzing ? <Loader2 className="animate-spin" size={14} /> : data ? <FileSearch size={14} /> : <Sparkles size={14} />}
          {analyzing ? "Procesando..." : data ? "Ver Certificado IA" : "Auditar Elegibilidad"}
        </button>
      </div>

      <div className="absolute -right-6 -bottom-6 opacity-[0.03] group-hover:scale-110 transition-transform duration-1000 pointer-events-none">
        <Fingerprint size={180} />
      </div>

      <Dialog.Root open={isOpen} onOpenChange={setIsOpen}>
        <Dialog.Portal>
          <Dialog.Overlay className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] animate-in fade-in duration-300" />
          <Dialog.Content className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl bg-white rounded-[2.5rem] p-0 shadow-[0_50px_100px_-20px_rgba(0,0,0,0.3)] z-[101] max-h-[85vh] flex flex-col overflow-hidden outline-none animate-in zoom-in-95">
            
            <div className="p-8 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-xl shadow-indigo-600/20"><ShieldCheck size={24} /></div>
                <div>
                  <Dialog.Title className="text-xl font-black text-slate-900 tracking-tighter leading-none">Certificado de Viabilidad</Dialog.Title>
                  <p className="text-[9px] font-black text-indigo-600 uppercase tracking-[0.3em] mt-1.5">Begitality Intelligence Audit</p>
                </div>
              </div>
              <button onClick={() => setIsOpen(false)} className="p-3 hover:bg-white rounded-2xl text-slate-400 hover:text-slate-900 transition-all"><X size={20} /></button>
            </div>

            <div className="flex-1 overflow-y-auto p-10 space-y-8 scrollbar-hide bg-white">
              {analyzing ? (
                <div className="py-20 text-center space-y-6">
                  <Loader2 size={48} className="animate-spin text-blue-600 mx-auto" />
                  <p className="text-sm font-black text-slate-900 uppercase tracking-widest animate-pulse">Auditando Requisitos Legales...</p>
                </div>
              ) : data && (
                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                  
                  <div className="flex items-center justify-between p-6 bg-slate-50 rounded-[2rem] border border-slate-100 mb-8">
                    <div className="space-y-1">
                      <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Dictamen</p>
                      <p className={cn("text-xl font-black tracking-tighter", 
                        data.status === 'APTO' ? "text-emerald-600" : data.status === 'CONDICIONADO' ? "text-amber-600" : "text-red-600"
                      )}>{data.status}</p>
                    </div>
                    <div className="text-right space-y-1">
                      <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Score Técnico</p>
                      <p className="text-xl font-black text-slate-900 tracking-tighter">{data.probability}/100</p>
                    </div>
                  </div>

                  <div className="space-y-3 mb-10 px-2">
                    <h4 className="font-black text-slate-900 text-[10px] uppercase tracking-widest flex items-center gap-2 text-indigo-600"><Zap size={14} fill="currentColor" /> Análisis Ejecutivo</h4>
                    <p className="text-sm text-slate-600 font-bold leading-relaxed">{data.summary}</p>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                    <div className="space-y-4">
                      <h5 className="font-black text-[10px] text-emerald-600 uppercase tracking-widest flex items-center gap-2">Puntos Favorables</h5>
                      <div className="space-y-2">
                        {data.strengths.map((s, i) => (
                          <div key={i} className="text-[11px] text-slate-600 font-bold bg-emerald-50/50 p-4 rounded-2xl border border-emerald-100 flex items-start gap-3">
                            <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full mt-1.5 shrink-0" />
                            {s}
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="space-y-4">
                      <h5 className="font-black text-[10px] text-red-500 uppercase tracking-widest flex items-center gap-2">Riesgos Críticos</h5>
                      <div className="space-y-2">
                        {data.risks.map((r, i) => (
                          <div key={i} className="text-[11px] text-slate-600 font-bold bg-red-50/50 p-4 rounded-2xl border border-red-100 flex items-start gap-3">
                            <div className="w-1.5 h-1.5 bg-red-500 rounded-full mt-1.5 shrink-0" />
                            {r}
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className="p-8 bg-indigo-600 rounded-[2.5rem] text-white shadow-xl shadow-indigo-600/20">
                    <h5 className="font-black text-[10px] uppercase tracking-[0.2em] mb-4 flex items-center gap-2"><TrendingUp size={16} /> Hoja de Ruta Sugerida</h5>
                    <div className="space-y-3">
                      {data.recommendations.map((rec, i) => (
                        <div key={i} className="flex gap-3 items-start bg-white/10 p-3 rounded-xl border border-white/10">
                          <div className="w-5 h-5 bg-white text-indigo-600 rounded flex items-center justify-center text-[10px] font-black shrink-0">{i+1}</div>
                          <p className="text-[11px] font-bold leading-tight">{rec}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>

            <div className="p-8 border-t border-slate-100 bg-slate-50/30 flex justify-between items-center">
              <button onClick={() => handleAnalyze(true)} className="px-6 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 flex items-center gap-2" disabled={analyzing}>
                <RefreshCw size={12} className={cn(analyzing && "animate-spin")} /> Re-Auditar
              </button>
              <button 
                onClick={handleDownload} 
                disabled={isDownloading}
                className="px-8 py-3 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-600 transition-all shadow-lg flex items-center gap-2"
              >
                {isDownloading ? <Loader2 size={14} className="animate-spin" /> : <ShieldCheck size={14} />}
                {isDownloading ? "Generando PDF..." : "Descargar Certificado Oficial"}
              </button>
            </div>
          </Dialog.Content>
        </Dialog.Portal>
      </Dialog.Root>
    </div>
  );
}
</file>

<file path="components/project/ClientSelector.tsx">
"use client";

import { useState, useRef, useEffect, useMemo } from "react";
import { Building2, ChevronDown, Check, X, RefreshCw, Search, UserPlus, CheckCircle2 } from "lucide-react";
import { cn } from "@/lib/utils";
import { createClient } from "@/lib/supabase/client";
import { useRouter } from "next/navigation";

interface Client {
  id: string;
  name: string;
}

interface ClientSelectorProps {
  projectId: string;
  initialClient: Client | null;
  availableClients: Client[];
}

export function ClientSelector({ projectId, initialClient, availableClients }: ClientSelectorProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedClient, setSelectedId] = useState<string>(initialClient?.id || "");
  const [updating, setUpdating] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);
  const selectorRef = useRef<HTMLDivElement>(null);
  const router = useRouter();
  const supabase = createClient();

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const filteredClients = useMemo(() => {
    return availableClients.filter(c => 
      c.name.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [availableClients, searchTerm]);

  const handleSelect = async (clientId: string | null) => {
    setUpdating(true);
    const { error } = await supabase
      .from("projects")
      .update({ client_id: clientId })
      .eq("id", projectId);

    if (!error) {
      setSelectedId(clientId || "");
      setIsOpen(false);
      router.refresh();
    }
    setUpdating(false);
  };

  return (
    <div className="relative w-full" ref={containerRef}>
      {/* Botón de Activación */}
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className={cn(
          "w-full flex items-center justify-between px-5 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all border",
          selectedClient 
            ? "bg-slate-900 text-white border-slate-900 shadow-lg" 
            : "bg-blue-600 text-white border-blue-600 shadow-xl shadow-blue-600/20 hover:bg-blue-500 active:scale-[0.98]"
        )}
      >
        <div className="flex items-center gap-3 truncate">
          {updating ? <Loader2 size={14} className="animate-spin" /> : <UserPlus size={14} className="text-white" />}
          <span className="truncate">{selectedClient ? "Cambiar Cliente" : "Asignar un Cliente"}</span>
        </div>
        <ChevronDown size={14} className={cn("transition-transform duration-500 opacity-50", isOpen && "rotate-180")} />
      </button>

      {/* Menú Desplegable "Air Style" - Ligero y con desenfoque de fondo */}
      {isOpen && (
        <div 
          ref={selectorRef}
          className="absolute bottom-full mb-3 left-0 right-0 bg-white/95 backdrop-blur-xl border border-slate-200/60 rounded-[2rem] shadow-[0_20px_50px_-12px_rgba(0,0,0,0.15)] z-40 p-3 animate-in slide-in-from-bottom-2 duration-300"
        >
          
          <div className="px-2 mb-2">
            <div className="relative">
              <Search size={12} className="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400" />
              <input 
                autoFocus
                placeholder="Filtrar..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-9 pr-4 py-2.5 bg-slate-50/50 border border-slate-100 rounded-xl text-[11px] font-bold outline-none focus:ring-2 focus:ring-blue-500/10 transition-all placeholder:text-slate-300"
              />
            </div>
          </div>

          <div className="max-h-52 overflow-y-auto space-y-0.5 pr-1 scrollbar-thin
            [&::-webkit-scrollbar]:w-1
            [&::-webkit-scrollbar-track]:bg-transparent
            [&::-webkit-scrollbar-thumb]:bg-slate-200
            [&::-webkit-scrollbar-thumb]:rounded-full">
            
            <button 
              onClick={() => handleSelect(null)}
              className="w-full text-left px-4 py-2.5 hover:bg-red-50 rounded-xl text-[9px] font-black uppercase transition-all flex items-center gap-3 group"
            >
              <X size={12} className="text-slate-300 group-hover:text-red-500" /> 
              <span className="text-slate-400 group-hover:text-red-600">Quitar asignación</span>
            </button>

            <div className="h-px bg-slate-100/50 my-1.5 mx-2" />

            {filteredClients.length === 0 ? (
              <div className="py-6 text-center">
                <p className="text-[8px] text-slate-400 font-black uppercase tracking-widest">Sin resultados</p>
              </div>
            ) : (
              filteredClients.map(c => (
                <button 
                  key={c.id}
                  onClick={() => handleSelect(c.id)}
                  className={cn(
                    "w-full text-left px-4 py-2.5 rounded-xl text-[10px] font-bold transition-all flex items-center justify-between group",
                    selectedClient === c.id ? "bg-blue-50 text-blue-600" : "hover:bg-slate-50 text-slate-500"
                  )}
                >
                  <div className="flex items-center gap-3 truncate">
                    <Building2 size={12} className={cn(selectedClient === c.id ? "text-blue-600" : "text-slate-300 group-hover:text-blue-500")} /> 
                    <span className="truncate">{c.name}</span>
                  </div>
                  {selectedClient === c.id && <Check size={12} className="text-blue-600" />}
                </button>
              ))
            )}
          </div>
        </div>
      )}
    </div>
  );
}

function Loader2({ size, className }: { size?: number; className?: string }) {
  return <RefreshCw size={size} className={cn("animate-spin", className)} />;
}
</file>

<file path="components/project/MasterChatIA.tsx">
"use client";

import { useState, useEffect, useRef } from "react";
import { 
  Zap, Send, Bot, Loader2, MessageSquare, HelpCircle, 
  X, Target, Globe, CheckCircle2, Layout,
  Layers, FileSearch, Sparkles, Info, Hash, AtSign
} from "lucide-react";
import { createClient } from "@/lib/supabase/client";
import { cn } from "@/lib/utils";

interface Message {
  role: 'user' | 'assistant';
  content: string;
}

interface Section {
  id: string;
  title: string;
}

export function MasterChatIA({ projectId }: { projectId: string }) {
  const [messages, setMessages] = useState<Message[]>([]);
  const [sections, setSections] = useState<Section[]>([]);
  const [input, setInput] = useState("");
  const [isChatting, setIsChatting] = useState(false);
  const [showHelp, setShowHelp] = useState(false);
  const [focusId, setFocusId] = useState<string>("global");
  const [showFocusSelector, setShowFocusSelector] = useState(false);
  
  const chatEndRef = useRef<HTMLDivElement>(null);
  const helpRef = useRef<HTMLDivElement>(null);
  const helpBtnRef = useRef<HTMLButtonElement>(null);
  const selectorRef = useRef<HTMLDivElement>(null);
  const selectorBtnRef = useRef<HTMLButtonElement>(null);
  const supabase = createClient();

  useEffect(() => {
    loadChatHistory();
    loadSections();

    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Node;
      
      // Cerrar ayuda si el clic es fuera del panel Y fuera del botón de ayuda
      if (helpRef.current && !helpRef.current.contains(target) && 
          helpBtnRef.current && !helpBtnRef.current.contains(target)) {
        setShowHelp(false);
      }
      
      // Cerrar selector si el clic es fuera del menú Y fuera del botón del selector
      if (selectorRef.current && !selectorRef.current.contains(target) && 
          selectorBtnRef.current && !selectorBtnRef.current.contains(target)) {
        setShowFocusSelector(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [projectId]);

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  const loadChatHistory = async () => {
    const { data } = await supabase
      .from("ai_messages")
      .select("role, content")
      .eq("project_id", projectId)
      .order("created_at", { ascending: true });
    setMessages((data as Message[]) || []);
  };

  const loadSections = async () => {
    const { data } = await supabase
      .from("sections")
      .select("id, title")
      .eq("project_id", projectId)
      .order("sort_order");
    setSections(data || []);
  };

  const sendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim() || isChatting) return;

    const userMsg = input.trim();
    setInput("");
    setMessages(prev => [...prev, { role: 'user', content: userMsg }]);
    setIsChatting(true);

    try {
      const res = await fetch(`/api/projects/${projectId}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          message: userMsg, 
          activeSectionId: focusId === "global" ? null : focusId,
          history: messages 
        })
      });
      
      const data = await res.json();
      
      if (!res.ok) {
        throw new Error(data.message || data.error || "Error en la comunicación con la IA");
      }

      if (data.answer) {
        setMessages(prev => [...prev, { role: 'assistant', content: data.answer }]);
      }
    } catch (e: any) {
      console.error("Chat Error:", e);
      setMessages(prev => [...prev, { 
        role: 'assistant', 
        content: `⚠️ Error: ${e.message}. Por favor, inténtalo de nuevo en unos segundos.` 
      }]);
    } finally {
      setIsChatting(false);
    }
  };

  const selectedSectionTitle = sections.find(s => s.id === focusId)?.title;

  return (
    <div className="bg-white border border-slate-200 rounded-[2.5rem] shadow-sm flex flex-col h-[650px] relative overflow-hidden animate-in fade-in duration-700">
      
      {/* HEADER */}
      <div className="px-8 py-5 border-b border-slate-50 flex items-center justify-between bg-white">
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-600/20">
            <Zap size={16} fill="currentColor" />
          </div>
          <div>
            <span className="text-xs font-black text-slate-900 uppercase tracking-widest">Begitality Assist</span>
            <div className="flex items-center gap-1.5 mt-0.5">
              <div className="w-1 h-1 bg-emerald-500 rounded-full animate-pulse" />
              <span className="text-[8px] font-black text-blue-600 uppercase tracking-widest">Master Copilot Active</span>
            </div>
          </div>
        </div>
        <button 
          ref={helpBtnRef}
          onClick={() => {
            setShowHelp(prev => !prev);
            setShowFocusSelector(false);
          }}
          className={cn("p-2 rounded-lg transition-all", showHelp ? "bg-blue-50 text-blue-600" : "text-slate-300 hover:text-slate-900")}
        >
          <HelpCircle size={18} />
        </button>
      </div>

      {/* CHAT AREA */}
      <div className="flex-1 overflow-y-auto p-8 space-y-8 bg-white/50 scroll-smooth
        [&::-webkit-scrollbar]:w-1
        [&::-webkit-scrollbar-track]:bg-transparent
        [&::-webkit-scrollbar-thumb]:bg-slate-200
        [&::-webkit-scrollbar-thumb]:rounded-full
        hover:[&::-webkit-scrollbar-thumb]:bg-slate-300">
        
        {messages.length === 0 ? (
          <div className="h-full flex flex-col items-center justify-center opacity-30 text-center px-10">
            <Bot size={48} className="text-slate-200 mb-4" />
            <p className="text-[10px] font-black uppercase tracking-[0.3em] text-slate-400">Consultoría Estratégica Lista</p>
          </div>
        ) : (
          messages.map((m, i) => (
            <div key={i} className={cn(
              "animate-in fade-in slide-in-from-bottom-2 duration-500",
              m.role === 'user' ? "flex flex-col items-end" : "flex flex-col items-start"
            )}>
              <div className={cn(
                "max-w-[90%] p-5 rounded-[1.8rem] text-[13px] leading-relaxed shadow-sm transition-all",
                m.role === 'user' 
                  ? "bg-slate-900 text-white rounded-tr-none" 
                  : "bg-slate-50 text-slate-700 border border-slate-100 rounded-tl-none font-medium"
              )}>
                {m.content}
              </div>
            </div>
          ))
        )}
        {isChatting && (
          <div className="flex items-center gap-3 animate-pulse px-2">
            <Loader2 size={14} className="animate-spin text-blue-600" />
            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Master está analizando...</span>
          </div>
        )}
        <div ref={chatEndRef} />
      </div>

      {/* AYUDA OVERLAY */}
      {showHelp && (
        <div ref={helpRef} className="absolute inset-x-8 top-20 bg-slate-900 rounded-3xl p-6 text-white shadow-2xl z-20 animate-in zoom-in-95">
          <div className="flex justify-between items-center mb-4">
            <div className="flex items-center gap-2">
              <Sparkles size={16} className="text-blue-400" />
              <h5 className="font-black text-[10px] uppercase tracking-[0.2em]">Guía Master Assist</h5>
            </div>
            <button onClick={() => setShowHelp(false)} className="p-1 hover:bg-white/10 rounded-lg"><X size={16} /></button>
          </div>
          <p className="text-[11px] leading-relaxed opacity-80 font-medium">
            Usa el botón <b>#</b> para seleccionar una sección específica. Gemini enfocará su análisis en ese apartado cruzándolo con los documentos oficiales.
          </p>
        </div>
      )}

      {/* INPUT AREA */}
      <div className="p-6 bg-white border-t border-slate-50">
        <form onSubmit={sendMessage} className="flex flex-col gap-3 relative">
          <div className="relative">
            <button
              ref={selectorBtnRef}
              type="button"
              onClick={() => {
                setShowFocusSelector(prev => !prev);
                setShowHelp(false);
              }}
              className={cn(
                "flex items-center gap-2 px-4 py-1.5 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all border",
                focusId === 'global' ? "bg-slate-50 text-slate-400 border-slate-100" : "bg-blue-600 text-white border-blue-600 shadow-lg shadow-blue-600/20"
              )}
            >
              <Hash size={12} />
              {focusId === 'global' ? 'Contexto Global' : selectedSectionTitle}
            </button>
            
            {showFocusSelector && (
              <div ref={selectorRef} className="absolute bottom-full mb-3 left-0 right-0 bg-white border border-slate-200 rounded-[2rem] shadow-2xl z-30 p-3 animate-in slide-in-from-bottom-4 duration-300">
                <div className="max-h-48 overflow-y-auto space-y-1 scrollbar-thin
                  [&::-webkit-scrollbar]:w-1
                  [&::-webkit-scrollbar-track]:bg-transparent
                  [&::-webkit-scrollbar-thumb]:bg-slate-200
                  [&::-webkit-scrollbar-thumb]:rounded-full">
                  <button 
                    type="button"
                    onClick={() => { setFocusId("global"); setShowFocusSelector(false); }}
                    className="w-full text-left px-4 py-3 hover:bg-blue-50 hover:text-blue-600 rounded-2xl text-[10px] font-black uppercase transition-all flex items-center gap-3 group"
                  >
                    <Globe size={14} className="text-slate-300 group-hover:text-blue-500" /> Visión Global
                  </button>
                  {sections.map(s => (
                    <button 
                      key={s.id}
                      type="button"
                      onClick={() => { setFocusId(s.id); setShowFocusSelector(false); }}
                      className="w-full text-left px-4 py-3 hover:bg-blue-50 hover:text-blue-600 rounded-2xl text-[10px] font-black uppercase transition-all flex items-center gap-3 group"
                    >
                      <Target size={14} className="text-slate-300 group-hover:text-blue-500" /> {s.title}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>

          <div className="relative flex items-center">
            <input
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="Consulta al consultor senior..."
              className="w-full pl-6 pr-14 py-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold outline-none focus:ring-4 focus:ring-blue-500/5 focus:border-blue-200 transition-all placeholder:text-slate-300"
            />
            <button 
              type="submit"
              disabled={!input.trim() || isChatting}
              className="absolute right-2 p-3 bg-blue-600 text-white rounded-xl shadow-xl shadow-blue-600/30 disabled:opacity-20 hover:bg-blue-500 transition-all active:scale-95"
            >
              <Send size={20} />
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="components/project/ProjectReview.tsx">
"use client";

import { useState } from "react";
import { 
  Activity, 
  Loader2, 
  Award, 
  TrendingUp, 
  AlertTriangle, 
  CheckCircle2, 
  ChevronRight, 
  X, 
  RefreshCw,
  ClipboardCheck,
  ShieldCheck,
  Bot
} from "lucide-react";
import * as Dialog from "@radix-ui/react-dialog";
import { cn } from "@/lib/utils";
import { useRouter } from "next/navigation";

interface AuditReport {
  score: number;
  summary: string;
  strengths: string[];
  weaknesses: string[];
  improvements: string[];
}

export function ProjectReview({ projectId, initialReport, hasContent }: { projectId: string, initialReport: string | null, hasContent: boolean }) {
  const [analyzing, setAnalyzing] = useState(false);
  const [isDownloading, setIsDownloading] = useState(false);
  const [isOpen, setIsOpen] = useState(false);
  
  const [report, setReport] = useState<AuditReport | null>(() => {
    if (!initialReport) return null;
    try {
      return JSON.parse(initialReport);
    } catch (e) {
      return null;
    }
  });
  
  const router = useRouter();

  const runAudit = async () => {
    if (!hasContent) return;
    setAnalyzing(true);
    setIsOpen(true);
    try {
      const res = await fetch(`/api/projects/${projectId}/review`, { method: "POST" });
      const data = await res.json();
      if (!res.ok) throw new Error("Error en auditoría");
      setReport(data);
      router.refresh();
    } catch (e) {
      console.error(e);
    } finally {
      setAnalyzing(false);
    }
  };

  const handleDownload = async () => {
    if (!report) return;
    setIsDownloading(true);
    try {
      const res = await fetch("/api/export/review", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ projectId }),
      });
      if (!res.ok) throw new Error("Export fail");
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Auditoria_${projectId.substring(0, 8)}.pdf`;
      a.click();
      window.URL.revokeObjectURL(url);
    } catch (e) { 
      console.error(e);
      alert("No se pudo generar el reporte oficial.");
    } finally {
      setIsDownloading(false);
    }
  };

  const getScoreColor = (score: number) => {
    if (score >= 80) return "text-emerald-500";
    if (score >= 50) return "text-amber-500";
    return "text-red-500";
  };

  const getScoreBg = (score: number) => {
    if (score >= 80) return "bg-emerald-500";
    if (score >= 50) return "bg-amber-500";
    return "bg-red-500";
  };

  return (
    <div className="bg-white border border-slate-200 rounded-[2.5rem] p-8 shadow-sm relative overflow-hidden group">
      
      <div className="flex items-center justify-between mb-6 relative z-10">
        <h3 className="font-black text-slate-900 flex items-center gap-2 text-[10px] uppercase tracking-[0.2em]">
          <Activity size={14} className="text-blue-600" />
          Calidad Técnica
        </h3>
        {report && (
          <span className={cn("text-[9px] font-black uppercase tracking-widest px-2 py-1 rounded-lg", getScoreColor(report.score), "bg-slate-50 border border-current/10")}>
            {report.score}/100
          </span>
        )}
      </div>

      <div className="relative z-10 text-center space-y-6">
        {report ? (
          <div className="space-y-4">
            <div className="relative w-32 h-32 mx-auto flex items-center justify-center">
              <svg className="w-full h-full transform -rotate-90">
                <circle cx="64" cy="64" r="60" stroke="currentColor" strokeWidth="8" fill="transparent" className="text-slate-50" />
                <circle cx="64" cy="64" r="60" stroke="currentColor" strokeWidth="8" fill="transparent" 
                  className={getScoreColor(report.score)}
                  strokeDasharray={377}
                  strokeDashoffset={377 - (377 * report.score) / 100}
                  strokeLinecap="round"
                />
              </svg>
              <div className="absolute inset-0 flex flex-col items-center justify-center">
                <span className={cn("text-3xl font-black tracking-tighter", getScoreColor(report.score))}>{report.score}</span>
                <span className="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Quality Score</span>
              </div>
            </div>
            <button 
              onClick={() => setIsOpen(true)}
              className="w-full py-3 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-600 transition-all shadow-lg active:scale-95"
            >
              Consultar Auditoría
            </button>
          </div>
        ) : (
          <div className="py-4">
            <div className="w-16 h-16 bg-slate-50 rounded-2xl flex items-center justify-center mx-auto mb-4 border border-slate-100 shadow-inner group-hover:scale-110 transition-transform">
              <ClipboardCheck size={28} className="text-slate-300" />
            </div>
            <p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest leading-relaxed mb-6 px-4">
              Analiza la calidad técnica y coherencia de tu redacción.
            </p>
            <button 
              onClick={runAudit}
              disabled={analyzing || !hasContent}
              className={cn(
                "w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg active:scale-95",
                hasContent ? "bg-blue-600 text-white hover:bg-blue-500" : "bg-slate-50 text-slate-300 border border-slate-100 cursor-not-allowed"
              )}
            >
              {analyzing ? <Loader2 size={14} className="animate-spin mx-auto" /> : "Ejecutar Auditoría IA"}
            </button>
          </div>
        )}
      </div>

      <Dialog.Root open={isOpen} onOpenChange={setIsOpen}>
        <Dialog.Portal>
          <Dialog.Overlay className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] animate-in fade-in" />
          <Dialog.Content className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl bg-white rounded-[2.5rem] p-0 shadow-2xl z-[101] max-h-[85vh] flex flex-col overflow-hidden outline-none animate-in zoom-in-95">
            
            <div className="p-8 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
              <div className="flex items-center gap-4">
                <div className={cn("w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-xl", report ? getScoreBg(report.score) : "bg-blue-600")}>
                  <ShieldCheck size={24} />
                </div>
                <div>
                  <Dialog.Title className="text-xl font-black text-slate-900 tracking-tighter leading-none">Reporte de Calidad IA</Dialog.Title>
                  <p className="text-[9px] font-black text-slate-400 uppercase tracking-[0.3em] mt-1.5">Certificación Begitality Assist</p>
                </div>
              </div>
              <button onClick={() => setIsOpen(false)} className="p-3 hover:bg-white rounded-2xl text-slate-400 transition-all shadow-sm border border-transparent hover:border-slate-100"><X size={20} /></button>
            </div>

            <div className="flex-1 overflow-y-auto p-10 space-y-10 scrollbar-hide bg-white">
              {analyzing ? (
                <div className="py-20 text-center space-y-6">
                  <Loader2 size={48} className="animate-spin text-blue-600 mx-auto" />
                  <p className="text-xs font-black text-slate-400 uppercase tracking-widest animate-pulse">Escaneando redacción técnica...</p>
                </div>
              ) : report && (
                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                  <div className="p-8 bg-slate-50 rounded-[2.5rem] border border-slate-100 mb-10 shadow-inner">
                    <h4 className="font-black text-slate-900 text-[10px] uppercase tracking-widest mb-3 flex items-center gap-2">
                      <Bot size={14} className="text-blue-600" /> Resumen Ejecutivo
                    </h4>
                    <p className="text-xs text-slate-600 font-bold leading-relaxed">{report.summary}</p>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                    <div className="space-y-4">
                      <h5 className="font-black text-[10px] text-emerald-600 uppercase tracking-widest flex items-center gap-2">Puntos Fuertes</h5>
                      <div className="space-y-2">
                        {report.strengths.map((s, i) => (
                          <div key={i} className="text-[11px] text-slate-600 font-bold bg-emerald-50/50 p-4 rounded-2xl border border-emerald-100 flex items-start gap-3">
                            <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full mt-1.5 shrink-0" />
                            {s}
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="space-y-4">
                      <h5 className="font-black text-[10px] text-red-500 uppercase tracking-widest flex items-center gap-2">Debilidades</h5>
                      <div className="space-y-2">
                        {report.weaknesses.map((w, i) => (
                          <div key={i} className="text-[11px] text-slate-600 font-bold bg-red-50/50 p-4 rounded-2xl border border-red-100 flex items-start gap-3">
                            <div className="w-1.5 h-1.5 bg-red-500 rounded-full mt-1.5 shrink-0" />
                            {w}
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className="space-y-6">
                    <h5 className="font-black text-[10px] text-blue-600 uppercase tracking-widest flex items-center gap-2">Plan de Mejora Recomendado</h5>
                    <div className="grid grid-cols-1 gap-3">
                      {report.improvements.map((imp, i) => (
                        <div key={i} className="flex gap-5 p-6 bg-white border border-slate-100 rounded-[2rem] shadow-sm hover:shadow-md transition-all group">
                          <div className="w-10 h-10 bg-blue-50 rounded-2xl flex items-center justify-center text-xs font-black text-blue-600 shrink-0 group-hover:bg-blue-600 group-hover:text-white transition-colors">{i+1}</div>
                          <p className="text-xs text-slate-700 font-bold leading-relaxed">{imp}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>

            <div className="p-8 border-t border-slate-100 bg-slate-50/30 flex justify-between items-center">
              <button 
                onClick={runAudit}
                disabled={analyzing}
                className="px-6 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-all flex items-center gap-2"
              >
                <RefreshCw size={12} className={cn(analyzing && "animate-spin")} /> Re-Auditar
              </button>
              <button 
                onClick={handleDownload}
                disabled={isDownloading || !report}
                className="px-8 py-3 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-600 transition-all shadow-lg flex items-center gap-2"
              >
                {isDownloading ? <Loader2 size={14} className="animate-spin" /> : <ShieldCheck size={14} />}
                {isDownloading ? "Generando..." : "Descargar Reporte Pro"}
              </button>
            </div>
          </Dialog.Content>
        </Dialog.Portal>
      </Dialog.Root>
    </div>
  );
}
</file>

<file path="docs/COMPARATIVA-SQL-Y-ESTRUCTURA.md">
# Comparativa: SQL y estructura del proyecto

## Qué ejecutar en Supabase para la creación inicial

**Recomendación: ejecutar `supabase/migrations/001_initial_schema.sql`.**

Es el más completo para la fase actual porque incluye:

- **profiles** + trigger que crea el perfil al registrarse (necesario para login/UI).
- **projects** con `grant_name` y `grant_type` (alineado con el dashboard y convocatorias).
- **sections** (memoria técnica por proyecto), **convocatoria_bases**, **checklist_items**, **ai_messages**.
- **RLS** definido en todas las tablas (no solo en `projects`).
- **Índices** para consultas por `user_id` y `project_id`.
- **Trigger** `on_auth_user_created` → `handle_new_user()`.

---

## Comparativa con `creacion-de-tablas.sql` (tu fichero)

| Aspecto | 001_initial_schema.sql (mío) | creacion-de-tablas.sql (tuyo) |
|--------|------------------------------|------------------------------|
| **profiles** | Sí (con plan, trigger) | No |
| **projects** | name, grant_name, grant_type, status (draft/in_progress/ready_export/exported) | name, description, deadline, status (draft/review/completed) |
| **Documentos** | convocatoria_bases (solo bases) | documents con type: grant_basis, technical_memory, previous_proposal |
| **Secciones / contenido** | sections (título, contenido, orden) para la memoria | document_sections (contenido + **embedding vector(1536)**) por documento |
| **Checklist** | checklist_items (label, required, checked) | requirements (label, description, is_completed, **source_fragment_id**) |
| **IA** | ai_messages (chat por proyecto) | — |
| **RLS** | Todas las tablas con políticas concretas | Solo projects; indica “repetir para documentos…” pero no está escrito |
| **Extensión** | uuid-ossp | **admin vector** (error: la extensión correcta es `vector` de pgvector) |
| **Trigger signup** | Sí | No |

### Qué tiene de mejor el tuyo y conviene incorporar después

1. **document_sections con `embedding vector(1536)`**  
   Es la base para el “cerebro” de la IA (búsqueda semántica, motor de reutilización). En 001 no hay embeddings; en una **segunda migración** se puede añadir pgvector y esta tabla (o unificar con `sections` si quieres una sola fuente de verdad).

2. **documents** unificada con `type`  
   Un solo modelo para bases de convocatoria, memoria técnica y propuestas previas es más escalable. Se puede añadir en una 002 o mantener `convocatoria_bases` para “bases” y añadir `documents` solo para “propuestas previas” y memoria si lo prefieres.

3. **requirements** con `description` y **source_fragment_id**  
   Muy útil para trazabilidad (qué requisito viene de qué fragmento del documento). Se puede añadir a `checklist_items` en una migración (columnas opcionales).

4. **projects.description** y **projects.deadline**  
   Son útiles; se pueden añadir a la tabla `projects` en una 002 sin romper nada.

### Error en tu SQL

- `create extension if admin vector` es incorrecto.  
- La extensión para vectores en Supabase es **pgvector**, y se habilita con:
  ```sql
  CREATE EXTENSION IF NOT EXISTS vector;
  ```
  En 001 no está porque no usamos embeddings aún; en la migración que añada IA (embedding) habrá que poner esta línea.

---

## Resumen

- **Para crear las tablas ahora y que login/dashboard funcionen:**  
  Ejecuta en el SQL Editor de Supabase: **`supabase/migrations/001_initial_schema.sql`**.

- **Tu `creacion-de-tablas.sql`:**  
  No usarlo tal cual (error en la extensión, RLS incompleto, sin profiles/trigger).  
  Sus ideas (documents, document_sections con embedding, requirements con source_fragment_id, description/deadline en projects) se pueden llevar a una **002_embedding_and_documents.sql** cuando avances con la Etapa 3 (IA y reutilización).

---

## Estructura del proyecto: EXTRUCTURA.md vs lo implementado

- **Rutas:**  
  La app usa **`app/` en la raíz** (no `src/app/`). Ambas son válidas en Next.js; la raíz es la más habitual con `create-next-app`.

- **Auth:**  
  Se ha añadido **`app/auth/callback/route.ts`** como en tu EXTRUCTURA (auth-callback).  
  Sirve para:
  - Confirmación de email (link que Supabase redirige con `?code=...`).
  - OAuth (Google, etc.) si lo activas.

- **Configuración en Supabase:**  
  En **Authentication → URL Configuration** añade en “Redirect URLs”:
  - `http://localhost:3000/auth/callback` (desarrollo)
  - Y tu URL de producción cuando la tengas.

- **Middleware vs proxy:**  
  Tu doc menciona **proxy.ts** (nuevo estándar en Next.js 16).  
  La app sigue usando **middleware.ts** (sigue funcionando; Next.js muestra aviso de deprecación).  
  Cuando quieras migrar a proxy, se puede sustituir por la convención `proxy.ts` y `getClaims()` según la doc de Supabase.

- **Carpetas que tienes en EXTRUCTURA y están (o estarán) en el proyecto:**  
  - `(auth)/login`, `(auth)/signup` ✅  
  - `auth/callback` ✅ (recién añadido)  
  - `(dashboard)/layout`, `page`, `projects/[id]`, `projects/new` ✅  
  - `lib/supabase/client.ts`, `server.ts` ✅  
  - `lib/ai/` y `context.ts` → para Etapa 3 (IA).  
  - `types/` → actualmente los tipos están en `lib/types.ts`; se puede mover a `types/` si prefieres.
</file>

<file path="docs/EXTRUCTURA.md">
Estructura de Archivos Inicial (Next.js 16.1 + App Router)
Esta estructura aprovecha la estabilidad de Turbopack y el nuevo estándar proxy.ts para gestionar la autenticación y seguridad en la frontera de la aplicación.

begitality/
├── src/
│ ├── app/
│ │ ├── (auth)/ # Grupo de rutas para login/registro
│ │ │ ├── login/page.tsx
│ │ │ └── auth-callback/route.ts
│ │ ├── (dashboard)/ # Layout principal con Sidebar
│ │ │ ├── layout.tsx # Contiene la barra lateral de Squaads
│ │ │ ├── page.tsx # Dashboard principal con métricas
│ │ │ └── projects/ # Gestión de expedientes aislados
│ │ │ ├── [id]/page.tsx
│ │ │ └── new/page.tsx
│ │ ├── proxy.ts # Frontera de red (sustituye middleware.ts)  
│ │ ├── layout.tsx # Root Layout con Radix Theme Provider
│ │ └── globals.css # Tailwind + Material Minimal  
│ ├── components/
│ │ ├── ui/ # Componentes de Radix UI (Atomic Design)  
│ │ │ ├── button.tsx
│ │ │ ├── sidebar.tsx
│ │ │ └── card.tsx
│ │ └── shared/ # Componentes de negocio reutilizables
│ ├── lib/
│ │ ├── supabase/ # Configuración SSR  
│ │ │ ├── client.ts # createBrowserClient
│ │ │ └── server.ts # createServerClient
│ │ └── ai/ # Capa de integración con Gemini/Anthropic
│ │ └── context.ts # Lógica de inyección de contexto
│ └── types/ # Definiciones de TypeScript
├── supabase/ # Migraciones y Seed data
│ └── migrations/
├── tailwind.config.ts # Tokens de diseño Squaads
└── next.config.ts # Habilitación de Turbopack y Cache Components
</file>

<file path="docs/PRODUCCION.md">
# Begitality – Pasos para producción

Este documento describe la configuración necesaria para llevar a producción: **Edge Functions** (IA), **exportación PDF/DOCX** y **pgvector** (motor de reutilización semántico).

---

## Cómo configurar Secrets y desplegar Edge Functions en Supabase

### Opción A: Desde el Dashboard (sin CLI)

1. **Entra en tu proyecto**
   - [supabase.com/dashboard](https://supabase.com/dashboard) → selecciona el proyecto de Begitality.

2. **Añadir secrets**
   - Menú izquierdo: **Project Settings** (icono de engranaje).
   - En el menú de la izquierda de Settings: **Edge Functions**.
   - Pestaña **Secrets**.
   - Pulsa **Add new secret** y crea:
     - **Name:** `GEMINI_API_KEY`  
       **Value:** tu API key de Gemini (por ejemplo desde [aistudio.google.com](https://aistudio.google.com) o Google Cloud).
     - (Opcional) **Name:** `ANTHROPIC_API_KEY`  
       **Value:** tu API key de Anthropic (para usar Claude).

3. **Desplegar las funciones desde la CLI** (necesaria para el deploy)
   - Las Edge Functions no se despliegan desde el Dashboard; hace falta la **Supabase CLI** (ver Opción B).  
   - Si no quieres usar CLI, puedes usar **Supabase Dashboard** → **Edge Functions** → **Deploy** si tu proyecto muestra esa opción; en muchos proyectos el deploy se hace solo por CLI.

### Opción B: Con Supabase CLI (recomendado para desplegar)

1. **Instalar Supabase CLI**
   - Con Homebrew (Mac): `brew install supabase/tap/supabase`
   - Con npm: `npm install -g supabase`
   - O descarga desde [github.com/supabase/cli/releases](https://github.com/supabase/cli/releases)

2. **Iniciar sesión**
   ```bash
   supabase login
   ```
   Se abrirá el navegador para autenticarte.

3. **Vincular el proyecto a tu carpeta**
   - En el Dashboard: **Project Settings** → **General** → **Reference ID** (es el ID del proyecto).
   ```bash
   cd /ruta/a/begitality-proyect-Subv
   supabase link --project-ref TU_PROJECT_REF
   ```
   Te pedirá la **database password** del proyecto (la que definiste al crear el proyecto).

4. **Configurar los secrets**
   ```bash
   supabase secrets set GEMINI_API_KEY=tu_clave_gemini_aqui
   supabase secrets set ANTHROPIC_API_KEY=tu_clave_anthropic_aqui   # opcional
   ```
   Para ver los secrets (solo nombres, no valores):
   ```bash
   supabase secrets list
   ```

5. **Desplegar las funciones**
   ```bash
   supabase functions deploy ai-chat
   supabase functions deploy ai-embed
   ```
   Si quieres desplegar las dos a la vez:
   ```bash
   supabase functions deploy ai-chat && supabase functions deploy ai-embed
   ```

6. **Comprobar**
   - Dashboard → **Edge Functions**: deberías ver `ai-chat` y `ai-embed` con estado “Deployed”.
   - La URL de cada una será:  
     `https://TU_PROJECT_REF.supabase.co/functions/v1/ai-chat`  
     `https://TU_PROJECT_REF.supabase.co/functions/v1/ai-embed`

### Resumen rápido (solo comandos)

```bash
# 1. Login (una vez)
supabase login

# 2. En la carpeta del proyecto, vincular
supabase link --project-ref TU_PROJECT_REF

# 3. Secrets (sustituir por tus keys reales)
supabase secrets set GEMINI_API_KEY=...
supabase secrets set ANTHROPIC_API_KEY=...   # opcional

# 4. Desplegar
supabase functions deploy ai-chat
supabase functions deploy ai-embed
```

---

## 1. Backend real: Supabase Edge Functions (Gemini / Anthropic)

Las llamadas a IA se hacen desde el servidor (Edge Functions) para no exponer API keys en el cliente.

### Funciones disponibles

| Función      | Ruta (relativa al proyecto)            | Uso                                                            |
| ------------ | -------------------------------------- | -------------------------------------------------------------- |
| **ai-chat**  | `supabase/functions/ai-chat/index.ts`  | Chat con contexto de proyecto (Gemini o Anthropic).            |
| **ai-embed** | `supabase/functions/ai-embed/index.ts` | Generar embeddings (Gemini) para indexar y búsqueda semántica. |

### Secrets en Supabase

Configura los secrets en el dashboard o con la CLI:

```bash
# Con Supabase CLI (desde la raíz del proyecto)
supabase secrets set GEMINI_API_KEY=sk-...
supabase secrets set ANTHROPIC_API_KEY=sk-ant-...
```

O en **Supabase Dashboard** → **Project Settings** → **Edge Functions** → **Secrets**:

- `GEMINI_API_KEY`: clave de API de Gemini (chat y embeddings).

- `ANTHROPIC_API_KEY`: clave de API de Anthropic (opcional; si no está, usa solo Gemini).

### Despliegue de las funciones

```bash
supabase functions deploy ai-chat
supabase functions deploy ai-embed
```

### Uso desde el cliente (Next.js)

El cliente debe enviar el JWT de Supabase en `Authorization: Bearer <session.access_token>`.

**ai-chat** (POST):

```ts
const {
  data: { session },
} = await supabase.auth.getSession();
const res = await fetch(
  `${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/ai-chat`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${session?.access_token ?? ''}`,
    },
    body: JSON.stringify({
      messages: [{ role: 'user', content: 'Redacta el resumen ejecutivo...' }],
      projectContext: 'Convocatoria ICEX 2024. Proyecto X.',
      provider: 'Gemini', // o "anthropic"
      model: 'gpt-4o-mini', // opcional
    }),
  },
);
const { content } = await res.json();
```

**ai-embed** (POST):

```ts
const res = await fetch(
  `${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/ai-embed`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${session?.access_token}`,
    },
    body: JSON.stringify({
      input: 'Texto a convertir en embedding', // o array de strings
      model: 'text-embedding-3-small',
    }),
  },
);
const { embeddings } = await res.json(); // number[] o number[][]
```

---

## 2. Exportación real: PDF y DOCX en el servidor

La generación de binarios se hace en **Next.js** (Node.js), no en Edge, usando **pdf-lib** y **docx**.

### Dependencias

Ya están en `package.json`:

- `pdf-lib`: generación de PDF (compatible con Turbopack/Next.js).
- `docx`: generación de .docx.

Instalación:

```bash
npm install
```

### API de exportación

**POST** `/api/export`

- **Body:** `{ "projectId": "uuid", "format": "pdf" | "docx" }`
- **Auth:** cookies de sesión Supabase (misma sesión que la app).
- **Respuesta:** archivo binario (PDF o DOCX) con `Content-Disposition: attachment`.

Desde el cliente (ya integrado en `ExportView`):

```ts
const res = await fetch('/api/export', {
  method: 'POST',
  credentials: 'include',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ projectId: project.id, format: 'pdf' }),
});
const blob = await res.blob();
// Descargar con createObjectURL + <a download>
```

No hace falta configurar variables de entorno adicionales para export; la autenticación es la sesión de la app.

---

## 3. Motor de reutilización semántico (pgvector + embeddings)

### Migración en Supabase

Ejecutar **después** de `001_initial_schema.sql`:

```sql
-- Contenido de supabase/migrations/002_pgvector_embeddings.sql
```

En **SQL Editor** de Supabase: pegar y ejecutar el contenido de `supabase/migrations/002_pgvector_embeddings.sql`.

Esto:

- Habilita la extensión **vector**.
- Crea la tabla **document_embeddings** (fragmentos de texto + `embedding vector(1536)`).
- Crea el índice HNSW para búsqueda por similitud.
- Crea la función **match_embeddings(project_id, query_embedding, match_count, match_threshold)**.

### Flujo típico

1. **Indexar:**
   - Trocear documentos (convocatoria, secciones, propuestas previas).
   - Llamar a **ai-embed** con cada trozo.
   - Insertar en `document_embeddings` con `project_id`, `source_type`, `source_id`, `content`, `embedding`.

2. **Buscar reutilización:**
   - El usuario escribe una consulta (ej. “presupuesto y viabilidad”).
   - Llamar a **ai-embed** con esa consulta → `query_embedding`.
   - En Supabase (desde el cliente o desde una Edge Function):
     ```ts
     const { data } = await supabase.rpc('match_embeddings', {
       p_project_id: projectId,
       p_query_embedding: queryEmbedding,
       p_match_count: 5,
       p_match_threshold: 0.7,
     });
     ```
   - Usar los `content` devueltos como contexto para **ai-chat** (redacción o reutilización).

### Dimensiones del embedding

Gemini **text-embedding-3-small** devuelve **1536** dimensiones, que coincide con la columna `vector(1536)` en la migración. Si cambias de modelo, ajusta la migración y la tabla.

---

## Resumen de comprobaciones

| Componente         | Comprobar                                                                                                                                         |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Edge Functions** | Secrets `GEMINI_API_KEY` y opcionalmente `ANTHROPIC_API_KEY`; despliegue de `ai-chat` y `ai-embed`; llamadas con `Authorization: Bearer <token>`. |
| **Exportación**    | `npm install` (pdfkit, docx); POST `/api/export` con `projectId` y `format`; sesión de Supabase en cookies.                                       |
| **pgvector**       | Ejecutar `002_pgvector_embeddings.sql`; indexar con **ai-embed** e insertar en `document_embeddings`; búsqueda con `match_embeddings`.            |

Si quieres, el siguiente paso puede ser implementar en la UI el flujo completo: **indexar** al cargar bases, **buscar** en el asistente y **redactar** con **ai-chat** usando el contexto devuelto por `match_embeddings`.
</file>

<file path="lib/export/docx.ts">
import {
  Document,
  Packer,
  Paragraph,
  TextRun,
  HeadingLevel,
  AlignmentType,
} from "docx";

export interface DocxSection {
  title: string;
  content: string;
}

export interface GenerateDocxOptions {
  title: string;
  grantName: string;
  sections: DocxSection[];
}

export async function generateDocx(options: GenerateDocxOptions): Promise<Buffer> {
  const { title, grantName, sections } = options;

  const children: Paragraph[] = [
    new Paragraph({
      text: "MEMORIA TÉCNICA",
      heading: HeadingLevel.TITLE,
      alignment: AlignmentType.CENTER,
      spacing: { after: 200 },
    }),
    new Paragraph({
      children: [
        new TextRun({
          text: grantName,
          size: 22,
          color: "64748B",
        }),
      ],
      alignment: AlignmentType.CENTER,
      spacing: { after: 400 },
    }),
  ];

  for (const section of sections) {
    children.push(
      new Paragraph({
        text: section.title,
        heading: HeadingLevel.HEADING_2,
        spacing: { before: 240, after: 120 },
      }),
      new Paragraph({
        children: [
          new TextRun({
            text: section.content || "(Sin contenido)",
            size: 22,
          }),
        ],
        spacing: { after: 240 },
      })
    );
  }

  const doc = new Document({
    sections: [
      {
        properties: {},
        children,
      },
    ],
  });

  return Packer.toBuffer(doc);
}
</file>

<file path="lib/pdf-extract.ts">
import { spawn } from "node:child_process";
import fs from "node:fs";
import path from "node:path";
import os from "node:os";

/**
 * Extrae texto de un buffer PDF. Solo para uso en servidor (Node).
 * Ejecuta pdf-parse en un proceso hijo para evitar su código de prueba (ENOENT).
 */
export async function extractTextFromPdf(buffer: Buffer): Promise<string> {
  const tmpDir = os.tmpdir();
  const tmpFile = path.join(tmpDir, `pdf-extract-${Date.now()}-${Math.random().toString(36).slice(2)}.pdf`);
  try {
    fs.writeFileSync(tmpFile, buffer);
    const text = await new Promise<string>((resolve, reject) => {
      const scriptPath = path.join(process.cwd(), "scripts", "extract-pdf-text.cjs");
      const child = spawn(process.execPath, [scriptPath, tmpFile], {
        cwd: process.cwd(),
        stdio: ["ignore", "pipe", "pipe"],
      });
      let out = "";
      let err = "";
      child.stdout?.on("data", (chunk) => { out += chunk; });
      child.stderr?.on("data", (chunk) => { err += chunk; });
      child.on("close", (code) => {
        if (code === 0) resolve(out.trim());
        else reject(new Error(err || `Exit code ${code}`));
      });
      child.on("error", reject);
    });
    return text;
  } finally {
    try {
      fs.unlinkSync(tmpFile);
    } catch {
      // ignorar si no existe
    }
  }
}
</file>

<file path="lib/supabase/client.ts">
"use client";

import { createBrowserClient } from "@supabase/ssr";

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}
</file>

<file path="lib/supabase/server.ts">
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";

type CookieToSet = { name: string; value: string; options?: Record<string, unknown> };

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet: CookieToSet[]) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options ?? {})
            );
          } catch {
            // Ignore in Server Components
          }
        },
      },
    }
  );
}
</file>

<file path="lib/utils.ts">
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
</file>

<file path="middleware.ts">
import { createServerClient } from "@supabase/ssr";
import { NextResponse, type NextRequest } from "next/server";

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: { headers: request.headers },
  });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet: { name: string; value: string; options?: Record<string, unknown> }[]) {
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options ?? {})
          );
        },
      },
    }
  );

  const {
    data: { user },
  } = await supabase.auth.getUser();

  const isAuthRoute =
    request.nextUrl.pathname.startsWith("/login") ||
    request.nextUrl.pathname.startsWith("/signup");
  const isPublicRoute =
    request.nextUrl.pathname === "/" || isAuthRoute;

  if (!user && !isPublicRoute) {
    const redirect = new URL("/login", request.url);
    redirect.searchParams.set("redirect", request.nextUrl.pathname);
    return NextResponse.redirect(redirect);
  }

  if (user && isAuthRoute) {
    return NextResponse.redirect(new URL("/dashboard", request.url));
  }

  return response;
}

export const config = {
  matcher: [
    "/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)",
  ],
};
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  reactStrictMode: true,
};

export default nextConfig;
</file>

<file path="postcss.config.mjs">
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};

export default config;
</file>

<file path="scripts/extract-pdf-text.cjs">
/**
 * Script que se ejecuta en un proceso Node separado para extraer texto de un PDF.
 * Así pdf-parse tiene module.parent (este script) y no ejecuta su código de prueba.
 * Uso: node scripts/extract-pdf-text.cjs <ruta-al-pdf>
 * Salida: texto en stdout, errores en stderr.
 */
const fs = require("fs");
const path = process.argv[2];
if (!path || !fs.existsSync(path)) {
  process.stderr.write("Usage: node extract-pdf-text.cjs <path-to-pdf>\n");
  process.exit(1);
}
const pdfParse = require("pdf-parse");
const buffer = fs.readFileSync(path);
pdfParse(buffer)
  .then((data) => {
    process.stdout.write(typeof data?.text === "string" ? data.text : "");
  })
  .catch((err) => {
    process.stderr.write(err.message || String(err));
    process.exit(1);
  });
</file>

<file path="supabase/.temp/cli-latest">
v2.75.0
</file>

<file path="supabase/.temp/gotrue-version">
v2.186.0
</file>

<file path="supabase/.temp/pooler-url">
postgresql://postgres.jteblbhzyvnscatqjvhh@aws-1-eu-west-1.pooler.supabase.com:5432/postgres
</file>

<file path="supabase/.temp/postgres-version">
17.6.1.063
</file>

<file path="supabase/.temp/project-ref">
jteblbhzyvnscatqjvhh
</file>

<file path="supabase/.temp/rest-version">
v14.1
</file>

<file path="supabase/.temp/storage-migration">
fix-optimized-search-function
</file>

<file path="supabase/.temp/storage-version">
v1.37.7
</file>

<file path="supabase/functions/_shared/auth.ts">
/// <reference path="../deno.d.ts" />
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from "npm:@supabase/supabase-js@2";

export async function getAuthUser(req: Request): Promise<{ id: string; email?: string } | null> {
  const authHeader = req.headers.get("Authorization");
  if (!authHeader?.startsWith("Bearer ")) return null;
  const token = authHeader.slice(7).trim();
  const supabase = createClient(
    Deno.env.get("SUPABASE_URL") ?? "",
    Deno.env.get("SUPABASE_ANON_KEY") ?? ""
  );
  const { data, error } = await supabase.auth.getUser(token);
  if (error || !data?.user) return null;
  return { id: data.user.id, email: data.user.email };
}
</file>

<file path="supabase/functions/_shared/cors.ts">
export const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

export function jsonResponse(data: unknown, status = 200, headers = corsHeaders) {
  return new Response(JSON.stringify(data), {
    status,
    headers: { "Content-Type": "application/json", ...headers },
  });
}
</file>

<file path="supabase/functions/ai-chat/index.ts">
/// <reference path="../deno.d.ts" />
import 'jsr:@supabase/functions-js/edge-runtime.d.ts';
import { corsHeaders, jsonResponse } from '../_shared/cors.ts';
import { getAuthUser } from '../_shared/auth.ts';

interface ChatMessage {
  role: 'user' | 'assistant' | 'system';
  content: string;
}

interface Body {
  messages: ChatMessage[];
  projectContext?: string;
  provider?: 'gemini' | 'anthropic';
  model?: string;
}

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { status: 204, headers: corsHeaders });
  }

  const user = await getAuthUser(req);
  if (!user) {
    return jsonResponse({ error: 'Unauthorized' }, 401);
  }

  if (req.method !== 'POST') {
    return jsonResponse({ error: 'Method not allowed' }, 405);
  }

  let body: Body;
  try {
    body = await req.json();
  } catch {
    return jsonResponse({ error: 'Invalid JSON body' }, 400);
  }

  const { messages, projectContext, provider = 'gemini', model } = body;
  if (!Array.isArray(messages) || messages.length === 0) {
    return jsonResponse({ error: 'messages array required' }, 400);
  }

  const systemContent = projectContext
    ? `Eres un asistente experto en redacción de memorias técnicas para subvenciones. Contexto del proyecto actual:\n${projectContext}\nResponde siempre en español y mantén coherencia con este contexto.`
    : 'Eres un asistente experto en redacción de memorias técnicas para subvenciones. Responde siempre en español.';

  const geminiKey = Deno.env.get('GEMINI_API_KEY');
  const anthropicKey = Deno.env.get('ANTHROPIC_API_KEY');

  if (provider === 'anthropic') {
    if (!anthropicKey) {
      return jsonResponse({ error: 'ANTHROPIC_API_KEY not configured' }, 503);
    }
    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': anthropicKey,
          'anthropic-version': '2023-06-01',
        },
        body: JSON.stringify({
          model: model ?? 'claude-3-5-sonnet-20241022',
          max_tokens: 4096,
          system: systemContent,
          messages: messages
            .filter((m) => m.role !== 'system')
            .map((m) => ({
              role: m.role as 'user' | 'assistant',
              content: m.content,
            })),
        }),
      });
      if (!response.ok) {
        const err = await response.text();
        return jsonResponse({ error: 'Anthropic API error', detail: err }, 502);
      }
      const data = await response.json();
      const text = data.content?.[0]?.text ?? '';
      return jsonResponse({ content: text, provider: 'anthropic' });
    } catch (e) {
      return jsonResponse(
        { error: 'Anthropic request failed', detail: String(e) },
        502,
      );
    }
  }

  if (!geminiKey) {
    return jsonResponse({ error: 'GEMINI_API_KEY not configured' }, 503);
  }
  try {
    const geminiModel = model ?? 'gemini-1.5-flash';
    const contents = messages
      .filter((m) => m.role !== 'system')
      .map((m) => ({
        role: m.role === 'assistant' ? 'model' : ('user' as const),
        parts: [{ text: m.content }],
      }));
    const body: Record<string, unknown> = {
      contents,
      system_instruction: { parts: [{ text: systemContent }] },
    };
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${geminiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      },
    );
    if (!response.ok) {
      const err = await response.text();
      return jsonResponse({ error: 'Gemini API error', detail: err }, 502);
    }
    const data = await response.json();
    const text =
      data.candidates?.[0]?.content?.parts?.[0]?.text ?? '';
    return jsonResponse({ content: text, provider: 'gemini' });
  } catch (e) {
    return jsonResponse(
      { error: 'Gemini request failed', detail: String(e) },
      502,
    );
  }
});
</file>

<file path="supabase/functions/ai-embed/index.ts">
/// <reference path="../deno.d.ts" />
import 'jsr:@supabase/functions-js/edge-runtime.d.ts';
import { corsHeaders, jsonResponse } from '../_shared/cors.ts';
import { getAuthUser } from '../_shared/auth.ts';

interface Body {
  input: string | string[];
  model?: string;
}

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { status: 204, headers: corsHeaders });
  }

  const user = await getAuthUser(req);
  if (!user) {
    return jsonResponse({ error: 'Unauthorized' }, 401);
  }

  if (req.method !== 'POST') {
    return jsonResponse({ error: 'Method not allowed' }, 405);
  }

  let body: Body;
  try {
    body = await req.json();
  } catch {
    return jsonResponse({ error: 'Invalid JSON body' }, 400);
  }

  const { input, model = 'text-embedding-3-small' } = body;
  if (input == null || (Array.isArray(input) && input.length === 0)) {
    return jsonResponse({ error: 'input (string or string[]) required' }, 400);
  }

  const texts = Array.isArray(input) ? input : [input];
  const geminiKey = Deno.env.get('GEMINI_API_KEY');
  if (!geminiKey) {
    return jsonResponse({ error: 'GEMINI_API_KEY not configured' }, 503);
  }

  const embedModel = 'gemini-embedding-001';
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${embedModel}:embedContent?key=${geminiKey}`;

  try {
    const embeddings: number[][] = [];
    for (const text of texts) {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          content: { parts: [{ text }] },
        }),
      });
      if (!response.ok) {
        const err = await response.text();
        return jsonResponse(
          { error: 'Gemini embeddings error', detail: err },
          502,
        );
      }
      const data = await response.json();
      const values = (data.embedding?.values as number[]) ?? [];
      embeddings.push(values);
    }
    return jsonResponse({
      embeddings: texts.length === 1 ? embeddings[0] : embeddings,
      model: embedModel,
    });
  } catch (e) {
    return jsonResponse(
      { error: 'Embedding request failed', detail: String(e) },
      502,
    );
  }
});
</file>

<file path="supabase/functions/deno.d.ts">
/**
 * Declaraciones mínimas del global Deno para Supabase Edge Functions.
 * El runtime real es Deno; esto evita errores de TypeScript en el IDE.
 */
declare const Deno: {
  serve(handler: (req: Request) => Promise<Response> | Response): void;
  env: {
    get(key: string): string | undefined;
  };
};
</file>

<file path="supabase/migrations/001_initial_schema.sql">
-- Begitality - Esquema inicial (Etapa 1 + base para Etapa 2)
-- Ejecutar en Supabase SQL Editor o via CLI

-- Habilitar UUID
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Perfiles de usuario (extiende auth.users)
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT,
  full_name TEXT,
  avatar_url TEXT,
  plan TEXT DEFAULT 'senior_consultant' CHECK (plan IN ('starter', 'consultant', 'senior_consultant', 'enterprise')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Proyectos (espacio de trabajo por convocatoria)
CREATE TABLE public.projects (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  grant_name TEXT NOT NULL,
  grant_type TEXT,
  status TEXT DEFAULT 'draft' CHECK (status IN ('draft', 'in_progress', 'ready_export', 'exported')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Documentos "Bases" de la convocatoria (PDFs cargados)
CREATE TABLE public.convocatoria_bases (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  file_path TEXT,
  file_size BIGINT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Secciones de la memoria técnica por proyecto
CREATE TABLE public.sections (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  content TEXT DEFAULT '',
  sort_order INT DEFAULT 0,
  is_completed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Checklist dinámico por proyecto (requisitos de convocatoria)
CREATE TABLE public.checklist_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
  label TEXT NOT NULL,
  required BOOLEAN DEFAULT TRUE,
  checked BOOLEAN DEFAULT FALSE,
  sort_order INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Mensajes del asistente IA (contexto del chat por proyecto)
CREATE TABLE public.ai_messages (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS: solo el dueño puede ver/editar sus datos
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.convocatoria_bases ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sections ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.checklist_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ai_messages ENABLE ROW LEVEL SECURITY;

CREATE POLICY "profiles_select_own" ON public.profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "profiles_update_own" ON public.profiles FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "profiles_insert_own" ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "projects_all_own" ON public.projects FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "convocatoria_bases_own" ON public.convocatoria_bases FOR ALL
  USING (EXISTS (SELECT 1 FROM public.projects p WHERE p.id = convocatoria_bases.project_id AND p.user_id = auth.uid()));

CREATE POLICY "sections_own" ON public.sections FOR ALL
  USING (EXISTS (SELECT 1 FROM public.projects p WHERE p.id = sections.project_id AND p.user_id = auth.uid()));

CREATE POLICY "checklist_items_own" ON public.checklist_items FOR ALL
  USING (EXISTS (SELECT 1 FROM public.projects p WHERE p.id = checklist_items.project_id AND p.user_id = auth.uid()));

CREATE POLICY "ai_messages_own" ON public.ai_messages FOR ALL
  USING (EXISTS (SELECT 1 FROM public.projects p WHERE p.id = ai_messages.project_id AND p.user_id = auth.uid()));

-- Índices
CREATE INDEX idx_projects_user_id ON public.projects(user_id);
CREATE INDEX idx_sections_project_id ON public.sections(project_id);
CREATE INDEX idx_convocatoria_bases_project_id ON public.convocatoria_bases(project_id);
CREATE INDEX idx_ai_messages_project_id ON public.ai_messages(project_id);

-- Trigger: crear perfil al registrarse
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name)
  VALUES (NEW.id, NEW.email, COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.email));
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Storage bucket para bases y exportaciones (crear desde Dashboard o API)
-- INSERT INTO storage.buckets (id, name, public) VALUES ('convocatoria-files', 'convocatoria-files', false);
-- Políticas de storage según project_id en path o metadata.
</file>

<file path="supabase/migrations/002_pgvector_embeddings.sql">
-- Begitality - pgvector y Motor de Reutilización semántico
-- Ejecutar después de 001_initial_schema.sql

-- 1. Extensión para vectores (embedding gemini = 1536 dimensiones)
CREATE EXTENSION IF NOT EXISTS vector;

-- 2. Fragmentos de documentos indexados para búsqueda semántica
-- Cada fila = un trozo de texto (convocatoria, memoria previa, etc.) con su embedding
CREATE TABLE public.document_embeddings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
  source_type TEXT NOT NULL CHECK (source_type IN ('convocatoria_basis', 'section', 'previous_proposal')),
  source_id UUID NOT NULL,
  content TEXT NOT NULL,
  embedding vector(1536) NOT NULL,
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS
ALTER TABLE public.document_embeddings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "document_embeddings_own" ON public.document_embeddings FOR ALL
  USING (
    EXISTS (SELECT 1 FROM public.projects p WHERE p.id = document_embeddings.project_id AND p.user_id = auth.uid())
  );

-- Índice para búsqueda por proximidad (IVFFlat o HNSW)
-- HNSW suele dar mejor recall; opcionalmente ajustar m y ef_construction
CREATE INDEX idx_document_embeddings_embedding ON public.document_embeddings
  USING hnsw (embedding vector_cosine_ops)
  WITH (m = 16, ef_construction = 64);

CREATE INDEX idx_document_embeddings_project_id ON public.document_embeddings(project_id);
CREATE INDEX idx_document_embeddings_source ON public.document_embeddings(project_id, source_type, source_id);

-- 3. Función RPC: búsqueda semántica por similitud de coseno
-- Devuelve los fragmentos más similares al embedding de la consulta (para inyectar como contexto en la IA)
CREATE OR REPLACE FUNCTION public.match_embeddings(
  p_project_id UUID,
  p_query_embedding vector(1536),
  p_match_count INT DEFAULT 5,
  p_match_threshold FLOAT DEFAULT 0.7
)
RETURNS TABLE (
  id UUID,
  source_type TEXT,
  source_id UUID,
  content TEXT,
  similarity FLOAT,
  metadata JSONB
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  -- Solo proyectos del usuario (seguridad aunque la función sea DEFINER)
  IF NOT EXISTS (SELECT 1 FROM public.projects p WHERE p.id = p_project_id AND p.user_id = auth.uid()) THEN
    RETURN;
  END IF;
  RETURN QUERY
  SELECT
    de.id,
    de.source_type,
    de.source_id,
    de.content,
    1 - (de.embedding <=> p_query_embedding)::float AS similarity,
    de.metadata
  FROM public.document_embeddings de
  WHERE de.project_id = p_project_id
    AND (1 - (de.embedding <=> p_query_embedding)) >= p_match_threshold
  ORDER BY de.embedding <=> p_query_embedding
  LIMIT p_match_count;
END;
$$;

-- Permiso para que el usuario autenticado solo consulte embeddings de sus proyectos (RLS en la tabla ya lo asegura; la función es DEFINER)
GRANT EXECUTE ON FUNCTION public.match_embeddings(UUID, vector(1536), INT, FLOAT) TO authenticated;
GRANT EXECUTE ON FUNCTION public.match_embeddings(UUID, vector(1536), INT, FLOAT) TO service_role;
</file>

<file path="supabase/migrations/003_storage_convocatoria.sql">
-- Bucket para PDFs de bases de convocatoria (privado)
INSERT INTO storage.buckets (id, name, public)
VALUES ('convocatoria-files', 'convocatoria-files', false)
ON CONFLICT (id) DO NOTHING;

-- Ruta esperada en el bucket: {user_id}/{project_id}/{filename}
-- Solo el dueño puede subir en su carpeta
CREATE POLICY "Users can upload to own folder"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'convocatoria-files'
  AND (storage.foldername(name))[1] = auth.uid()::text
);

-- Solo el dueño puede leer sus archivos
CREATE POLICY "Users can read own files"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'convocatoria-files'
  AND (storage.foldername(name))[1] = auth.uid()::text
);

-- Solo el dueño puede borrar sus archivos
CREATE POLICY "Users can delete own files"
ON storage.objects FOR DELETE
TO authenticated
USING (
  bucket_id = 'convocatoria-files'
  AND (storage.foldername(name))[1] = auth.uid()::text
);
</file>

<file path="supabase/migrations/004_clients_management.sql">
-- Begitality - Gestión de Clientes (Etapa 2.5)

-- Tabla de Clientes
CREATE TABLE IF NOT EXISTS public.clients (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  tax_id TEXT, -- CIF/NIF
  contact_email TEXT,
  contact_phone TEXT,
  industry TEXT,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Relacionar Proyectos con Clientes
ALTER TABLE public.projects ADD COLUMN IF NOT EXISTS client_id UUID REFERENCES public.clients(id) ON DELETE SET NULL;

-- RLS para Clientes
ALTER TABLE public.clients ENABLE ROW LEVEL SECURITY;

CREATE POLICY "clients_all_own" ON public.clients FOR ALL
  USING (auth.uid() = user_id);

-- Índice para mejorar búsquedas
CREATE INDEX IF NOT EXISTS idx_clients_user_id ON public.clients(user_id);
CREATE INDEX IF NOT EXISTS idx_projects_client_id ON public.projects(client_id);
</file>

<file path="supabase/migrations/005_clients_soft_delete.sql">
-- Begitality - Soft Delete y Mejoras de Clientes

-- Añadir columna status a clients
ALTER TABLE public.clients ADD COLUMN IF NOT EXISTS status TEXT DEFAULT 'active' CHECK (status IN ('active', 'archived'));

-- Actualizar la política RLS para permitir ver archivados pero filtrar por defecto en la app
DROP POLICY IF EXISTS "clients_all_own" ON public.clients;
CREATE POLICY "clients_all_own" ON public.clients FOR ALL
  USING (auth.uid() = user_id);
</file>

<file path="supabase/migrations/006_projects_archiving.sql">
-- Begitality - Soporte para archivado de proyectos

-- Actualizar la restricción de check para incluir 'archived'
ALTER TABLE public.projects DROP CONSTRAINT IF EXISTS projects_status_check;
ALTER TABLE public.projects ADD CONSTRAINT projects_status_check 
  CHECK (status IN ('draft', 'in_progress', 'ready_export', 'exported', 'archived'));

-- Índice para mejorar el filtrado de proyectos activos vs archivados
CREATE INDEX IF NOT EXISTS idx_projects_status ON public.projects(status);
</file>

<file path="supabase/migrations/007_chat_per_section.sql">
-- Begitality - Chat por Sección

-- Añadir section_id a ai_messages para hilos independientes
ALTER TABLE public.ai_messages ADD COLUMN IF NOT EXISTS section_id UUID REFERENCES public.sections(id) ON DELETE CASCADE;

-- Índice para mejorar la carga del chat
CREATE INDEX IF NOT EXISTS idx_ai_messages_section_id ON public.ai_messages(section_id);
</file>

<file path="supabase/migrations/008_audit_persistence.sql">
-- Begitality V4 - Auditoría y Persistencia

-- Campos para guardar los informes de IA
ALTER TABLE public.projects ADD COLUMN IF NOT EXISTS viability_report TEXT;
ALTER TABLE public.projects ADD COLUMN IF NOT EXISTS review_report TEXT;
ALTER TABLE public.projects ADD COLUMN IF NOT EXISTS success_score INTEGER DEFAULT 0;

-- Índice para ordenar por puntuación en el histórico
CREATE INDEX IF NOT EXISTS idx_projects_score ON public.projects(success_score);
</file>

<file path="supabase/migrations/009_client_sequentials.sql">
-- Begitality - Número de Cliente Secuencial

-- Crear una secuencia para los clientes
CREATE SEQUENCE IF NOT EXISTS client_number_seq;

-- Añadir la columna client_code a la tabla clients
ALTER TABLE public.clients ADD COLUMN IF NOT EXISTS client_code TEXT UNIQUE;

-- Función para generar el código automáticamente (ej: CL-0001)
CREATE OR REPLACE FUNCTION public.set_client_code()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.client_code IS NULL THEN
    NEW.client_code := 'CL-' || LPAD(nextval('client_number_seq')::text, 4, '0');
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger para asignar el código al insertar
DROP TRIGGER IF EXISTS tr_set_client_code ON public.clients;
CREATE TRIGGER tr_set_client_code
BEFORE INSERT ON public.clients
FOR EACH ROW EXECUTE FUNCTION public.set_client_code();
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
  darkMode: "class",
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      fontFamily: {
        sans: ["var(--font-geist-sans)", "system-ui", "sans-serif"],
        mono: ["var(--font-geist-mono)", "monospace"],
      },
      colors: {
        begitality: {
          primary: "var(--begitality-primary)",
          muted: "var(--begitality-muted)",
        },
      },
      animation: {
        "fade-in": "fadeIn 0.5s ease-out",
        "slide-in": "slideIn 0.4s ease-out",
      },
      keyframes: {
        fadeIn: { from: { opacity: "0" }, to: { opacity: "1" } },
        slideIn: { from: { opacity: "0", transform: "translateY(8px)" }, to: { opacity: "1", transform: "translateY(0)" } },
      },
    },
  },
  plugins: [],
};

export default config;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules",
    "supabase/functions"
  ]
}
</file>

<file path="app/api/export/route.ts">
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

export type ExportFormat = "pdf" | "docx";

export async function POST(req: Request) {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  let body: { projectId: string; format: ExportFormat };
  try {
    body = await req.json();
  } catch {
    return NextResponse.json({ error: "Invalid JSON" }, { status: 400 });
  }

  const { projectId, format } = body;
  if (!projectId || !format || !["pdf", "docx"].includes(format)) {
    return NextResponse.json(
      { error: "projectId and format (pdf|docx) required" },
      { status: 400 }
    );
  }

  const { data: project } = await supabase
    .from("projects")
    .select("id, name, grant_name, viability_report, review_report")
    .eq("id", projectId)
    .eq("user_id", user.id)
    .single();

  if (!project) {
    return NextResponse.json({ error: "Project not found" }, { status: 404 });
  }

  const { data: sections } = await supabase
    .from("sections")
    .select("id, title, content, sort_order")
    .eq("project_id", projectId)
    .order("sort_order");

  const sectionsList = sections ?? [];

  if (format === "pdf") {
    const { generatePdf } = await import("@/lib/export/pdf");
    const buffer = await generatePdf({
      title: project.name,
      grantName: project.grant_name,
      viabilityReport: project.viability_report,
      reviewReport: project.review_report,
      sections: sectionsList.map((s) => ({ title: s.title, content: s.content })),
    });
    const filename = `Memoria_Tecnica_${project.name.replace(/\s+/g, "_")}.pdf`;

    // Marcar como exportado (Histórico)
    await supabase
      .from("projects")
      .update({ status: "exported" })
      .eq("id", projectId);

    return new NextResponse(new Uint8Array(buffer), {
      status: 200,
      headers: {
        "Content-Type": "application/pdf",
        "Content-Disposition": `attachment; filename="${filename}"`,
      },
    });
  }

  if (format === "docx") {
    const { generateDocx } = await import("@/lib/export/docx");
    const buffer = await generateDocx({
      title: project.name,
      grantName: project.grant_name,
      sections: sectionsList.map((s) => ({ title: s.title, content: s.content })),
    });
    const filename = `Memoria_Tecnica_${project.name.replace(/\s+/g, "_")}.docx`;
    return new NextResponse(new Uint8Array(buffer), {
      status: 200,
      headers: {
        "Content-Type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        "Content-Disposition": `attachment; filename="${filename}"`,
      },
    });
  }

  return NextResponse.json({ error: "Unsupported format" }, { status: 400 });
}
</file>

<file path="app/dashboard/clients/[id]/page.tsx">
"use client";

import { useEffect, useState, useCallback, use, useMemo } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { 
  ArrowLeft, Building2, Mail, Phone, Briefcase, Info, 
  Edit3, Trash2, Save, X, FileText, ChevronRight, Plus,
  Archive, RotateCcw, Link2, Loader2, CheckCircle2,
  Search, Target, Award, Clock, FileCheck, Layers,
  BarChart3, Activity
} from "lucide-react";
import { createClient } from "@/lib/supabase/client";
import { Client, Project } from "@/lib/types";
import * as Label from "@radix-ui/react-label";
import * as Dialog from "@radix-ui/react-dialog";
import * as Tabs from "@radix-ui/react-tabs";
import { cn } from "@/lib/utils";

export default function ClientDetailsPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params);
  const [client, setClient] = useState<Client | any>(null);
  const [projects, setProjects] = useState<any[]>([]);
  const [availableProjects, setAvailableProjects] = useState<Project[]>([]);
  const [isEditing, setIsEditing] = useState(false);
  const [isLinking, setIsLinking] = useState(false);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState("active");
  const [projectSearch, setProjectSearch] = useState("");
  
  const [formData, setFormData] = useState({
    name: "",
    tax_id: "",
    contact_email: "",
    contact_phone: "",
    industry: "",
    notes: ""
  });

  const router = useRouter();
  const supabase = createClient();

  const loadData = useCallback(async () => {
    setLoading(true);
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const [clientRes, projectsRes, availableRes] = await Promise.all([
      supabase.from("clients").select("*").eq("id", id).single(),
      supabase.from("projects").select("*").eq("client_id", id).order("updated_at", { ascending: false }),
      supabase.from("projects").select("*").is("client_id", null).eq("user_id", user.id)
    ]);

    if (clientRes.error) {
      setError(clientRes.error.message);
    } else {
      setClient(clientRes.data);
      setFormData({
        name: clientRes.data.name,
        tax_id: clientRes.data.tax_id || "",
        contact_email: clientRes.data.contact_email || "",
        contact_phone: clientRes.data.contact_phone || "",
        industry: clientRes.data.industry || "",
        notes: clientRes.data.notes || ""
      });
    }

    if (projectsRes.data) setProjects(projectsRes.data);
    if (availableRes.data) setAvailableProjects(availableRes.data);
    setLoading(false);
  }, [id, supabase]);

  useEffect(() => { loadData(); }, [loadData]);

  const handleUpdate = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    const { error: err } = await supabase.from("clients").update({ name: formData.name, tax_id: formData.tax_id || null, contact_email: formData.contact_email || null, contact_phone: formData.contact_phone || null, industry: formData.industry || null, notes: formData.notes || null, }).eq("id", id);
    if (err) setError(err.message);
    else { setIsEditing(false); loadData(); }
    setSaving(false);
  };

  const handleArchive = async () => {
    const nextStatus = client.status === 'archived' ? 'active' : 'archived';
    if (!confirm(nextStatus === 'archived' ? "¿Archivar?" : "¿Restaurar?")) return;
    const { error: err } = await supabase.from("clients").update({ status: nextStatus }).eq("id", id);
    if (err) setError(err.message); else loadData();
  };

  const linkProject = async (projectId: string) => {
    const { error: err } = await supabase.from("projects").update({ client_id: id }).eq("id", projectId);
    if (err) setError(err.message); else { setIsLinking(false); loadData(); }
  };

  const filteredProjects = useMemo(() => {
    return projects.filter(p => {
      const matchesTab = activeTab === "active" ? p.status !== "archived" : p.status === "archived";
      const matchesSearch = p.name.toLowerCase().includes(projectSearch.toLowerCase()) || p.grant_name.toLowerCase().includes(projectSearch.toLowerCase());
      return matchesTab && matchesSearch;
    });
  }, [projects, activeTab, projectSearch]);

  const stats = useMemo(() => ({
    active: projects.filter(p => p.status !== 'archived').length,
    archived: projects.filter(p => p.status === 'archived').length
  }), [projects]);

  if (loading) return <div className="flex justify-center py-20"><Loader2 className="animate-spin text-blue-600" /></div>;
  if (!client) return <div className="text-center py-20 text-slate-500">Cliente no encontrado</div>;

  return (
    <div className="max-w-5xl mx-auto space-y-10 animate-in fade-in duration-700 pb-20">
      
      {/* HEADER PREMIUM */}
      <header className="flex flex-col md:flex-row justify-between items-start md:items-center bg-white border border-slate-200 p-8 rounded-[3rem] shadow-sm gap-6">
        <div className="flex items-center gap-6">
          <Link href="/dashboard/clients" className="p-4 bg-slate-50 hover:bg-white rounded-2xl border border-slate-100 transition-all shadow-sm group">
            <ArrowLeft size={20} className="text-slate-400 group-hover:text-blue-600 transition-colors" />
          </Link>
          <div>
            <div className="flex items-center gap-3">
              <h1 className="text-4xl font-black text-slate-900 tracking-tighter leading-none">{client.name}</h1>
              {client.status === 'archived' && <span className="bg-amber-100 text-amber-700 text-[10px] font-black px-3 py-1 rounded-lg uppercase tracking-widest">Archivado</span>}
            </div>
            <div className="flex items-center gap-4 mt-3">
              <span className="text-[10px] font-black text-blue-600 uppercase tracking-[0.2em] bg-blue-50 px-3 py-1 rounded-full">{client.tax_id || "ID PENDIENTE"}</span>
              <span className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2">
                <Clock size={12} /> Miembro desde {new Date(client.created_at).getFullYear()}
              </span>
            </div>
          </div>
        </div>
        <div className="flex gap-3">
          {!isEditing ? (
            <>
              <button onClick={() => setIsEditing(true)} className="flex items-center gap-2 px-6 py-3 bg-white border border-slate-200 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:border-blue-600 hover:text-blue-600 transition-all shadow-sm"><Edit3 size={16} /> Editar Perfil</button>
              <button onClick={handleArchive} className={cn("p-3.5 rounded-2xl border transition-all", client.status === 'archived' ? "bg-blue-50 border-blue-100 text-blue-600" : "bg-white border-slate-200 text-slate-300 hover:text-amber-600")}>{client.status === 'archived' ? <RotateCcw size={20} /> : <Archive size={20} />}</button>
            </>
          ) : (
            <div className="flex gap-2">
              <button form="client-form" type="submit" disabled={saving} className="flex items-center gap-3 px-8 py-3 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-600 shadow-xl transition-all">{saving ? <Loader2 size={16} className="animate-spin" /> : <Save size={16} />} Guardar</button>
              <button onClick={() => setIsEditing(false)} className="px-6 py-3 bg-slate-100 text-slate-600 rounded-2xl font-black text-[10px] uppercase tracking-widest">Cancelar</button>
            </div>
          )}
        </div>
      </header>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
        {/* COLUMNA IZQUIERDA: RESUMEN TÉCNICO */}
        <div className="lg:col-span-4 space-y-6">
          <div className="bg-white border border-slate-200 rounded-[2.5rem] p-10 shadow-sm">
            <form id="client-form" onSubmit={handleUpdate} className="space-y-10">
              <div className="flex items-center gap-3 border-b border-slate-100 pb-6">
                <div className="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600"><Info size={20} /></div>
                <span className="text-[11px] font-black text-slate-900 uppercase tracking-widest">Información Maestra</span>
              </div>
              
              <div className="space-y-6">
                {isEditing && (
                  <div className="space-y-2">
                    <Label.Root className="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Razón Social</Label.Root>
                    <input value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold outline-none focus:ring-4 focus:ring-blue-500/5 focus:border-blue-500 transition-all" required />
                  </div>
                )}
                {[ { label: "Identificación Fiscal", key: "tax_id" }, { label: "Sector de Negocio", key: "industry" }, { label: "Canal Email", key: "contact_email", type: "email" }, { label: "Contacto Telefónico", key: "contact_phone" } ].map((field) => (
                  <div key={field.key} className="space-y-2">
                    <Label.Root className="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">{field.label}</Label.Root>
                    {isEditing ? (
                      <input type={field.type || "text"} value={(formData as any)[field.key]} onChange={(e) => setFormData({...formData, [field.key]: e.target.value})} className="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold outline-none focus:ring-4 focus:ring-blue-500/5 focus:border-blue-500 transition-all" />
                    ) : (
                      <p className="font-bold text-slate-900 bg-slate-50/30 px-5 py-4 rounded-2xl border border-slate-100/50">{(client as any)[field.key] || "—"}</p>
                    )}
                  </div>
                ))}
                <div className="space-y-2">
                  <Label.Root className="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Observaciones</Label.Root>
                  {isEditing ? (
                    <textarea value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} rows={4} className="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold outline-none focus:ring-4 focus:ring-blue-500/5 focus:border-blue-500 transition-all resize-none" />
                  ) : (
                    <div className="text-xs text-slate-500 font-medium italic bg-slate-50/30 p-5 rounded-2xl border border-slate-100/50 leading-relaxed">{client.notes || "Sin especificaciones técnicas."}</div>
                  )}
                </div>
              </div>
            </form>
          </div>
        </div>

        {/* COLUMNA DERECHA: DASHBOARD DE PROYECTOS */}
        <div className="lg:col-span-8 space-y-8">
          
          {/* TOOLBAR INTEGRADA */}
          <div className="flex flex-col sm:flex-row items-center justify-between gap-6 bg-white border border-slate-200 p-4 rounded-3xl shadow-sm">
            <Tabs.Root value={activeTab} onValueChange={setActiveTab} className="w-full sm:w-auto">
              <Tabs.List className="flex gap-1 p-1 bg-slate-50 rounded-2xl w-fit border border-slate-100">
                <Tabs.Trigger value="active" className={cn("px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all", activeTab === "active" ? "bg-white text-blue-600 shadow-sm" : "text-slate-400 hover:text-slate-600")}>Activos <span className="ml-2 opacity-40">{stats.active}</span></Tabs.Trigger>
                <Tabs.Trigger value="archived" className={cn("px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all", activeTab === "archived" ? "bg-white text-amber-600 shadow-sm" : "text-slate-400 hover:text-slate-600")}>Histórico <span className="ml-2 opacity-40">{stats.archived}</span></Tabs.Trigger>
              </Tabs.List>
            </Tabs.Root>

            <div className="flex items-center gap-3 w-full sm:w-auto">
              <div className="relative flex-1 sm:w-64 group">
                <Search size={14} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-500 transition-colors" />
                <input placeholder="Buscar memoria..." value={projectSearch} onChange={(e) => setProjectSearch(e.target.value)} className="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-100 rounded-2xl text-[11px] font-bold outline-none focus:ring-4 focus:ring-blue-500/5 focus:border-blue-500 transition-all shadow-inner" />
              </div>
              <Link href={`/dashboard/projects/new?clientId=${id}`} className="p-3 bg-blue-600 text-white rounded-2xl shadow-lg shadow-blue-600/20 hover:bg-blue-500 transition-all active:scale-95"><Plus size={20} /></Link>
            </div>
          </div>

          {/* GRID DE PROYECTOS */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-in slide-in-from-bottom-4 duration-700">
            {filteredProjects.length === 0 ? (
              <div className="col-span-full py-24 text-center bg-white border border-slate-100 border-dashed rounded-[3rem]">
                <Activity size={48} className="mx-auto text-slate-100 mb-4" />
                <p className="text-slate-400 font-black text-xs uppercase tracking-widest">Sin coincidencias detectadas</p>
              </div>
            ) : (
              filteredProjects.map((p) => (
                <Link key={p.id} href={`/dashboard/projects/${p.id}`} className={cn("group bg-white border border-slate-100 rounded-[2.5rem] p-8 hover:border-blue-200 hover:shadow-[0_30px_60px_-12px_rgba(59,130,246,0.12)] transition-all relative overflow-hidden flex flex-col justify-between h-[280px]", p.status === 'archived' && "opacity-80 grayscale-[0.2]")}>
                  
                  <div>
                    <div className="flex justify-between items-start mb-6">
                      <div className={cn("w-12 h-12 rounded-2xl flex items-center justify-center shadow-sm transition-all group-hover:scale-110", p.status === 'archived' ? "bg-slate-50 text-slate-300" : "bg-blue-50 text-blue-600 group-hover:bg-blue-600 group-hover:text-white")}>
                        {p.status === 'exported' ? <CheckCircle2 size={24} /> : p.status === 'archived' ? <Archive size={24} /> : <FileText size={24} />}
                      </div>
                      
                      {/* SCORE BADGE */}
                      {p.success_score > 0 && (
                        <div className="flex flex-col items-end">
                          <span className="text-[8px] font-black text-slate-300 uppercase tracking-widest mb-1">Audit Score</span>
                          <div className={cn("w-10 h-10 rounded-full border-2 flex items-center justify-center", p.success_score >= 80 ? "border-emerald-100 bg-emerald-50 text-emerald-600" : "border-amber-100 bg-amber-50 text-amber-600")}>
                            <span className="text-xs font-black">{p.success_score}</span>
                          </div>
                        </div>
                      )}
                    </div>

                    <h3 className="font-black text-slate-900 text-xl tracking-tight leading-tight group-hover:text-blue-600 transition-colors mb-2 line-clamp-2">{p.name}</h3>
                    <div className="flex items-center gap-2 mb-4">
                      <span className={cn("text-[8px] font-black uppercase tracking-[0.2em] px-2.5 py-1 rounded-full border flex items-center gap-1.5", 
                        p.status === 'exported' ? "bg-emerald-50 text-emerald-600 border-emerald-100" : 
                        p.status === 'archived' ? "bg-amber-50 text-amber-600 border-amber-100" : 
                        "bg-blue-50 text-blue-600 border-blue-100"
                      )}>
                        <div className={cn("w-1 h-1 rounded-full", p.status === 'archived' ? "bg-amber-400" : p.status === 'exported' ? "bg-emerald-500" : "bg-blue-500 animate-pulse")} />
                        {p.status === 'exported' ? 'Finalizado' : p.status === 'archived' ? 'Archivado' : 'En Curso'}
                      </span>
                    </div>
                  </div>

                  <div className="flex items-center justify-between pt-6 border-t border-slate-50">
                    <div className="flex items-center gap-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                      <Calendar size={12} className="text-slate-200" />
                      {new Date(p.updated_at).toLocaleDateString()}
                    </div>
                    <div className="w-8 h-8 bg-slate-50 rounded-xl flex items-center justify-center text-slate-300 group-hover:bg-blue-50 group-hover:text-blue-600 transition-all">
                      <ChevronRight size={16} />
                    </div>
                  </div>

                  {/* Icono decorativo de fondo */}
                  <div className="absolute -right-4 -top-4 opacity-[0.03] group-hover:opacity-[0.06] transition-opacity duration-700 pointer-events-none">
                    <BarChart3 size={120} />
                  </div>
                </Link>
              ))
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

function Calendar({ size, className }: { size?: number; className?: string }) {
  return <Clock size={size} className={className} />;
}
</file>

<file path="app/dashboard/clients/new/page.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { 
  ArrowLeft, Building2, User, Mail, Phone, 
  Briefcase, Info, Hash, Globe, Check, Loader2 
} from "lucide-react";
import { createClient } from "@/lib/supabase/client";
import * as Label from "@radix-ui/react-label";
import { cn } from "@/lib/utils";

export default function NewClientPage() {
  const [name, setName] = useState("");
  const [taxId, setTaxId] = useState("");
  const [email, setEmail] = useState("");
  const [phone, setPhone] = useState("");
  const [countryPrefix, setCountryPrefix] = useState("+34");
  const [industry, setIndustry] = useState("");
  const [notes, setNotes] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  const router = useRouter();
  const supabase = createClient();

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError(null);
    setLoading(true);
    
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      setError("Sesión no válida");
      setLoading(false);
      return;
    }

    // Combinar prefijo y número
    const fullPhone = phone ? `${countryPrefix} ${phone.trim()}` : null;

    const { data, error: err } = await supabase
      .from("clients")
      .insert({
        user_id: user.id,
        name,
        tax_id: taxId.toUpperCase() || null,
        contact_email: email || null,
        contact_phone: fullPhone,
        industry: industry || null,
        notes: notes || null,
      })
      .select("id")
      .single();

    if (err) {
      setError(err.message);
      setLoading(false);
    } else {
      router.push(`/dashboard/clients/${data.id}`);
      router.refresh();
    }
  }

  return (
    <div className="max-w-2xl mx-auto space-y-10 animate-in fade-in duration-700 pb-20">
      <header className="flex items-center gap-6">
        <Link
          href="/dashboard/clients"
          className="p-4 bg-white border border-slate-200 rounded-2xl text-slate-400 hover:text-blue-600 transition-all shadow-sm group"
        >
          <ArrowLeft size={20} className="group-hover:-translate-x-1 transition-transform" />
        </Link>
        <div>
          <h1 className="text-3xl font-black text-slate-900 tracking-tighter">
            Registro de Cliente
          </h1>
          <p className="text-slate-400 text-sm font-bold uppercase tracking-widest mt-1">Alta en Base de Datos Técnica</p>
        </div>
      </header>

      <form
        onSubmit={handleSubmit}
        className="bg-white border border-slate-200 rounded-[3rem] p-10 shadow-sm space-y-10 relative overflow-hidden"
      >
        {error && (
          <div className="p-4 rounded-2xl bg-red-50 border border-red-100 text-red-700 text-xs font-bold uppercase tracking-widest">
            ⚠️ {error}
          </div>
        )}

        {/* SECCIÓN: IDENTIDAD FISCAL */}
        <div className="space-y-6">
          <div className="flex items-center gap-3 text-slate-900 font-black text-xs uppercase tracking-[0.2em] border-b border-slate-50 pb-4">
            <Hash size={16} className="text-blue-600" />
            Identidad y Fiscalidad
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-2">
              <Label.Root htmlFor="name" className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Razón Social / Nombre</Label.Root>
              <div className="relative">
                <Building2 size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" />
                <input
                  id="name"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  required
                  className="w-full pl-11 pr-4 py-4 rounded-2xl border border-slate-100 bg-slate-50/50 text-sm font-bold outline-none focus:ring-4 focus:ring-blue-500/5 focus:border-blue-500 transition-all"
                  placeholder="Nombre de la empresa"
                />
              </div>
            </div>
            <div className="space-y-2">
              <Label.Root htmlFor="taxId" className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">CIF / NIF (Número)</Label.Root>
              <div className="relative">
                <span className="absolute left-4 top-1/2 -translate-y-1/2 text-[10px] font-black text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded uppercase">ID</span>
                <input
                  id="taxId"
                  value={taxId}
                  onChange={(e) => setTaxId(e.target.value.toUpperCase())}
                  className="w-full pl-14 pr-4 py-4 rounded-2xl border border-slate-100 bg-slate-50/50 text-sm font-mono font-bold outline-none focus:ring-4 focus:ring-blue-500/5 focus:border-blue-500 transition-all uppercase placeholder:text-slate-200"
                  placeholder="B12345678"
                />
              </div>
            </div>
          </div>
        </div>

        {/* SECCIÓN: CONTACTO INTELIGENTE */}
        <div className="space-y-6">
          <div className="flex items-center gap-3 text-slate-900 font-black text-xs uppercase tracking-[0.2em] border-b border-slate-50 pb-4">
            <Globe size={16} className="text-blue-600" />
            Canales de Comunicación
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-2">
              <Label.Root htmlFor="email" className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Email Principal</Label.Root>
              <div className="relative">
                <Mail size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" />
                <input
                  id="email"
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full pl-11 pr-4 py-4 rounded-2xl border border-slate-100 bg-slate-50/50 text-sm font-bold outline-none focus:ring-4 focus:ring-blue-500/5 focus:border-blue-500 transition-all"
                  placeholder="contacto@empresa.com"
                />
              </div>
            </div>
            <div className="space-y-2">
              <Label.Root htmlFor="phone" className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Teléfono (Número)</Label.Root>
              <div className="flex gap-2">
                <select 
                  value={countryPrefix}
                  onChange={(e) => setCountryPrefix(e.target.value)}
                  className="w-24 px-3 py-4 rounded-2xl border border-slate-100 bg-slate-50/50 text-xs font-black outline-none focus:border-blue-500 transition-all appearance-none text-center"
                >
                  <option value="+34">🇪🇸 +34</option>
                  <option value="+351">🇵🇹 +351</option>
                  <option value="+33">🇫🇷 +33</option>
                  <option value="+44">🇬🇧 +44</option>
                  <option value="+1">🇺🇸 +1</option>
                </select>
                <div className="relative flex-1">
                  <Phone size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" />
                  <input
                    id="phone"
                    type="tel"
                    value={phone}
                    onChange={(e) => setPhone(e.target.value.replace(/[^0-9]/g, ""))}
                    className="w-full pl-11 pr-4 py-4 rounded-2xl border border-slate-100 bg-slate-50/50 text-sm font-bold outline-none focus:ring-4 focus:ring-blue-500/5 focus:border-blue-500 transition-all"
                    placeholder="600 000 000"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="space-y-2">
          <Label.Root htmlFor="industry" className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Sector Industrial</Label.Root>
          <div className="relative">
            <Briefcase size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" />
            <input
              id="industry"
              value={industry}
              onChange={(e) => setIndustry(e.target.value)}
              className="w-full pl-11 pr-4 py-4 rounded-2xl border border-slate-100 bg-slate-50/50 text-sm font-bold outline-none focus:ring-4 focus:ring-blue-500/5 focus:border-blue-500 transition-all"
              placeholder="Ej: Energías Renovables"
            />
          </div>
        </div>

        <div className="flex gap-4 pt-6">
          <button
            type="submit"
            disabled={loading}
            className="flex-1 py-5 bg-slate-900 text-white rounded-[1.5rem] font-black text-xs uppercase tracking-[0.2em] transition-all shadow-2xl shadow-slate-900/20 hover:bg-blue-600 disabled:opacity-70 flex items-center justify-center gap-3 active:scale-95"
          >
            {loading ? <Loader2 size={20} className="animate-spin" /> : <Check size={20} />}
            {loading ? "Registrando..." : "Confirmar Alta de Cliente"}
          </button>
          <Link
            href="/dashboard/clients"
            className="px-10 py-5 border border-slate-200 rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest text-slate-500 hover:bg-slate-50 transition-all flex items-center"
          >
            Cancelar
          </Link>
        </div>

        {/* Marca de agua decorativa */}
        <div className="absolute -right-10 -bottom-10 opacity-[0.02] pointer-events-none">
          <Building2 size={300} />
        </div>
      </form>
    </div>
  );
}
</file>

<file path="app/dashboard/history/page.tsx">
import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";
import { FileText, Building2, Calendar, Award, ChevronRight, Archive } from "lucide-react";
import Link from "next/link";
import { cn } from "@/lib/utils";

export default async function HistoryPage() {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) redirect("/login");

  // Cargamos proyectos finalizados o archivados con datos de cliente
  const { data: projects } = await supabase
    .from("projects")
    .select("*, clients(*)")
    .eq("user_id", user.id)
    .in("status", ["exported", "archived"])
    .order("updated_at", { ascending: false });

  return (
    <div className="max-w-5xl mx-auto space-y-10 animate-in fade-in duration-700">
      <header>
        <h1 className="text-5xl font-black text-slate-900 tracking-tighter">
          Histórico
        </h1>
        <p className="text-slate-500 font-medium mt-2 text-lg">
          Registro de memorias finalizadas y expedientes archivados
        </p>
      </header>

      {!projects?.length ? (
        <div className="bg-white border border-slate-200 rounded-[3rem] p-20 text-center shadow-sm">
          <div className="w-20 h-20 bg-slate-50 rounded-3xl flex items-center justify-center mx-auto mb-6">
            <FileText size={40} className="text-slate-200" />
          </div>
          <h2 className="text-2xl font-black text-slate-900 mb-2">
            Historial vacío
          </h2>
          <p className="text-slate-500 max-w-sm mx-auto font-medium">
            Aquí aparecerán tus memorias una vez exportadas o cuando decidas archivar un proyecto en curso.
          </p>
        </div>
      ) : (
        <div className="grid grid-cols-1 gap-4">
          {projects.map((p) => (
            <Link
              key={p.id}
              href={`/dashboard/projects/${p.id}/export`}
              className="group bg-white border border-slate-200 rounded-[2rem] p-8 hover:shadow-2xl hover:shadow-blue-500/5 transition-all flex flex-col md:flex-row md:items-center justify-between gap-6"
            >
              <div className="flex items-center gap-6">
                <div className={cn(
                  "w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg transition-transform group-hover:rotate-3",
                  p.status === 'archived' ? "bg-slate-100 text-slate-400" : "bg-blue-600 text-white shadow-blue-600/20"
                )}>
                  {p.status === 'archived' ? <Archive size={28} /> : <FileText size={28} />}
                </div>
                <div>
                  <div className="flex items-center gap-3 mb-1">
                    <h3 className="text-xl font-black text-slate-900 tracking-tight">{p.name}</h3>
                    <span className={cn(
                      "text-[8px] font-black uppercase tracking-widest px-2 py-0.5 rounded",
                      p.status === 'exported' ? "bg-emerald-50 text-emerald-600 border border-emerald-100" : 
                      p.status === 'archived' ? "bg-amber-50 text-amber-600 border border-amber-100" : "bg-blue-50 text-blue-600 border border-blue-100"
                    )}>
                      {p.status === 'exported' ? 'Finalizado' : p.status === 'archived' ? 'Archivado' : 'Listo'}
                    </span>
                  </div>
                  <div className="flex items-center gap-4">
                    <div className="flex items-center gap-1.5 text-xs text-slate-500 font-bold">
                      <Building2 size={12} className="text-slate-300" />
                      {p.clients?.name || "Sin cliente"}
                    </div>
                    <div className="w-1 h-1 bg-slate-200 rounded-full" />
                    <div className="flex items-center gap-1.5 text-xs text-slate-500 font-bold">
                      <Calendar size={12} className="text-slate-300" />
                      {new Date(p.updated_at).toLocaleDateString()}
                    </div>
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-8">
                {p.success_score > 0 && (
                  <div className="flex flex-col items-end">
                    <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-1">Quality Score</span>
                    <div className="flex items-center gap-2">
                      <Award size={16} className={cn(p.success_score >= 80 ? "text-emerald-500" : "text-amber-500")} />
                      <span className="text-xl font-black text-slate-900 tracking-tighter">{p.success_score}</span>
                    </div>
                  </div>
                )}
                <div className="p-3 bg-slate-50 rounded-xl text-slate-300 group-hover:bg-blue-50 group-hover:text-blue-600 transition-all">
                  <ChevronRight size={20} />
                </div>
              </div>
            </Link>
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/dashboard/projects/new/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { ArrowLeft, Building2, Plus, Loader2, Check } from "lucide-react";
import { createClient } from "@/lib/supabase/client";
import * as Label from "@radix-ui/react-label";
import * as Dialog from "@radix-ui/react-dialog";
import { cn } from "@/lib/utils";
import { Client } from "@/lib/types";

export default function NewProjectPage() {
  const [name, setName] = useState("");
  const [grantName, setGrantName] = useState("");
  const [clientId, setClientId] = useState<string>("");
  const [clients, setClients] = useState<Client[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  // Quick Client State
  const [isQuickClientOpen, setIsQuickClientOpen] = useState(false);
  const [quickClientName, setQuickClientName] = useState("");
  const [quickClientTaxId, setQuickClientTaxId] = useState("");
  const [isCreatingClient, setIsCreatingClient] = useState(false);

  const router = useRouter();
  const supabase = createClient();

  useEffect(() => {
    async function loadClients() {
      const { data } = await supabase
        .from("clients")
        .select("*")
        .eq("status", "active")
        .order("name");
      setClients(data || []);
    }
    loadClients();
  }, [supabase]);

  async function handleQuickClientSubmit(e: React.FormEvent) {
    e.preventDefault();
    setIsCreatingClient(true);
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data, error: err } = await supabase
      .from("clients")
      .insert({
        user_id: user.id,
        name: quickClientName,
        tax_id: quickClientTaxId || null
      })
      .select("*")
      .single();

    if (!err && data) {
      setClients(prev => [...prev, data].sort((a, b) => a.name.localeCompare(b.name)));
      setClientId(data.id);
      setIsQuickClientOpen(false);
      setQuickClientName("");
      setQuickClientTaxId("");
    }
    setIsCreatingClient(false);
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError(null);
    setLoading(true);
    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (!user) {
      setError("Sesión no válida");
      setLoading(false);
      return;
    }
    const { data, error: err } = await supabase
      .from("projects")
      .insert({
        user_id: user.id,
        client_id: clientId || null,
        name: name || "Sin título",
        grant_name: grantName || "Convocatoria",
      })
      .select("id")
      .single();
    setLoading(false);
    if (err) {
      setError(err.message);
      return;
    }
    router.push(`/dashboard/projects/${data.id}`);
    router.refresh();
  }

  return (
    <div className="max-w-2xl mx-auto space-y-8 animate-in fade-in duration-500">
      <header className="flex items-center gap-4">
        <Link
          href="/dashboard"
          className="p-2 hover:bg-white rounded-full border border-slate-200 transition-all"
        >
          <ArrowLeft size={20} />
        </Link>
        <div>
          <h1 className="text-2xl font-black text-slate-900">
            Nuevo proyecto
          </h1>
          <p className="text-slate-500 text-sm">
            Crea un espacio de trabajo para esta convocatoria
          </p>
        </div>
      </header>

      <form
        onSubmit={handleSubmit}
        className="bg-white border border-slate-200 rounded-[2.5rem] p-8 shadow-sm space-y-6"
      >
        {error && (
          <div className="p-3 rounded-xl bg-red-50 border border-red-100 text-red-700 text-sm">
            {error}
          </div>
        )}

        <div className="space-y-2">
          <Label.Root className="text-sm font-bold text-slate-700 flex justify-between items-center">
            Cliente
            <span className="text-[10px] text-slate-400 font-black uppercase tracking-widest">Opcional</span>
          </Label.Root>
          <div className="relative">
            <Building2 size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
            <select
              value={clientId}
              onChange={(e) => setClientId(e.target.value)}
              className={cn(
                "w-full pl-11 pr-4 py-3.5 rounded-2xl border border-slate-200 bg-slate-50/50 appearance-none transition-all outline-none",
                "focus:ring-2 focus:ring-blue-500/10 focus:border-blue-500 font-bold text-slate-700 text-sm"
              )}
            >
              <option value="">Seleccionar cliente existente...</option>
              {clients.map(c => (
                <option key={c.id} value={c.id}>{c.name}</option>
              ))}
            </select>
            <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none">
              <Plus size={14} className="text-slate-300" />
            </div>
          </div>
        </div>

        <div className="space-y-2">
          <Label.Root htmlFor="name" className="text-sm font-bold text-slate-700">
            Nombre del proyecto
          </Label.Root>
          <input
            id="name"
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            className={cn(
              "w-full px-4 py-3.5 rounded-2xl border border-slate-200 bg-slate-50/50 outline-none transition-all",
              "focus:ring-2 focus:ring-blue-500/10 focus:border-blue-500 text-sm font-medium"
            )}
            placeholder="Ej: Begitality AI Expansion"
            required
          />
        </div>

        <div className="space-y-2">
          <Label.Root
            htmlFor="grantName"
            className="text-sm font-bold text-slate-700"
          >
            Nombre de la convocatoria
          </Label.Root>
          <input
            id="grantName"
            type="text"
            value={grantName}
            onChange={(e) => setGrantName(e.target.value)}
            className={cn(
              "w-full px-4 py-3.5 rounded-2xl border border-slate-200 bg-slate-50/50 outline-none transition-all",
              "focus:ring-2 focus:ring-blue-500/10 focus:border-blue-500 text-sm font-medium"
            )}
            placeholder="Ej: ICEX Next - Convocatoria 2024"
            required
          />
        </div>

        <div className="flex gap-3 pt-4">
          <button
            type="submit"
            disabled={loading}
            className="flex-1 py-4 bg-blue-600 text-white rounded-[1.25rem] font-black text-sm transition-all shadow-lg shadow-blue-500/20 hover:bg-blue-500 disabled:opacity-60"
          >
            {loading ? <Loader2 size={18} className="animate-spin mx-auto" /> : "Crear proyecto y empezar"}
          </button>
          <Link
            href="/dashboard"
            className="px-8 py-4 border border-slate-200 rounded-[1.25rem] font-bold text-slate-600 hover:bg-slate-50 transition-all text-sm"
          >
            Cancelar
          </Link>
        </div>
      </form>

      {/* Quick Client Section */}
      <div className="bg-slate-900 rounded-[2rem] p-8 text-white flex items-center justify-between gap-6 overflow-hidden relative group">
        <div className="relative z-10">
          <p className="text-blue-400 text-[10px] font-black uppercase tracking-widest mb-1">Acceso Rápido</p>
          <h3 className="text-lg font-bold">¿Cliente nuevo?</h3>
          <p className="text-slate-400 text-sm font-medium mt-1">Registra a la empresa sin salir de esta página.</p>
        </div>
        
        <Dialog.Root open={isQuickClientOpen} onOpenChange={setIsQuickClientOpen}>
          <Dialog.Trigger asChild>
            <button className="relative z-10 p-4 bg-blue-600 hover:bg-blue-500 rounded-2xl transition-all shadow-xl shadow-blue-600/20 active:scale-95">
              <Plus size={24} />
            </button>
          </Dialog.Trigger>
          <Dialog.Portal>
            <Dialog.Overlay className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 animate-in fade-in duration-300" />
            <Dialog.Content className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-[2.5rem] p-10 shadow-2xl z-50 outline-none animate-in zoom-in-95 duration-300">
              <Dialog.Title className="text-2xl font-black text-slate-900 tracking-tighter mb-2">
                Registro Rápido
              </Dialog.Title>
              <Dialog.Description className="text-slate-500 text-sm mb-8 font-medium">
                Añade los datos básicos para empezar a trabajar de inmediato.
              </Dialog.Description>
              
              <form onSubmit={handleQuickClientSubmit} className="space-y-6">
                <div className="space-y-2">
                  <Label.Root htmlFor="qName" className="text-sm font-bold text-slate-700">
                    Nombre de la Empresa
                  </Label.Root>
                  <input
                    id="qName"
                    value={quickClientName}
                    onChange={(e) => setQuickClientName(e.target.value)}
                    required
                    autoFocus
                    className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50/50 outline-none focus:ring-2 focus:ring-blue-500/10 focus:border-blue-500 font-medium"
                    placeholder="Nombre comercial"
                  />
                </div>
                <div className="space-y-2">
                  <Label.Root htmlFor="qTax" className="text-sm font-bold text-slate-700">
                    CIF / NIF
                  </Label.Root>
                  <input
                    id="qTax"
                    value={quickClientTaxId}
                    onChange={(e) => setQuickClientTaxId(e.target.value)}
                    className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50/50 outline-none focus:ring-2 focus:ring-blue-500/10 focus:border-blue-500 font-medium uppercase"
                    placeholder="B12345678"
                  />
                </div>
                
                <div className="flex gap-3 pt-4">
                  <button
                    type="submit"
                    disabled={isCreatingClient || !quickClientName}
                    className="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black text-sm hover:bg-blue-500 disabled:opacity-70 transition-all flex items-center justify-center gap-2"
                  >
                    {isCreatingClient ? <Loader2 size={18} className="animate-spin" /> : <Check size={18} />}
                    {isCreatingClient ? "Guardando..." : "Confirmar y Seleccionar"}
                  </button>
                </div>
              </form>
            </Dialog.Content>
          </Dialog.Portal>
        </Dialog.Root>

        <div className="absolute right-0 bottom-0 opacity-10 -mr-8 -mb-8 group-hover:scale-110 transition-transform duration-700">
          <Building2 size={160} />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/projects/page.tsx">
"use client";

import { useEffect, useState, useMemo } from "react";
import Link from "next/link";
import { PlusCircle, FileText, Search, Building2, ChevronRight } from "lucide-react";
import { createClient } from "@/lib/supabase/client";
import { Project } from "@/lib/types";
import * as Tabs from "@radix-ui/react-tabs";
import { cn } from "@/lib/utils";

export default function ProjectsPage() {
  const [projects, setProjects] = useState<Project[]>([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [activeTab, setActiveTab] = useState("active");
  const supabase = createClient();

  useEffect(() => {
    async function loadProjects() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data } = await supabase
        .from("projects")
        .select("*, clients(*)")
        .eq("user_id", user.id)
        .order("updated_at", { ascending: false });
      
      const mappedProjects = (data || []).map(p => ({
        ...p,
        client: p.clients || null
      })) as Project[];

      setProjects(mappedProjects);
      setLoading(false);
    }
    loadProjects();
  }, [supabase]);

  const stats = useMemo(() => {
    return {
      active: projects.filter(p => p.status !== 'archived').length,
      archived: projects.filter(p => p.status === 'archived').length
    };
  }, [projects]);

  const filteredProjects = useMemo(() => {
    const s = search.toLowerCase();
    return projects.filter(p => {
      const matchesStatus = activeTab === 'active' 
        ? p.status !== 'archived' 
        : p.status === 'archived';

      const matchesSearch = 
        p.name.toLowerCase().includes(s) || 
        p.grant_name.toLowerCase().includes(s) ||
        (p.client?.name || "").toLowerCase().includes(s);

      return matchesStatus && matchesSearch;
    });
  }, [projects, search, activeTab]);

  return (
    <div className="max-w-5xl mx-auto space-y-10">
      <header className="flex justify-between items-end gap-6 flex-wrap">
        <div className="flex-1 min-w-[300px]">
          <h1 className="text-5xl font-black text-slate-900 tracking-tighter">
            Proyectos
          </h1>
          <p className="text-slate-500 font-medium mt-2 text-lg">
            Todas tus convocatorias y memorias
          </p>
        </div>
        <div className="flex items-center gap-4 w-full md:w-auto">
          <div className="relative flex-1 md:w-64">
            <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
            <input
              type="text"
              placeholder="Buscar proyecto o cliente..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="w-full pl-10 pr-4 py-3 rounded-2xl border border-slate-200 bg-white focus:ring-2 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all text-sm font-medium"
            />
          </div>
          <Link
            href="/dashboard/projects/new"
            className="flex items-center gap-2 px-5 py-3 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-500 transition-all shadow-lg shadow-blue-600/20 shrink-0"
          >
            <PlusCircle size={20} />
            Nuevo proyecto
          </Link>
        </div>
      </header>

      <Tabs.Root value={activeTab} onValueChange={setActiveTab} className="space-y-8">
        <Tabs.List className="flex gap-2 p-1 bg-slate-100 rounded-2xl w-fit">
          <Tabs.Trigger
            value="active"
            className={cn(
              "flex items-center gap-2 px-6 py-2.5 rounded-xl text-sm font-black transition-all",
              activeTab === "active" ? "bg-white text-blue-600 shadow-sm" : "text-slate-400 hover:text-slate-600"
            )}
          >
            Activos
            <span className="ml-1 opacity-50 font-medium text-[10px]">{stats.active}</span>
          </Tabs.Trigger>
          <Tabs.Trigger
            value="archived"
            className={cn(
              "flex items-center gap-2 px-6 py-2.5 rounded-xl text-sm font-black transition-all",
              activeTab === "archived" ? "bg-white text-amber-600 shadow-sm" : "text-slate-400 hover:text-slate-600"
            )}
          >
            Archivados
            <span className="ml-1 opacity-50 font-medium text-[10px]">{stats.archived}</span>
          </Tabs.Trigger>
        </Tabs.List>

        <Tabs.Content value={activeTab} className="outline-none">
          {loading ? (
            <div className="flex items-center justify-center py-20">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
          ) : filteredProjects.length === 0 ? (
            <div className="bg-white border border-slate-200 rounded-3xl p-16 text-center">
              <div className="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <FileText size={32} className="text-slate-400" />
              </div>
              <h2 className="text-xl font-bold text-slate-900 mb-2">
                {search ? "No hay resultados para tu búsqueda" : "Sin proyectos aún"}
              </h2>
              <p className="text-slate-500 mb-6 max-w-sm mx-auto font-medium">
                {search ? "Prueba con otros términos." : "Crea tu primer proyecto y empieza a redactar con IA."}
              </p>
              {activeTab === 'active' && (
                <Link
                  href="/dashboard/projects/new"
                  className="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-500 shadow-xl shadow-blue-600/20"
                >
                  <PlusCircle size={18} />
                  Crear proyecto
                </Link>
              )}
            </div>
          ) : (
            <ul className="space-y-3">
              {filteredProjects.map((p) => (
                <li key={p.id}>
                  <Link
                    href={
                      p.status === "ready_export"
                        ? `/dashboard/projects/${p.id}/export`
                        : `/dashboard/projects/${p.id}`
                    }
                    className={cn(
                      "group flex flex-col md:flex-row md:items-center justify-between bg-white border border-slate-200 rounded-2xl p-6 hover:shadow-md transition-all gap-4",
                      activeTab === 'archived' ? "opacity-75 grayscale-[0.5] hover:opacity-100 hover:grayscale-0" : "hover:border-blue-200"
                    )}
                  >
                    <div className="flex items-center gap-4">
                      <div className={cn(
                        "p-3 rounded-xl transition-colors",
                        activeTab === 'active' ? "bg-slate-50 group-hover:bg-blue-50 group-hover:text-blue-600" : "bg-slate-50 text-slate-400"
                      )}>
                        <FileText size={22} />
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <p className="font-bold text-slate-900">{p.name}</p>
                          {p.client && (
                            <span className="flex items-center gap-1 text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full font-black uppercase tracking-widest">
                              <Building2 size={10} /> {p.client.name}
                            </span>
                          )}
                        </div>
                        <p className="text-sm text-slate-500 font-medium">{p.grant_name}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-3 self-end md:self-auto">
                      <span
                        className={cn(
                          "text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest",
                          p.status === "ready_export" ? "bg-emerald-100 text-emerald-700" : 
                          p.status === "archived" ? "bg-amber-100 text-amber-700" : "bg-slate-100 text-slate-600"
                        )}
                      >
                        {p.status === "ready_export" ? "Listo" : p.status === "archived" ? "Archivado" : "En curso"}
                      </span>
                      <ChevronRight size={18} className="text-slate-300 group-hover:text-blue-500 transition-colors" />
                    </div>
                  </Link>
                </li>
              ))}
            </ul>
          )}
        </Tabs.Content>
      </Tabs.Root>
    </div>
  );
}
</file>

<file path="components/export/ExportView.tsx">
"use client";

import { useState } from "react";
import Link from "next/link";
import {
  ArrowLeft,
  FileText,
  Download,
  FileDown,
  ExternalLink,
  Eye,
  ShieldCheck,
  Printer,
  Sparkles,
  Zap,
  Loader2,
  CheckCircle2,
} from "lucide-react";
interface SectionData {
  id: string;
  title: string;
  content: string;
  is_completed: boolean;
}

interface ExportViewProps {
  project: {
    id: string;
    name: string;
    grant_name: string;
    sections: SectionData[];
  };
}

function ExportCard({
  type,
  title,
  icon: Icon,
  onClick,
}: {
  type: string;
  title: string;
  icon: React.ComponentType<{ size?: number }>;
  onClick: () => void;
}) {
  return (
    <button
      onClick={onClick}
      className="bg-white border border-slate-200 p-6 rounded-2xl flex items-center gap-4 hover:border-blue-500 hover:shadow-xl hover:shadow-blue-500/5 transition-all group w-full text-left"
    >
      <div className="p-3 bg-slate-50 rounded-xl group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">
        <Icon size={24} />
      </div>
      <div className="flex-1">
        <h4 className="font-bold text-slate-900">{title}</h4>
        <p className="text-xs text-slate-500">Exportar formato oficial {type}</p>
      </div>
      <Download size={18} className="text-slate-300 group-hover:text-blue-500" />
    </button>
  );
}

function downloadBlob(blob: Blob, filename: string) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

export function ExportView({ project }: ExportViewProps) {
  const [isExporting, setIsExporting] = useState(false);
  const [exportComplete, setExportComplete] = useState(false);

  const sections = project.sections ?? [];
  const completedSections = sections.filter(s => s.is_completed).length;
  const totalSections = sections.length;
  const progressPercent = totalSections > 0 ? Math.round((completedSections / totalSections) * 100) : 0;
  const hasContent = sections.some(s => s.content && s.content.trim().length > 0);

  const doExport = async (format: "pdf" | "docx") => {
    setIsExporting(true);
    try {
      const res = await fetch("/api/export", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ projectId: project.id, format }),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || res.statusText);
      }
      const blob = await res.blob();
      const disposition = res.headers.get("Content-Disposition");
      const match = disposition?.match(/filename="?([^";\n]+)"?/);
      const filename = match?.[1] ?? `Memoria_Tecnica.${format}`;
      downloadBlob(blob, filename);
      setExportComplete(true);
    } catch (e) {
      console.error(e);
      alert(e instanceof Error ? e.message : "Error al exportar");
      setExportComplete(false);
    } finally {
      setIsExporting(false);
    }
  };

  const handleExportDocx = () => doExport("docx");
  const handleExportPdf = () => doExport("pdf");

  return (
    <div className="max-w-5xl mx-auto space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <header className="flex justify-between items-center">
        <div className="flex items-center gap-4">
          <Link
            href={`/dashboard/projects/${project.id}`}
            className="p-2 hover:bg-white rounded-full border border-slate-200 transition-all"
          >
            <ArrowLeft size={20} />
          </Link>
          <div>
            <h1 className="text-2xl font-black text-slate-900">
              Finalizar Memoria
            </h1>
            <p className="text-slate-500 text-sm">
              Verificación y exportación de expediente
            </p>
          </div>
        </div>
        <div className="flex gap-3">
          {progressPercent === 100 ? (
            <span className="flex items-center gap-2 bg-emerald-50 text-emerald-600 px-4 py-2 rounded-xl text-xs font-bold border border-emerald-100">
              <ShieldCheck size={16} /> Verificado por IA
            </span>
          ) : (
            <span className="flex items-center gap-2 bg-amber-50 text-amber-600 px-4 py-2 rounded-xl text-xs font-bold border border-amber-100">
              <Loader2 size={16} className="animate-spin" /> {progressPercent}% Completado
            </span>
          )}
        </div>
      </header>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-2 space-y-6">
          <div className="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[70vh]">
            <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
              <div className="flex items-center gap-2">
                <FileText size={18} className="text-slate-400" />
                <span className="text-sm font-bold text-slate-700">
                  VISTA PREVIA DE MEMORIA
                </span>
              </div>
              <div className="flex gap-2">
                <button
                  type="button"
                  title="Imprimir"
                  onClick={() => window.print()}
                  className="p-2 hover:bg-white rounded-lg text-slate-400 hover:text-slate-600"
                >
                  <Printer size={18} />
                </button>
              </div>
            </div>
            <div className="flex-1 overflow-y-auto p-12 bg-slate-50/30">
              <div className="max-w-2xl mx-auto bg-white shadow-2xl shadow-slate-200/50 p-16 min-h-full space-y-8 font-serif">
                <div className="text-center space-y-2 mb-12">
                  <h1 className="text-3xl font-bold text-slate-900 uppercase tracking-tighter">
                    Memoria Técnica
                  </h1>
                  <div className="w-20 h-1 bg-blue-600 mx-auto rounded-full" />
                  <p className="text-slate-500 text-sm font-sans font-bold">
                    {project.grant_name}
                  </p>
                </div>
                {sections.length > 0 && hasContent ? (
                  sections.map((section) => (
                    <div key={section.id} className="space-y-4">
                      <h3 className="text-lg font-bold text-slate-900 font-sans border-l-4 border-blue-600 pl-4">
                        {section.title}
                      </h3>
                      <div className="text-slate-700 leading-relaxed text-justify text-sm whitespace-pre-wrap">
                        {section.content || (
                          <span className="text-slate-300 italic">Sección sin contenido redactado.</span>
                        )}
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="py-20 text-center space-y-4">
                    <FileText size={48} className="text-slate-200 mx-auto" />
                    <p className="text-slate-400 text-sm italic">
                      No hay contenido redactado para exportar. 
                      Vuelve al espacio de trabajo para completar las secciones.
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>

        <div className="space-y-6">
          <div className="bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden">
            <div className="absolute top-0 right-0 p-4 opacity-10">
              <Sparkles size={120} />
            </div>
            <h3 className="text-xl font-bold mb-2">
              {progressPercent === 100 ? "¿Todo listo?" : "Trabajo en curso"}
            </h3>
            <p className="text-slate-400 text-sm mb-6 font-medium">
              {progressPercent === 100 
                ? "Hemos analizado el documento y cumple con el 100% de los requisitos detectados."
                : `Has completado ${completedSections} de ${totalSections} secciones requeridas.`}
            </p>
            <div className="space-y-4 mb-8">
              <div className="flex items-center gap-3 text-sm">
                {totalSections > 0 ? (
                  <CheckCircle2 size={18} className="text-emerald-400" />
                ) : (
                  <div className="w-[18px] h-[18px] rounded-full border border-slate-600" />
                )}
                <span>Estructura generada</span>
              </div>
              <div className="flex items-center gap-3 text-sm">
                {progressPercent > 50 ? (
                  <CheckCircle2 size={18} className="text-emerald-400" />
                ) : (
                  <div className="w-[18px] h-[18px] rounded-full border border-slate-600" />
                )}
                <span>Contenido avanzado</span>
              </div>
              <div className="flex items-center gap-3 text-sm">
                {progressPercent === 100 ? (
                  <CheckCircle2 size={18} className="text-emerald-400" />
                ) : (
                  <div className="w-[18px] h-[18px] rounded-full border border-slate-600" />
                )}
                <span>Requisitos verificados</span>
              </div>
            </div>
            <button
              type="button"
              onClick={handleExportPdf}
              disabled={isExporting || !hasContent}
              className="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-2xl font-black text-sm transition-all shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2 disabled:opacity-70"
            >
              {isExporting ? (
                <Loader2 className="animate-spin" size={16} />
              ) : (
                <Zap fill="currentColor" size={16} />
              )}
              {isExporting ? "Generando Archivos…" : "Finalizar y Descargar PDF"}
            </button>
          </div>

          <div className="space-y-3">
            <ExportCard
              type=".docx"
              title="Microsoft Word"
              icon={FileText}
              onClick={handleExportDocx}
            />
            <ExportCard
              type=".pdf"
              title="Adobe PDF"
              icon={FileDown}
              onClick={handleExportPdf}
            />
          </div>

          {exportComplete && (
            <div className="p-4 bg-emerald-50 border border-emerald-100 rounded-2xl flex items-center gap-3 text-emerald-700 animate-in zoom-in-95">
              <CheckCircle2 size={24} />
              <div>
                <p className="font-bold text-sm">¡Éxito!</p>
                <p className="text-xs">Documentos descargados correctamente.</p>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/project/CargarBasesConvocatoria.tsx">
"use client";

import { useState, useCallback } from "react";
import { useRouter } from "next/navigation";
import { Upload, FileText, Loader2, Trash2 } from "lucide-react";
import { createClient } from "@/lib/supabase/client";
import { cn } from "@/lib/utils";

const BUCKET = "convocatoria-files";
const MAX_SIZE_MB = 50;
const ACCEPT = "application/pdf";

interface BaseFile {
  id: string;
  name: string;
  file_path: string | null;
  file_size: number | null;
  created_at: string;
}

export function CargarBasesConvocatoria({
  projectId,
  files: initialFiles,
}: {
  projectId: string;
  files: BaseFile[];
}) {
  const [files, setFiles] = useState<BaseFile[]>(initialFiles);
  const [uploading, setUploading] = useState(false);
  const [dragging, setDragging] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const supabase = createClient();
  const router = useRouter();

  const refreshFiles = useCallback(async () => {
    const { data } = await supabase
      .from("convocatoria_bases")
      .select("id, name, file_path, file_size, created_at")
      .eq("project_id", projectId)
      .order("created_at", { ascending: false });
    setFiles(data ?? []);
    router.refresh(); // Notificar a la página de los cambios
  }, [projectId, router]);

  const handleUpload = useCallback(
    async (fileList: FileList | null) => {
      // CAPTURA INMEDIATA: Convertimos a Array antes de cualquier await
      const filesToUpload = fileList ? Array.from(fileList) : [];
      if (filesToUpload.length === 0) return;
      
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        setError("Sesión expirada. Vuelve a iniciar sesión.");
        return;
      }
      
      setError(null);
      setUploading(true);

      console.log(`Iniciando proceso para ${filesToUpload.length} archivos...`);

      for (const file of filesToUpload) {
        // Validación básica de tamaño
        if (file.size > MAX_SIZE_MB * 1024 * 1024) {
          setError(`El archivo ${file.name} es demasiado grande (máx ${MAX_SIZE_MB}MB).`);
          continue;
        }

        const fileExt = file.name.split('.').pop();
        const fileName = `${Math.random().toString(36).slice(2)}-${Date.now()}.${fileExt}`;
        const path = `${user.id}/${projectId}/${fileName}`;
        
        console.log(`Subiendo: ${file.name} a la ruta: ${path}`);

        const { error: uploadErr } = await supabase.storage.from(BUCKET).upload(path, file, {
          cacheControl: "3600",
          upsert: false,
        });

        if (uploadErr) {
          console.error("Error en Supabase Storage:", uploadErr);
          setError(`Error en ${file.name}: ${uploadErr.message}`);
          break; // Detener en caso de error de permisos/storage
        }

        const { error: insertErr } = await supabase.from("convocatoria_bases").insert({
          project_id: projectId,
          name: file.name,
          file_path: path,
          file_size: file.size,
        });

        if (insertErr) {
          console.error("Error en Base de Datos:", insertErr);
          setError(`Error al registrar ${file.name}: ${insertErr.message}`);
          break;
        }
      }
      
      await refreshFiles();
      setUploading(false);
    },
    [projectId, supabase, refreshFiles]
  );

  const handleDelete = useCallback(
    async (id: string, filePath: string | null) => {
      setError(null);
      if (filePath) {
        await supabase.storage.from(BUCKET).remove([filePath]);
      }
      const { error: deleteErr } = await supabase.from("convocatoria_bases").delete().eq("id", id);
      if (deleteErr) setError(deleteErr.message);
      else await refreshFiles();
    },
    [supabase, refreshFiles]
  );

  const onDrop = useCallback(
    (e: React.DragEvent) => {
      e.preventDefault();
      setDragging(false);
      handleUpload(e.dataTransfer.files);
    },
    [handleUpload]
  );

  const onDragOver = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setDragging(true);
  }, []);

  const onDragLeave = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setDragging(false);
  }, []);

  return (
    <div className="bg-white border border-slate-200 rounded-3xl p-8">
      <h2 className="font-bold text-slate-900 mb-4 flex items-center gap-2">
        <Upload size={18} />
        Cargar bases de la convocatoria
      </h2>
      <p className="text-slate-500 text-sm mb-4">
        Sube los PDFs de la convocatoria (máx. {MAX_SIZE_MB} MB por archivo). La IA usará su contenido como contexto.
      </p>

      {error && (
        <div className="mb-4 p-3 rounded-xl bg-red-50 border border-red-100 text-red-700 text-sm">
          {error}
        </div>
      )}

      <label
        onDrop={onDrop}
        onDragOver={onDragOver}
        onDragLeave={onDragLeave}
        className={cn(
          "block border-2 border-dashed rounded-2xl p-12 text-center cursor-pointer transition-colors",
          dragging ? "border-blue-400 bg-blue-50/50 text-blue-700" : "border-slate-200 text-slate-400 hover:border-slate-300 hover:bg-slate-50/50"
        )}
      >
        <input
          type="file"
          accept={ACCEPT}
          multiple
          className="hidden"
          disabled={uploading}
          onChange={(e) => {
            handleUpload(e.target.files);
            e.target.value = "";
          }}
        />
        {uploading ? (
          <span className="flex items-center justify-center gap-2">
            <Loader2 size={24} className="animate-spin" />
            Subiendo…
          </span>
        ) : (
          <>Arrastra PDFs aquí o haz clic para seleccionar</>
        )}
      </label>

      {files.length > 0 && (
        <ul className="mt-6 space-y-2">
          {files.map((f) => (
            <li
              key={f.id}
              className="flex items-center justify-between gap-3 p-3 rounded-xl bg-slate-50 border border-slate-100"
            >
              <div className="flex items-center gap-3 min-w-0">
                <FileText size={20} className="text-slate-400 shrink-0" />
                <span className="font-medium text-slate-900 truncate" title={f.name}>
                  {f.name}
                </span>
                {f.file_size != null && (
                  <span className="text-slate-400 text-sm shrink-0">
                    {(f.file_size / 1024).toFixed(1)} KB
                  </span>
                )}
              </div>
              <button
                type="button"
                onClick={() => handleDelete(f.id, f.file_path)}
                className="p-2 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 transition-colors"
                aria-label="Eliminar"
              >
                <Trash2 size={18} />
              </button>
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}
</file>

<file path="components/project/SeccionesMemoria.tsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { 
  FileText, Loader2, Sparkles, Save, CheckCircle2, 
  ChevronDown, ChevronUp, BookOpen, Clock, FileCheck,
  RotateCcw
} from "lucide-react";
import { createClient } from "@/lib/supabase/client";
import { cn } from "@/lib/utils";

interface Section {
  id: string;
  title: string;
  content: string;
  is_completed: boolean;
  sort_order: number;
}

export function SeccionesMemoria({
  projectId,
  sections: initialSections,
  hasConvocatoriaFiles,
}: {
  projectId: string;
  sections: Section[];
  hasConvocatoriaFiles: boolean;
}) {
  const [sections, setSections] = useState(initialSections);
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [generating, setGenerating] = useState(false);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  const router = useRouter();
  const supabase = createClient();

  const handleGenerate = async () => {
    setError(null);
    setGenerating(true);
    try {
      const res = await fetch(`/api/projects/${projectId}/generate-sections`, {
        method: "POST",
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Error al generar");
      
      const { data: newSections } = await supabase
        .from("sections")
        .select("*")
        .eq("project_id", projectId)
        .order("sort_order");
      
      if (newSections) setSections(newSections);
      router.refresh();
    } catch (e: any) {
      setError(e.message);
    } finally {
      setGenerating(false);
    }
  };

  const updateContent = async (id: string, content: string) => {
    setSaving(true);
    const { error: err } = await supabase
      .from("sections")
      .update({ content })
      .eq("id", id);
    
    if (!err) {
      setSections(prev => prev.map(s => s.id === id ? { ...s, content } : s));
    }
    setSaving(false);
  };

  const toggleComplete = async (id: string, current: boolean) => {
    const { error: err } = await supabase
      .from("sections")
      .update({ is_completed: !current })
      .eq("id", id);
    
    if (!err) {
      setSections(prev => prev.map(s => s.id === id ? { ...s, is_completed: !current } : s));
      router.refresh();
    }
  };

  return (
    <div className="space-y-8 animate-in fade-in duration-700">
      {/* HEADER DE SECCIÓN */}
      <div className="flex items-center justify-between gap-4 px-2">
        <div className="space-y-1">
          <h2 className="font-black text-slate-900 flex items-center gap-3 text-2xl tracking-tighter">
            <div className="p-2 bg-blue-50 rounded-2xl text-blue-600">
              <FileText size={24} />
            </div>
            Índice de la Memoria
          </h2>
          <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-12">Expediente Técnico Digital</p>
        </div>
        {hasConvocatoriaFiles && (
          <button
            onClick={handleGenerate}
            disabled={generating}
            className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-[1.25rem] font-black text-xs hover:bg-blue-500 transition-all shadow-xl shadow-blue-600/20 disabled:opacity-50 active:scale-95"
          >
            {generating ? <Loader2 size={16} className="animate-spin" /> : <Sparkles size={16} />}
            {generating ? "Analizando..." : "Autocompletar con IA"}
          </button>
        )}
      </div>

      {!sections.length ? (
        <div className="bg-white border border-slate-200 rounded-[3rem] p-20 text-center shadow-sm">
          <BookOpen size={48} className="mx-auto text-slate-100 mb-6" />
          <p className="text-slate-500 font-bold max-w-xs mx-auto leading-relaxed">
            Pulsa el botón de autocompletar para que Begitality genere el índice y el borrador inicial.
          </p>
        </div>
      ) : (
        <div className="space-y-4">
          {sections.map((s, idx) => {
            const isSelected = selectedId === s.id;
            const words = s.content?.split(/\s+/).filter(Boolean).length || 0;
            return (
              <div 
                key={s.id} 
                className={cn(
                  "bg-white border transition-all duration-500",
                  isSelected 
                    ? "rounded-[2.5rem] border-blue-100 shadow-2xl shadow-blue-500/5 ring-1 ring-blue-100" 
                    : "rounded-3xl border-slate-100 hover:border-slate-200 hover:bg-slate-50/30"
                )}
              >
                {/* CABECERA ACORDEÓN (CON INDICADORES DINÁMICOS SUPERIORES) */}
                <button
                  onClick={() => setSelectedId(isSelected ? null : s.id)}
                  className="w-full flex items-center justify-between p-7 text-left group"
                >
                  <div className="flex items-center gap-5 flex-1 min-w-0">
                    <div className={cn(
                      "w-2 h-2 rounded-full transition-all shrink-0",
                      s.is_completed ? "bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]" : words > 0 ? "bg-blue-400" : "bg-slate-200"
                    )} />
                    
                    <div className="flex-1 min-w-0">
                      <span className={cn(
                        "font-bold text-lg truncate block leading-tight tracking-tight",
                        isSelected ? "text-blue-600 font-black" : "text-slate-700"
                      )}>
                        {s.title}
                      </span>
                      {!isSelected && (
                        <div className="flex items-center gap-3 mt-1.5">
                          <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">{words} palabras</span>
                          {s.is_completed && (
                            <span className="text-[9px] font-black text-emerald-600 uppercase tracking-widest flex items-center gap-1">
                              <CheckCircle2 size={10} /> Revisado
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* INDICADORES EN PARTE SUPERIOR (MODO ABIERTO) */}
                  <div className="flex items-center gap-6">
                    {isSelected && (
                      <div className="flex items-center gap-4 animate-in fade-in slide-in-from-right-2 duration-500">
                        <div className="flex flex-col items-end border-r border-slate-100 pr-4">
                          <span className="text-[8px] font-black text-slate-300 uppercase tracking-widest">Contenido</span>
                          <span className="text-[10px] font-black text-slate-900 uppercase tracking-widest">{words} palabras</span>
                        </div>
                        {s.is_completed && (
                          <div className="flex items-center gap-2 bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-xl border border-emerald-100">
                            <CheckCircle2 size={12} />
                            <span className="text-[9px] font-black uppercase tracking-widest">Revisado</span>
                          </div>
                        )}
                      </div>
                    )}
                    <div className={cn(
                      "p-2 rounded-xl transition-all",
                      isSelected ? "bg-blue-50 text-blue-600" : "text-slate-300 group-hover:text-slate-500"
                    )}>
                      {isSelected ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                    </div>
                  </div>
                </button>

                {/* EDITOR EXPANDIDO */}
                {isSelected && (
                  <div className="p-10 pt-0 space-y-8 animate-in slide-in-from-top-4 duration-500">
                    <div className="bg-white rounded-[2.2rem] p-1 border border-slate-100 shadow-inner">
                      <textarea
                        value={s.content}
                        onChange={(e) => {
                          const val = e.target.value;
                          setSections(prev => prev.map(item => item.id === s.id ? { ...item, content: val } : item));
                        }}
                        onBlur={(e) => updateContent(s.id, e.target.value)}
                        className="w-full min-h-[400px] p-10 bg-transparent rounded-[2rem] border-none outline-none font-serif text-slate-800 leading-relaxed text-xl resize-y placeholder:text-slate-100"
                        placeholder="Comienza la redacción oficial..."
                      />
                      
                      {/* TOOLBAR INFERIOR ULTRA-COMPACTA */}
                      <div className="px-8 pb-8 flex flex-col sm:flex-row justify-between items-center gap-4 border-t border-slate-50 pt-6 mt-4">
                        
                        <div className="flex items-center gap-3">
                          <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-50 border border-slate-100 rounded-xl">
                            {saving ? <Loader2 size={12} className="animate-spin text-blue-600" /> : <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.5)]" />}
                            <span className="text-[9px] font-black text-slate-500 uppercase tracking-widest whitespace-nowrap">{saving ? "Cloud sync" : "Sincronizado"}</span>
                          </div>
                        </div>
                        
                        <div className="flex items-center gap-2 w-full sm:w-auto justify-end">
                          <button 
                            onClick={() => toggleComplete(s.id, s.is_completed)}
                            className={cn(
                              "flex items-center gap-2 px-4 py-2 rounded-xl font-black text-[9px] uppercase tracking-widest transition-all border shrink-0 shadow-sm",
                              s.is_completed 
                                ? "bg-emerald-500 border-emerald-500 text-white shadow-emerald-500/20" 
                                : "bg-white border-slate-200 text-slate-400 hover:border-slate-900 hover:text-slate-900"
                            )}
                          >
                            {s.is_completed ? <CheckCircle2 size={12} /> : <Clock size={12} />}
                            <span>{s.is_completed ? "Sección Revisada" : "Pendiente de Revisión"}</span>
                          </button>
                          
                          <button 
                            onClick={() => updateContent(s.id, s.content)}
                            className="flex items-center gap-2 px-5 py-2 bg-blue-600 text-white rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-blue-500 shadow-lg shadow-blue-600/20 transition-all active:scale-95 shrink-0"
                          >
                            <Save size={12} />
                            <span>Guardar</span>
                          </button>
                        </div>

                      </div>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}
</file>

<file path="components/ui/sidebar.tsx">
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import {
  LayoutDashboard,
  FileText,
  Briefcase,
  Users,
  Zap,
  LogOut,
} from "lucide-react";
import { createClient } from "@/lib/supabase/client";
import { cn } from "@/lib/utils";
import * as Avatar from "@radix-ui/react-avatar";
import * as Separator from "@radix-ui/react-separator";
import * as ScrollArea from "@radix-ui/react-scroll-area";

const navItems = [
  { href: "/dashboard", icon: LayoutDashboard, label: "Panel" },
  { href: "/dashboard/projects", icon: FileText, label: "Proyectos" },
  { href: "/dashboard/clients", icon: Users, label: "Clientes" },
  { href: "/dashboard/history", icon: Briefcase, label: "Histórico" },
];

export function AppSidebar() {
  const pathname = usePathname();

  async function handleSignOut() {
    const supabase = createClient();
    await supabase.auth.signOut();
    window.location.href = "/";
  }

  return (
    <aside className="w-64 border-r border-slate-200 bg-white/80 backdrop-blur-md flex flex-col fixed h-screen z-10">
      <div className="p-8 flex items-center gap-3">
        <Link
          href="/dashboard"
          className="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-600/20"
        >
          <Zap size={24} fill="currentColor" />
        </Link>
        <span className="font-black text-2xl tracking-tighter text-slate-900">
          Begitality
        </span>
      </div>

      <ScrollArea.Root className="flex-1 px-4 py-4">
        <ScrollArea.Viewport className="h-full w-full">
          <nav className="space-y-1">
            {navItems.map((item) => {
              const isActive = pathname === item.href;
              return (
                <Link
                  key={item.href}
                  href={item.href}
                  className={cn(
                    "w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl transition-all font-bold text-sm",
                    isActive
                      ? "bg-blue-50 text-blue-600"
                      : "text-slate-400 hover:text-slate-900 hover:bg-slate-50"
                  )}
                >
                  <item.icon size={20} />
                  {item.label}
                </Link>
              );
            })}
          </nav>
        </ScrollArea.Viewport>
        <ScrollArea.Scrollbar orientation="vertical" className="w-1" />
      </ScrollArea.Root>

      <Separator.Root className="shrink-0 bg-slate-200 h-px" />

      <div className="p-6">
        <div className="bg-slate-50 rounded-2xl p-4 border border-slate-100">
          <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
            Tu Plan
          </p>
          <p className="text-sm font-bold text-slate-900">Senior Consultant</p>
          <div className="mt-2 h-1 w-full bg-slate-200 rounded-full overflow-hidden">
            <div className="h-full bg-blue-600 w-3/4 rounded-full" />
          </div>
        </div>
        <button
          onClick={handleSignOut}
          className="mt-4 w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-slate-500 hover:text-red-600 hover:bg-red-50 font-bold text-sm transition-all"
        >
          <LogOut size={18} />
          Cerrar sesión
        </button>
      </div>
    </aside>
  );
}
</file>

<file path="lib/export/pdf.ts">
import { jsPDF } from "jspdf";

interface ViabilityData {
  title: string;
  clientName: string;
  grantName: string;
  status: string;
  summary: string;
  strengths: string[];
  risks: string[];
  recommendations: string[];
  probability: number;
}

interface ReviewData {
  title: string;
  clientName: string;
  score: number;
  summary: string;
  strengths: string[];
  weaknesses: string[];
  improvements: string[];
}

// Helper para escribir texto con salto de página automático
function writeText(doc: jsPDF, text: string, x: number, y: number, width: number, lineHeight: number): number {
  const lines = doc.splitTextToSize(text, width);
  lines.forEach((line: string) => {
    if (y > 275) {
      doc.addPage();
      y = 25;
    }
    doc.text(line, x, y);
    y += lineHeight;
  });
  return y;
}

// --- GENERADOR: CERTIFICADO DE VIABILIDAD ---
export async function generateViabilityCertificate(data: ViabilityData): Promise<ArrayBuffer> {
  const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
  const margin = 25;
  const pageWidth = 210;
  const contentWidth = pageWidth - margin * 2;
  
  doc.setFillColor(248, 250, 252);
  doc.rect(0, 0, pageWidth, 40, "F");
  doc.setTextColor(30, 41, 59);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("CERTIFICADO DE VIABILIDAD TÉCNICA", margin, 25);
  doc.setFontSize(8);
  doc.setTextColor(37, 99, 235);
  doc.text("BEGITALITY ASSIST - AUDITORÍA DE SUBVENCIONES", margin, 32);

  let cursorY = 55;
  doc.setTextColor(148, 163, 184);
  doc.setFontSize(8);
  doc.text("DETALLES DEL EXPEDIENTE", margin, cursorY);
  cursorY += 5;
  doc.setDrawColor(226, 232, 240);
  doc.line(margin, cursorY, pageWidth - margin, cursorY);
  cursorY += 10;

  doc.setTextColor(30, 41, 59);
  doc.setFontSize(10);
  doc.text(`Cliente:`, margin, cursorY); doc.setFont("helvetica", "normal"); doc.text(data.clientName, margin + 25, cursorY); cursorY += 6;
  doc.setFont("helvetica", "bold"); doc.text(`Proyecto:`, margin, cursorY); doc.setFont("helvetica", "normal"); doc.text(data.title, margin + 25, cursorY); cursorY += 6;
  doc.setFont("helvetica", "bold"); doc.text(`Convocatoria:`, margin, cursorY); doc.setFont("helvetica", "normal"); 
  cursorY = writeText(doc, data.grantName, margin + 25, cursorY, contentWidth - 25, 5);
  cursorY += 10;

  const statusColor = data.status === "APTO" ? [16, 185, 129] : data.status === "CONDICIONADO" ? [245, 158, 11] : [239, 68, 68];
  doc.setFillColor(statusColor[0], statusColor[1], statusColor[2]);
  doc.roundedRect(margin, cursorY, 50, 12, 2, 2, "F");
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text(data.status, margin + 25, cursorY + 7.5, { align: "center" });
  doc.setTextColor(30, 41, 59);
  doc.setFontSize(10);
  doc.text(`Probabilidad de Éxito: ${data.probability}%`, margin + 60, cursorY + 7.5);
  cursorY += 25;

  doc.setFontSize(11);
  doc.text("Análisis Ejecutivo", margin, cursorY); cursorY += 7;
  doc.setFont("times", "normal");
  doc.setFontSize(10);
  cursorY = writeText(doc, data.summary, margin, cursorY, contentWidth, 5);
  
  return doc.output("arraybuffer");
}

// --- GENERADOR: REPORTE DE AUDITORÍA DE CALIDAD ---
export async function generateReviewReport(data: ReviewData): Promise<ArrayBuffer> {
  const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
  const margin = 25;
  const pageWidth = 210;
  const contentWidth = pageWidth - margin * 2;

  // PORTADA
  doc.setFillColor(15, 23, 42); 
  doc.rect(0, 0, pageWidth, 297, "F");
  doc.setTextColor(255, 255, 255);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(24);
  doc.text("INFORME DE AUDITORÍA", margin, 80);
  doc.text("DE CALIDAD TÉCNICA", margin, 92);
  doc.setFontSize(12);
  doc.setTextColor(59, 130, 246);
  doc.text(doc.splitTextToSize(data.title.toUpperCase(), contentWidth), margin, 110);
  doc.addPage();

  let cursorY = 25;
  doc.setTextColor(30, 41, 59);
  
  // Score Block
  doc.setFillColor(248, 250, 252);
  doc.roundedRect(margin, cursorY, contentWidth, 35, 4, 4, "F");
  doc.setFontSize(9);
  doc.text("QUALITY PERFORMANCE SCORE", margin + 10, cursorY + 12);
  doc.setFontSize(28);
  doc.setTextColor(data.score >= 80 ? 16 : 220, data.score >= 80 ? 185 : 38, data.score >= 80 ? 129 : 38);
  doc.text(`${data.score}/100`, margin + 10, cursorY + 26);
  cursorY += 50;

  // Summary
  doc.setTextColor(30, 41, 59);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(13);
  doc.text("1. Resumen Ejecutivo", margin, cursorY);
  cursorY += 8;
  doc.setFont("times", "normal");
  doc.setFontSize(10);
  cursorY = writeText(doc, data.summary, margin, cursorY, contentWidth, 5);
  cursorY += 12;

  // Strengths
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("2. Análisis de Fortalezas", margin, cursorY);
  cursorY += 8;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  data.strengths.forEach(s => {
    doc.text("• ", margin, cursorY);
    cursorY = writeText(doc, s, margin + 5, cursorY, contentWidth - 5, 5);
    cursorY += 2;
  });
  cursorY += 10;

  // Weaknesses
  if (cursorY > 250) { doc.addPage(); cursorY = 25; }
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("3. Áreas de Mejora", margin, cursorY);
  cursorY += 8;
  doc.setFont("helvetica", "normal");
  data.weaknesses.forEach(w => {
    doc.text("• ", margin, cursorY);
    cursorY = writeText(doc, w, margin + 5, cursorY, contentWidth - 5, 5);
    cursorY += 2;
  });
  cursorY += 10;

  // Improvements
  if (cursorY > 230) { doc.addPage(); cursorY = 25; }
  doc.setFont("helvetica", "bold");
  doc.text("4. Plan de Acción Recomendado", margin, cursorY);
  cursorY += 8;
  data.improvements.forEach((imp, i) => {
    doc.setFont("helvetica", "bold");
    doc.text(`${i+1}.`, margin, cursorY);
    doc.setFont("helvetica", "normal");
    cursorY = writeText(doc, imp, margin + 8, cursorY, contentWidth - 10, 5);
    cursorY += 3;
  });

  return doc.output("arraybuffer");
}

// --- GENERADOR: MEMORIA TÉCNICA COMPLETA ---
export async function generatePdf(data: any): Promise<ArrayBuffer> {
  const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
  const margin = 20;
  const contentWidth = 210 - margin * 2;
  
  doc.setFillColor(30, 41, 59);
  doc.rect(0, 0, 210, 297, "F");
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(28);
  doc.text(doc.splitTextToSize(data.title.toUpperCase(), contentWidth), margin, 100);
  doc.addPage();
  
  let cursorY = 25;
  doc.setTextColor(0, 0, 0);
  data.sections.forEach((section: any) => {
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    if (cursorY > 260) { doc.addPage(); cursorY = 25; }
    doc.text(doc.splitTextToSize(section.title.toUpperCase(), contentWidth), margin, cursorY);
    cursorY += 10;
    
    doc.setFont("times", "normal");
    doc.setFontSize(11);
    cursorY = writeText(doc, section.content || "(Sin contenido)", margin, cursorY, contentWidth, 6);
    cursorY += 15;
  });

  return doc.output("arraybuffer");
}
</file>

<file path="lib/types.ts">
// Begitality - Tipos compartidos (alineados con esquema Supabase)

export type ProjectStatus = "draft" | "in_progress" | "ready_export" | "exported" | "archived";
export type PlanType = "starter" | "consultant" | "senior_consultant" | "enterprise";

export interface Profile {
  id: string;
  email: string | null;
  full_name: string | null;
  avatar_url: string | null;
  plan: PlanType;
  created_at: string;
  updated_at: string;
}

export interface Client {
  id: string;
  user_id: string;
  name: string;
  tax_id: string | null;
  contact_email: string | null;
  contact_phone: string | null;
  industry: string | null;
  notes: string | null;
  status: "active" | "archived";
  created_at: string;
  updated_at: string;
}

export interface Project {
  id: string;
  user_id: string;
  client_id: string | null;
  name: string;
  grant_name: string;
  grant_type: string | null;
  status: ProjectStatus;
  created_at: string;
  updated_at: string;
  client?: Client;
}

export interface Section {
  id: string;
  project_id: string;
  title: string;
  content: string;
  sort_order: number;
  is_completed: boolean;
  created_at: string;
  updated_at: string;
}

export interface ConvocatoriaBase {
  id: string;
  project_id: string;
  name: string;
  file_path: string | null;
  file_size: number | null;
  created_at: string;
}

export interface ChecklistItem {
  id: string;
  project_id: string;
  label: string;
  required: boolean;
  checked: boolean;
  sort_order: number;
  created_at: string;
}

export interface AIMessage {
  id: string;
  project_id: string;
  role: "user" | "assistant" | "system";
  content: string;
  created_at: string;
}

export type ProjectWithSections = Project & { sections?: Section[] };
</file>

<file path="README.md">
# Begitality

Plataforma inteligente de gestión de subvenciones. Automatiza la redacción de memorias técnicas para convocatorias públicas con IA contextual (sin re-contextualizar en cada proyecto).

## Stack

- **Framework:** Next.js 16.1 (App Router)
- **Lenguaje:** TypeScript
- **Backend/DB:** Supabase (Auth, DB, Storage)
- **UI:** React, Radix UI, TailwindCSS
- **IA:** gemini/Anthropic (Etapa 3)

## Requisitos

- Node.js 20.9+ (LTS)
- Cuenta [Supabase](https://supabase.com)

## Setup

1. **Clonar e instalar**

   ```bash
   npm install
   ```

2. **Variables de entorno**
   - Copiar `.env.example` a `.env.local`
   - En el dashboard de Supabase: Project Settings → API → anotar `Project URL` y `anon public` key
   - Rellenar `NEXT_PUBLIC_SUPABASE_URL` y `NEXT_PUBLIC_SUPABASE_ANON_KEY`

3. **Base de datos**
   - En Supabase: SQL Editor → New query
   - Pegar y ejecutar el contenido de `supabase/migrations/001_initial_schema.sql` (ver `docs/COMPARATIVA-SQL-Y-ESTRUCTURA.md` para comparativa con otros SQLs).
   - Para **cargar PDFs de convocatoria**: ejecutar también `supabase/migrations/003_storage_convocatoria.sql` (crea el bucket y las políticas de Storage). Si el INSERT del bucket falla, crea el bucket desde Dashboard → Storage → New bucket (id: `convocatoria-files`, privado) y vuelve a ejecutar solo las políticas del mismo fichero.

4. **Auth (confirmación de email / OAuth)**
   - En Supabase: Authentication → URL Configuration
   - Añadir en **Redirect URLs**: `http://localhost:3000/auth/callback` (y la URL de producción cuando corresponda).

5. **Arrancar**
   ```bash
   npm run dev
   ```
   Abrir [http://localhost:3000](http://localhost:3000).

## Estructura del proyecto (Etapa 1)

```
app/
  layout.tsx              # Layout raíz + fuentes
  page.tsx                # Landing (sin auth)
  globals.css
  (auth)/
    login/page.tsx
    signup/page.tsx
  auth/callback/route.ts  # Intercambio de code por sesión (email confirm / OAuth)
  dashboard/
    layout.tsx            # Sidebar + área principal
    page.tsx              # Panel con proyectos
    projects/
      page.tsx            # Lista de proyectos
      new/page.tsx        # Crear proyecto
      [id]/page.tsx       # Espacio de trabajo (S2)
      [id]/export/page.tsx
    history/page.tsx
components/
  ui/sidebar.tsx
  export/ExportView.tsx
lib/
  supabase/client.ts
  supabase/server.ts
  types.ts
  utils.ts
supabase/
  migrations/001_initial_schema.sql
middleware.ts             # Auth + protección rutas
```

## Etapas de desarrollo

- **Etapa 1 (S1):** Arquitectura base, Auth Supabase, Dashboard y navegación lateral. ✅
- **Etapa 2 (S2):** Espacio de trabajo por proyecto, “Cargar Bases”, esquema DB completo.
- **Etapa 3 (S3):** Asistente IA, motor de reutilización, checklists dinámicos.
- **Etapa 4 (S4):** Exportación PDF/Word, flujo completo, refinamiento visual.

## Producción (Edge Functions, PDF/DOCX, pgvector)

Ver **[docs/PRODUCCION.md](docs/PRODUCCION.md)** para:

- Configurar **Supabase Edge Functions** (ai-chat, ai-embed) y secrets (Gemini/Anthropic).
- Uso de la **API de exportación** (PDF/DOCX) en `/api/export`.
- Migración **pgvector** y motor de reutilización semántico (`002_pgvector_embeddings.sql`).

## Nota

El archivo `index.tsx` en la raíz es la versión monolítica anterior; la aplicación actual está en la estructura Next.js descrita arriba.
</file>

<file path="app/api/projects/[projectId]/generate-sections/route.ts">
import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { extractTextFromPdf } from "@/lib/pdf-extract";
import { GoogleGenerativeAI, SchemaType } from "@google/generative-ai";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";
const BUCKET = "convocatoria-files";
const MAX_TEXT_LENGTH = 30000;

export async function POST(
  _req: Request,
  context: { params: Promise<{ projectId: string }> }
) {
  const { projectId } = await context.params;
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return NextResponse.json({ error: "No autorizado" }, { status: 401 });

  const { data: project } = await supabase.from("projects").select("id, name, grant_name").eq("id", projectId).single();
  if (!project) return NextResponse.json({ error: "Proyecto no encontrado" }, { status: 404 });

  const { data: bases } = await supabase.from("convocatoria_bases").select("name, file_path").eq("project_id", projectId);
  let grantText = "";
  if (bases) {
    for (const b of bases) {
      try {
        const { data: blob } = await supabase.storage.from(BUCKET).download(b.file_path!);
        if (blob) grantText += await extractTextFromPdf(Buffer.from(await blob.arrayBuffer()));
      } catch (e) {}
    }
  }

  const geminiKey = process.env.GEMINI_API_KEY;
  if (!geminiKey) return NextResponse.json({ error: "IA no configurada" }, { status: 500 });

  try {
    const genAI = new GoogleGenerativeAI(geminiKey);
    const model = genAI.getGenerativeModel({
      model: "gemini-3-flash-preview",
      generationConfig: {
        responseMimeType: "application/json",
        responseSchema: {
          type: SchemaType.ARRAY,
          items: {
            type: SchemaType.OBJECT,
            properties: {
              title: { type: SchemaType.STRING },
              content: { type: SchemaType.STRING },
            },
            required: ["title", "content"],
          },
        },
      },
    }, { apiVersion: "v1beta" });

    const prompt = `Analiza la convocatoria y genera la estructura de la memoria con borradores técnicos densos.
    Proyecto: ${project.name}
    Bases: ${grantText.slice(0, MAX_TEXT_LENGTH)}`;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();
    const sectionsData = JSON.parse(text);

    const { data: existing } = await supabase.from("sections").select("title").eq("project_id", projectId);
    const existingTitles = new Set(existing?.map(s => s.title.toLowerCase()) || []);
    
    const toInsert = sectionsData
      .filter((s: any) => !existingTitles.has(s.title.toLowerCase()))
      .map((s: any, i: number) => ({
        project_id: projectId,
        title: s.title.slice(0, 500),
        content: s.content || "",
        sort_order: i,
        is_completed: false,
      }));

    if (toInsert.length > 0) await supabase.from("sections").insert(toInsert);

    return NextResponse.json({ ok: true });
  } catch (error: any) {
    console.error("Generate Sections Error:", error);
    return NextResponse.json({ error: "Error en IA", message: error.message }, { status: 502 });
  }
}
</file>

<file path="app/dashboard/page.tsx">
import Link from "next/link";
import {
  PlusCircle,
  FileText,
  ChevronRight,
  Wand2,
} from "lucide-react";
import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";

export default async function DashboardPage() {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) redirect("/login");

  const { data: projects } = await supabase
    .from("projects")
    .select("id, name, grant_name, status, updated_at")
    .eq("user_id", user.id)
    .not("status", "in", "(archived,exported)") // Excluimos archivados y finalizados
    .order("updated_at", { ascending: false })
    .limit(10);

  const recentProjects = projects?.slice(0, 2) ?? [];
  const otherProjects = projects?.slice(2) ?? [];

  const readyCount = projects?.filter((p) => p.status === "ready_export").length ?? 0;
  const greeting =
    readyCount > 0
      ? `Tienes ${readyCount} memoria${readyCount > 1 ? "s" : ""} lista${readyCount > 1 ? "s" : ""} para exportar.`
      : "Gestiona tus memorias técnicas desde aquí.";

  return (
    <div className="max-w-5xl mx-auto space-y-12 animate-in fade-in duration-700">
      <header className="flex justify-between items-end">
        <div>
          <h1 className="text-5xl font-black text-slate-900 tracking-tighter">
            Hola, {user.user_metadata?.full_name?.split(" ")[0] ?? "Consultor"}
          </h1>
          <p className="text-slate-500 font-medium mt-2 text-lg">{greeting}</p>
        </div>
        <Link
          href="/dashboard/projects/new"
          className="p-3 bg-white border border-slate-200 rounded-2xl text-slate-400 hover:text-blue-600 transition-all shadow-sm"
          aria-label="Nuevo proyecto"
        >
          <PlusCircle size={24} />
        </Link>
      </header>

      {/* SECCIÓN RECIENTES */}
      <section className="space-y-6">
        <h2 className="text-xs font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-3">
          <span className="w-8 h-px bg-slate-200"></span>
          Últimos Trabajos
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
          {recentProjects.map((project) => (
            <Link
              key={project.id}
              href={
                project.status === "ready_export"
                  ? `/dashboard/projects/${project.id}/export`
                  : `/dashboard/projects/${project.id}`
              }
              className="group relative bg-white border border-slate-200 p-8 rounded-[2.5rem] shadow-sm hover:shadow-2xl hover:shadow-blue-500/10 hover:-translate-y-2 transition-all cursor-pointer overflow-hidden"
            >
              <div className="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-700 opacity-50" />
              <div className="relative">
                <div className="flex justify-between items-start mb-12">
                  <div className="p-4 bg-blue-600 text-white rounded-2xl shadow-lg shadow-blue-600/30 group-hover:rotate-12 transition-transform">
                    <FileText size={32} />
                  </div>
                  {project.status === "ready_export" && (
                    <span className="bg-emerald-100 text-emerald-700 text-[10px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest">
                      Listo para Envío
                    </span>
                  )}
                </div>
                <h3 className="text-3xl font-black text-slate-900 mb-2 leading-tight">
                  {project.name}
                </h3>
                <p className="text-slate-400 font-bold text-sm uppercase tracking-wider mb-6">
                  {project.grant_name}
                </p>
                <div className="flex items-center justify-between">
                  <div className="flex -space-x-2">
                    {[1, 2, 3].map((i) => (
                      <div
                        key={i}
                        className="w-8 h-8 rounded-full border-2 border-white bg-slate-200 flex items-center justify-center text-[10px] font-bold text-slate-500"
                      >
                        AI
                      </div>
                    ))}
                  </div>
                  <div className="flex items-center gap-2 text-blue-600 font-black text-sm">
                    {project.status === "ready_export"
                      ? "Revisar y Exportar"
                      : "Continuar"}
                    <ChevronRight size={16} />
                  </div>
                </div>
              </div>
            </Link>
          ))}

          {recentProjects.length < 2 && (
            <Link
              href="/dashboard/projects/new"
              className="border-2 border-dashed border-slate-200 rounded-[2.5rem] flex flex-col items-center justify-center text-slate-400 group hover:border-blue-400 hover:bg-white transition-all cursor-pointer min-h-[280px]"
            >
              <div className="p-4 bg-slate-50 rounded-full group-hover:bg-blue-50 group-hover:text-blue-600 transition-all">
                <Wand2 size={40} />
              </div>
              <span className="mt-4 font-bold">Crear nueva memoria</span>
            </Link>
          )}
        </div>
      </section>

      {/* RESTO DE PROYECTOS */}
      {otherProjects.length > 0 && (
        <section className="space-y-6 pt-4">
          <h2 className="text-xs font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-3">
            <span className="w-8 h-px bg-slate-200"></span>
            Explorar otros
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {otherProjects.map((project) => (
              <Link
                key={project.id}
                href={`/dashboard/projects/${project.id}`}
                className="bg-white border border-slate-200 p-6 rounded-3xl shadow-sm hover:border-blue-200 transition-all group"
              >
                <div className="p-3 bg-slate-50 rounded-xl w-fit mb-4 group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">
                  <FileText size={20} />
                </div>
                <h4 className="font-bold text-slate-900 truncate mb-1">
                  {project.name}
                </h4>
                <p className="text-xs text-slate-400 font-bold uppercase truncate">
                  {project.grant_name}
                </p>
                <div className="mt-4 flex justify-between items-center">
                   <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest">
                    {new Date(project.updated_at).toLocaleDateString()}
                  </span>
                  <ChevronRight size={14} className="text-slate-300 group-hover:text-blue-500" />
                </div>
              </Link>
            ))}
          </div>
        </section>
      )}
    </div>
  );
}
</file>

<file path="app/dashboard/projects/[id]/page.tsx">
import Link from "next/link";
import { notFound } from "next/navigation";
import { ArrowLeft, Building2, User, Mail, Phone, ExternalLink, RefreshCw, Archive, RotateCcw, UserPlus } from "lucide-react";
import { createClient } from "@/lib/supabase/server";
import { CargarBasesConvocatoria } from "@/components/project/CargarBasesConvocatoria";
import { SeccionesMemoria } from "@/components/project/SeccionesMemoria";
import { AnalisisViabilidadIA } from "@/components/project/AnalisisViabilidadIA";
import { MasterChatIA } from "@/components/project/MasterChatIA";
import { ClientSelector } from "@/components/project/ClientSelector";
import { ProjectReview } from "@/components/project/ProjectReview";
import { cn } from "@/lib/utils";
import { revalidatePath } from "next/cache";

export default async function ProjectWorkspacePage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) notFound();

  // Cargar proyecto con cliente
  const { data: project } = await supabase
    .from("projects")
    .select("*, clients(*)")
    .eq("id", id)
    .eq("user_id", user.id)
    .single();

  if (!project) notFound();

  const isArchived = project.status === 'archived';

  // "Touch" al proyecto para que aparezca en Recientes SOLO si no está archivado ni exportado
  if (project.status !== 'archived' && project.status !== 'exported') {
    await supabase
      .from("projects")
      .update({ updated_at: new Date().toISOString() })
      .eq("id", id)
      .eq("user_id", user.id);
  }

  const { data: sections } = await supabase
    .from("sections")
    .select("id, title, content, is_completed, sort_order")
    .eq("project_id", id)
    .order("sort_order");

  const { data: convocatoriaFiles } = await supabase
    .from("convocatoria_bases")
    .select("id, name, file_path, file_size, created_at")
    .eq("project_id", id)
    .order("created_at", { ascending: false });

  // Solo mostrar clientes activos para asignación
  const { data: clients } = await supabase
    .from("clients")
    .select("id, name")
    .eq("user_id", user.id)
    .eq("status", "active")
    .order("name");

  const client = project.clients;

  return (
    <div className="max-w-5xl mx-auto space-y-8 animate-in fade-in duration-500 pb-20">
      <header className="flex justify-between items-center">
        <div className="flex items-center gap-4">
          <Link
            href="/dashboard"
            className="p-2 hover:bg-white rounded-full border border-slate-200 transition-all"
          >
            <ArrowLeft size={20} />
          </Link>
          <div>
            <div className="flex items-center gap-3">
              <h1 className="text-2xl font-black text-slate-900 tracking-tighter">{project.name}</h1>
              {isArchived && (
                <span className="bg-amber-100 text-amber-700 text-[10px] font-black px-2 py-0.5 rounded-full uppercase tracking-widest">
                  Archivado
                </span>
              )}
            </div>
            <div className="flex items-center gap-2">
              <p className="text-slate-500 text-sm font-medium">{project.grant_name}</p>
              {client && (
                <span className="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-black uppercase tracking-widest">
                  {client.name}
                </span>
              )}
            </div>
          </div>
        </div>

        <form action={async () => {
          "use server";
          const sb = await createClient();
          const nextStatus = isArchived ? 'draft' : 'archived';
          await sb.from("projects").update({ status: nextStatus }).eq("id", id);
          revalidatePath(`/dashboard/projects/${id}`);
          revalidatePath("/dashboard");
        }}>
          <button 
            type="submit"
            className={cn(
              "flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-xs transition-all border shadow-sm",
              isArchived 
                ? "bg-blue-50 border-blue-100 text-blue-600 hover:bg-blue-100" 
                : "bg-white border-slate-200 text-slate-400 hover:text-amber-600 hover:border-amber-100"
            )}
          >
            {isArchived ? <RotateCcw size={16} /> : <Archive size={16} />}
            {isArchived ? "Restaurar Proyecto" : "Archivar Proyecto"}
          </button>
        </form>
      </header>

      {/* Grid Principal con Sticky Sidebar */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start relative">
        {/* Columna Izquierda: Workspace */}
        <div className="lg:col-span-2 space-y-6 min-w-0">
          <CargarBasesConvocatoria
            projectId={id}
            files={convocatoriaFiles ?? []}
          />

          <SeccionesMemoria
            projectId={id}
            sections={sections ?? []}
            hasConvocatoriaFiles={(convocatoriaFiles?.length ?? 0) > 0}
          />
        </div>
        
        {/* Columna Derecha: Inteligencia y Gestión (Fija) */}
        <div className="lg:col-span-1">
          <div className="space-y-6 lg:sticky lg:top-8">
            {/* Tarjeta de Gestión de Cliente Premium */}
            <div className="bg-white border border-slate-200 rounded-[2.5rem] p-8 shadow-sm relative group">
              <div className="absolute inset-0 rounded-[2.5rem] overflow-hidden pointer-events-none">
                <div className="absolute -right-8 -bottom-8 opacity-[0.02] group-hover:scale-110 transition-transform duration-1000">
                  <User size={280} />
                </div>
              </div>

              <div className="flex items-center justify-between mb-8 relative z-10">
                <h3 className="font-black text-slate-900 flex items-center gap-2.5 text-[10px] uppercase tracking-[0.25em]">
                  <div className="w-2 h-2 bg-blue-600 rounded-full shadow-[0_0_10px_rgba(37,99,235,0.5)]" />
                  Cliente
                </h3>
                {client && (
                  <Link 
                    href={`/dashboard/clients/${client.id}`}
                    className="px-4 py-2 bg-blue-50 text-blue-600 rounded-xl text-[9px] font-black uppercase tracking-widest hover:bg-blue-600 hover:text-white transition-all shadow-sm flex items-center gap-2 group/btn"
                  >
                    Ficha completa 
                    <ExternalLink size={12} className="group-hover/btn:translate-x-0.5 group-hover/btn:-translate-y-0.5 transition-transform" />
                  </Link>
                )}
              </div>

              {client ? (
                <div className="space-y-6 relative z-10">
                  <div className="p-6 bg-slate-50/50 rounded-3xl border border-slate-100 shadow-inner">
                    <p className="font-black text-slate-900 text-2xl tracking-tighter leading-none mb-2">{client.name}</p>
                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">{client.tax_id || "ID PENDIENTE"}</p>
                  </div>

                  <div className="flex flex-wrap gap-2 pt-2">
                    {client.contact_email && (
                      <div className="flex items-center gap-2 text-[10px] text-slate-500 font-bold bg-white border border-slate-100 px-3 py-1.5 rounded-full shadow-sm">
                        <Mail size={12} className="text-blue-400" />
                        {client.contact_email}
                      </div>
                    )}
                    {client.contact_phone && (
                      <div className="flex items-center gap-2 text-[10px] text-slate-500 font-bold bg-white border border-slate-100 px-3 py-1.5 rounded-full shadow-sm">
                        <Phone size={12} className="text-blue-400" />
                        {client.contact_phone}
                      </div>
                    )}
                  </div>
                </div>
              ) : (
                <div className="py-6 relative z-10 text-center text-slate-400">
                  <p className="text-[10px] font-black uppercase tracking-widest leading-relaxed">
                    Expediente sin asignar.
                  </p>
                </div>
              )}

              <div className="mt-8 relative z-20">
                <ClientSelector 
                  projectId={id}
                  initialClient={client}
                  availableClients={clients || []}
                />
              </div>
            </div>

            {/* Análisis de Elegibilidad IA */}
            <AnalisisViabilidadIA 
              projectId={id} 
              hasClient={!!client} 
              initialReport={project.viability_report}
            />

            {/* Auditoría de Calidad */}
            <ProjectReview 
              projectId={id}
              initialReport={project.review_report}
              hasContent={(sections?.length ?? 0) > 0 && sections!.some((s) => s.content && s.content.length > 50)}
            />

            {/* MASTER CHAT IA */}
            <MasterChatIA 
              projectId={id}
            />
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="package.json">
{
  "name": "begitality",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "@radix-ui/react-avatar": "^1.1.1",
    "@radix-ui/react-dialog": "^1.1.2",
    "@radix-ui/react-dropdown-menu": "^2.1.2",
    "@radix-ui/react-label": "^2.1.0",
    "@radix-ui/react-progress": "^1.1.0",
    "@radix-ui/react-scroll-area": "^1.2.0",
    "@radix-ui/react-separator": "^1.1.0",
    "@radix-ui/react-slot": "^1.1.0",
    "@radix-ui/react-tabs": "^1.1.1",
    "@radix-ui/react-toast": "^1.2.2",
    "@radix-ui/react-tooltip": "^1.1.3",
    "@supabase/ssr": "^0.5.2",
    "@supabase/supabase-js": "^2.47.10",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.1",
    "docx": "^9.5.0",
    "jspdf": "^4.1.0",
    "lucide-react": "^0.460.0",
    "next": "^16.1.0",
    "pdf-lib": "^1.17.1",
    "pdf-parse": "^1.1.1",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "tailwind-merge": "^2.5.4"
  },
  "devDependencies": {
    "@types/node": "^22.10.1",
    "@types/react": "^19.0.1",
    "@types/react-dom": "^19.0.2",
    "autoprefixer": "^10.4.20",
    "eslint": "^4.1.1",
    "eslint-config-next": "^0.2.4",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.15",
    "typescript": "^5.7.2"
  }
}
</file>

</files>
